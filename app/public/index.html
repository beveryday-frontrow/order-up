<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Up!</title>
  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface-hover: #27272a;
      --border: #27272a;
      --text: #fafafa;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #eab308;
      --initiative: #a78bfa;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --space: 1.5rem;
    }
    * { box-sizing: border-box; }
    .drag-bar {
      -webkit-app-region: drag;
      height: 32px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10000;
      /* Leave space for macOS traffic lights */
      padding-left: 78px;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding-top: 32px;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space) 24px 48px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: var(--space);
      padding-bottom: var(--space);
      border-bottom: 1px solid var(--border);
    }
    /* Ensure interactive elements in the header area are clickable over the drag bar */
    .header a, .header button, .header input, .header select,
    .initiative-card, .initiative-icon-edit, .initiative-icon-terminal {
      -webkit-app-region: no-drag;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo-link {
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: transform 0.15s, filter 0.15s;
    }
    .logo-link:hover {
      transform: scale(1.02);
      filter: brightness(1.1);
    }
    .logo-img {
      height: 160px;
      width: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .meta {
      color: var(--text-dim);
      font-size: 0.8125rem;
    }
    
    /* Game Stats - 1980s Arcade Style (in header) */
    .game-stats {
      display: flex;
      align-items: stretch;
      gap: 0;
      padding: 0.5rem 0.75rem;
      background: #000;
      border: 3px solid #222;
      border-radius: 4px;
      font-family: 'Press Start 2P', 'Courier New', monospace;
      box-shadow: 
        0 0 0 1px #444,
        0 0 15px rgba(0,0,0,0.6),
        inset 0 0 30px rgba(0,0,0,0.4);
      position: relative;
      overflow: hidden;
    }
    /* CRT scanline effect */
    .game-stats::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(0deg, rgba(0,0,0,0.12) 0px, rgba(0,0,0,0.12) 1px, transparent 1px, transparent 2px);
      pointer-events: none;
      z-index: 10;
    }
    .game-stats__scores {
      display: flex;
      gap: 1.25rem;
      padding-right: 1rem;
      border-right: 1px solid #333;
    }
    .game-stats__player,
    .game-stats__high {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
    }
    .game-stats__player-label {
      font-size: 0.5rem;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
      animation: blink1up 1s steps(1) infinite;
    }
    @keyframes blink1up {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .game-stats__player-score {
      font-size: 0.75rem;
      color: #ffffff;
      text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #fff;
      letter-spacing: 2px;
    }
    .game-stats__high-label {
      font-size: 0.4rem;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
    }
    .game-stats__high-value {
      font-size: 0.75rem;
      color: #ffffff;
      text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #fff;
      letter-spacing: 2px;
    }
    /* Stat counters */
    .game-stats__counters {
      display: flex;
      gap: 0.75rem;
      padding: 0 1rem;
      align-items: center;
    }
    .game-stats__counter {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
    }
    .game-stats__counter-label {
      font-size: 0.3rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .game-stats__counter-value {
      font-size: 0.6rem;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 20px currentColor;
    }
    .game-stats__value--served { color: #00ff00; }
    .game-stats__value--bugs { color: #ff0040; }
    .game-stats__value--comments { color: #00d4ff; }
    .game-stats__value--conflicts { color: #ffcc00; }
    .game-stats__value--reviews { color: #ff00ff; }
    .game-stats__value--game { color: #ff8800; }
    .game-stats__reset {
      background: #111;
      border: 1px solid #333;
      color: #555;
      font-size: 0.35rem;
      font-family: inherit;
      padding: 0.3rem 0.5rem;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.15s;
      align-self: center;
      margin-left: 0.5rem;
    }
    .game-stats__reset:hover {
      background: #200;
      border-color: #ff0040;
      color: #ff0040;
      text-shadow: 0 0 8px #ff0040;
    }
    /* Animations */
    .game-stats__player-score.bump {
      animation: statBump 0.3s ease-out, glowPulse 0.3s ease-out;
    }
    .game-stats__high-value.bump {
      animation: highScoreBump 0.5s ease-out;
    }
    .game-stats__counter-value.bump {
      animation: statBump 0.3s ease-out, glowPulse 0.3s ease-out;
    }
    @keyframes statBump {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    @keyframes glowPulse {
      0% { filter: brightness(1); }
      50% { filter: brightness(2); }
      100% { filter: brightness(1); }
    }
    @keyframes highScoreBump {
      0% { transform: scale(1); color: #ffffff; }
      25% { transform: scale(1.3); color: #ffff00; text-shadow: 0 0 15px #ffff00, 0 0 30px #ffff00; }
      50% { transform: scale(1.2); color: #ff0000; }
      75% { transform: scale(1.25); color: #00ff00; }
      100% { transform: scale(1); color: #ffffff; }
    }
    @media (max-width: 1100px) {
      .game-stats {
        padding: 0.4rem 0.5rem;
      }
      .game-stats__scores { gap: 0.75rem; padding-right: 0.75rem; }
      .game-stats__player-label, .game-stats__high-label { font-size: 0.35rem; }
      .game-stats__player-score, .game-stats__high-value { font-size: 0.6rem; }
      .game-stats__counters { gap: 0.5rem; padding: 0 0.5rem; }
      .game-stats__counter-label { font-size: 0.25rem; }
      .game-stats__counter-value { font-size: 0.5rem; }
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      font-family: inherit;
      transition: background 0.15s, border-color 0.15s;
    }
    .btn:hover:not(:disabled) {
      background: var(--surface-hover);
      border-color: var(--text-dim);
    }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }
    /* Tool selector */
    .tool-selector {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .tool-selector select {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.35rem 0.5rem;
      font-size: 0.75rem;
      font-family: inherit;
      cursor: pointer;
      -webkit-app-region: no-drag;
    }
    .tool-selector select:hover {
      border-color: var(--accent);
    }
    .tool-selector select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
    }
    .tool-selector-label {
      color: var(--text-dim);
      font-size: 0.7rem;
      white-space: nowrap;
    }
    /* Prompt modal for clipboard-based tools */
    .prompt-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .prompt-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
    }
    .prompt-modal h3 {
      margin: 0 0 0.75rem;
      font-size: 1rem;
    }
    .prompt-modal pre {
      background: var(--bg);
      padding: 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text-muted);
      margin: 0 0 1rem;
    }
    .prompt-modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .card-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text);
    }
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    thead { position: relative; z-index: 10; }
    th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      text-align: center;
      overflow: visible;
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    /* Column widths for Orders on the Grill table */
    th:first-child, td:first-child { width: 110px; max-width: 130px; text-align: left; }
    th:nth-child(2) { text-align: left; }
    th:nth-child(2), td:nth-child(2) { width: 45%; min-width: 300px; }
    tbody tr {
      transition: background 0.1s;
    }
    tbody tr:hover {
      background: rgba(39, 39, 42, 0.5);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    td {
      color: var(--text);
      vertical-align: middle;
    }
    a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
    }
    a:hover {
      text-decoration: underline;
    }
    .init {
      font-weight: 600;
      color: var(--initiative);
    }
    .init:hover {
      text-decoration: underline;
    }
    .check-cell {
      text-align: center;
      width: 1%;
      white-space: nowrap;
    }
    .check-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 700;
      background: transparent;
    }
    .check-icon svg {
      width: 18px;
      height: 18px;
    }
    .check-icon.pass { color: var(--success); }
    .check-icon.fail { color: var(--danger); }
    .check-icon.fail.fix-check { cursor: pointer; text-decoration: none; }
    .check-icon.fail.fix-check:hover { filter: brightness(1.15); }
    .check-icon.pending { color: var(--warning); }
    .check-icon.none {
      background: transparent;
      color: var(--text-dim);
      font-size: 0.75rem;
      font-weight: 400;
    }
    /* Mario coin bounce animation for live updates */
    @keyframes coin-bounce {
      0% { transform: translateY(0) scale(1); }
      15% { transform: translateY(-12px) scale(1.15); }
      30% { transform: translateY(-20px) scale(1.2); }
      45% { transform: translateY(-12px) scale(1.15); }
      60% { transform: translateY(0) scale(1); }
      75% { transform: translateY(-6px) scale(1.05); }
      90% { transform: translateY(0) scale(1); }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes coin-sparkle {
      0%, 100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
      25% { box-shadow: 0 0 12px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.4); }
      50% { box-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 16px rgba(255, 215, 0, 0.3); }
      75% { box-shadow: 0 0 4px rgba(255, 215, 0, 0.4); }
    }
    .coin-bounce {
      animation: coin-bounce 0.5s ease-out, coin-sparkle 0.5s ease-out;
    }
    /* Unresolved comments bounce with red tint */
    .coin-bounce-comments {
      animation: coin-bounce 0.5s ease-out;
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
    }
    .comments-unresolved {
      color: var(--warning);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .comments-unresolved svg {
      width: 14px;
      height: 14px;
    }
    .th-short {
      display: none;
    }
    .th-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: help;
      position: relative;
    }
    .th-icon svg {
      width: 16px;
      height: 16px;
    }
    .th-icon::after {
      content: attr(title);
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: #f3f4f6;
      font-size: 0.65rem;
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 1000;
    }
    .th-icon::before {
      content: '';
      position: absolute;
      top: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-bottom-color: #1f2937;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 1000;
    }
    .th-icon:hover::after,
    .th-icon:hover::before {
      opacity: 1;
    }
    .checks-header-icons {
      display: flex;
      align-items: center;
      justify-content: space-around;
      gap: 0.5rem;
    }
    .comments-link { color: inherit; text-decoration: none; }
    .comments-link:hover { text-decoration: underline; }
    .conflicts-banner {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: rgba(24, 24, 27, 0.92);
      backdrop-filter: blur(2px);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      z-index: 5;
    }
    .conflicts-banner__text {
      color: var(--danger);
      font-size: 0.75rem;
      font-weight: 500;
    }
    .conflicts-banner__btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 0.35rem 0.65rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      font-family: inherit;
      transition: background 0.15s, transform 0.1s;
    }
    .conflicts-banner__btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    .conflicts-banner__btn:active {
      transform: translateY(0);
    }
    .checks-cell {
      padding: 0.5rem 0.75rem;
    }
    .checks-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-around;
      gap: 1rem;
      min-width: 280px;
    }
    .check-icon-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
    }
    tr[data-has-conflicts="true"] .check-icon-wrap {
      opacity: 0.25;
    }
    tr[data-has-conflicts="true"] .conflicts-banner {
      opacity: 1;
    }
    .checks-header {
      text-align: center;
    }
    .preview-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: center;
    }
    .preview-link {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      text-decoration: none;
      background: var(--surface-hover);
      color: var(--text);
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    .preview-link:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .preview-link:hover .preview-deploy-dot {
      border-color: rgba(255,255,255,0.5);
    }

    /* Preview deploy status dots */
    .preview-deploy-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
      position: relative;
      top: -0.5px;
    }
    .preview-deploy-dot--deployed {
      background: #22c55e;
      box-shadow: 0 0 4px rgba(34, 197, 94, 0.5);
    }
    .preview-deploy-dot--building {
      background: #eab308;
      box-shadow: 0 0 4px rgba(234, 179, 8, 0.4);
      animation: deploy-pulse 1.5s ease-in-out infinite;
    }
    .preview-deploy-dot--pending {
      background: #a3a3a3;
      box-shadow: 0 0 4px rgba(163, 163, 163, 0.3);
      animation: deploy-pulse 2s ease-in-out infinite;
    }
    .preview-deploy-dot--failed {
      background: #ef4444;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }
    @keyframes deploy-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    /* Tint the preview link border based on deploy state */
    .preview-link--deployed {
      border-color: rgba(34, 197, 94, 0.4);
    }
    .preview-link--building {
      border-color: rgba(234, 179, 8, 0.4);
    }
    .preview-link--failed {
      border-color: rgba(239, 68, 68, 0.4);
    }
    .preview-link--pending {
      border-color: rgba(163, 163, 163, 0.3);
    }

    td code {
      font-size: 0.8125rem;
      background: var(--surface-hover);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      color: var(--text);
    }
    .initiative-group-header td { background: var(--surface-hover); color: var(--text-muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; padding: 0.5rem 1rem; border-bottom: 1px solid var(--border); }
    .initiative-group-header td > div { display: flex; align-items: center; gap: 1rem; }
    .initiative-focus-input {
      flex: 0 1 auto;
      width: 350px;
      padding: 0.35rem 0.5rem;
      background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(255,193,7,0.1) 100%);
      border: none;
      border-left: 3px solid var(--warning);
      border-radius: 4px;
      color: #ffd54f;
      font-size: 1rem;
      font-weight: 600;
      font-style: italic;
      text-transform: none;
      letter-spacing: 0.02em;
      text-shadow: 0 0 10px rgba(255,213,79,0.3);
    }
    .initiative-focus-input::placeholder {
      color: var(--text-dim);
      opacity: 0.4;
      font-weight: 400;
      font-style: italic;
      text-shadow: none;
    }
    .initiative-focus-input:hover {
      background: linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,193,7,0.15) 100%);
      text-shadow: 0 0 15px rgba(255,213,79,0.5);
    }
    .initiative-focus-input:focus {
      outline: none;
      background: linear-gradient(135deg, rgba(255,107,107,0.2) 0%, rgba(255,193,7,0.2) 100%);
      color: #ffeb3b;
      text-shadow: 0 0 20px rgba(255,235,59,0.6);
      border-left-color: #ff6b6b;
    }
    .initiative-with-icon { display: inline-flex; align-items: center; gap: 0.375rem; }
    .initiative-icon { width: 44px; height: 44px; object-fit: contain; vertical-align: middle; border-radius: 8px; flex-shrink: 0; }
    .pr-cell { display: inline-flex; align-items: center; white-space: nowrap; gap: 0.25rem; }
    /* Action buttons - icon only with gradient backgrounds */
    .actions-cell { display: flex; align-items: center; gap: 0.35rem; overflow: visible; }
    .row-refresh, .fork-btn, .custom-cmd-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .row-refresh svg, .fork-btn svg, .custom-cmd-btn svg { width: 16px; height: 16px; }
    .custom-cmd-btn {
      position: relative;
      overflow: visible;
    }
    .custom-cmd-btn:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      color: #fff;
      border-color: #f59e0b;
    }
    .agent-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--surface);
      pointer-events: none;
    }
    .agent-badge--pending { background: #6b7280; }
    .agent-badge--running { background: #3b82f6; animation: agentPulse 1.2s ease-in-out infinite; }
    .agent-badge--complete { background: #10b981; }
    .agent-badge--failed { background: #ef4444; }
    @keyframes agentPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.3); }
    }
    .row-refresh:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      color: #fff;
      border-color: #3b82f6;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
    }
    .row-refresh:disabled { opacity: 0.5; cursor: not-allowed; }
    .fork-btn:hover {
      background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
      color: #fff;
      border-color: #a855f7;
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
    }
    .row-merge-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.35rem; vertical-align: middle; }
    .row-merge-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .repo-cell { display: block; }
    .branch-name {
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .branch-name:hover {
      background: var(--accent);
      color: #fff;
    }
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast svg {
      width: 16px;
      height: 16px;
      color: var(--success);
    }
    .platform-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.35rem;
      vertical-align: middle;
    }
    .platform-icon svg {
      width: 16px;
      height: 16px;
    }
    .title-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pr-title { color: var(--text-muted); font-size: 0.8rem; display: inline-block; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .loading, .error { padding: 1.25rem; color: var(--text-muted); }
    /* Platformer loading stage (Burger Time style) */
    .loading-card { overflow: visible; }
    .loading-stage {
      padding: 1rem 0 0;
      overflow: visible;
      height: 160px;
      position: relative;
      background: linear-gradient(180deg, var(--surface-hover) 0%, var(--surface) 70%, #2d2419 100%);
    }
    .loading-stage__title {
      color: var(--text-muted);
      font-size: 0.875rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .loading-stage__score {
      position: absolute;
      top: 8px;
      right: 12px;
      font-family: 'Press Start 2P', 'Courier New', monospace;
      font-size: 0.5rem;
      color: #ffcc00;
      text-shadow: 0 0 5px #ffcc00, 0 0 10px #ffcc00;
      letter-spacing: 1px;
      z-index: 10;
    }
    .loading-stage__hint {
      position: absolute;
      bottom: 32px;
      right: 12px;
      color: var(--text-dim);
      font-size: 0.6875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }
    .loading-stage__hint kbd {
      display: inline-block;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 0.1rem 0.35rem;
      font-family: inherit;
      font-size: 0.625rem;
      margin-right: 0.25rem;
    }
    .loading-stage__ground {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 24px;
      background: repeating-linear-gradient(90deg, #3d3225 0px, #3d3225 16px, #4a3d2e 16px, #4a3d2e 32px);
      border-top: 3px solid #5c4d3a;
    }
    .loading-stage__chef {
      position: absolute;
      left: 14%;
      bottom: 24px;
      width: 56px;
      height: 64px;
      background: url(/images/sprite-running.png) no-repeat 0 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      filter: none;
      z-index: 2;
      transform: scaleX(-1);
    }
    /* Grilling chef sprite animation for agent-active rows */
    /* 945x1024 sheet, 6 cols x 6 rows = 36 frames */
    /* Frame: 157.5x170.67 -> display at 40x43px, sheet scaled to 240x246px */
    .chef-grilling {
      display: inline-block;
      width: 40px;
      height: 43px;
      background: url(/images/sprite-grilling.png) no-repeat;
      background-size: 240px 246px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      vertical-align: middle;
      animation: chef-grill-anim 2.4s steps(1) infinite;
    }
    @keyframes chef-grill-anim {
      /* 36 frames at ~15fps = 2.4s. Row height = 41px at display scale */
      0%       { background-position: 0 0; }
      2.778%   { background-position: -40px 0; }
      5.556%   { background-position: -80px 0; }
      8.333%   { background-position: -120px 0; }
      11.111%  { background-position: -160px 0; }
      13.889%  { background-position: -200px 0; }
      16.667%  { background-position: 0 -41px; }
      19.444%  { background-position: -40px -41px; }
      22.222%  { background-position: -80px -41px; }
      25.000%  { background-position: -120px -41px; }
      27.778%  { background-position: -160px -41px; }
      30.556%  { background-position: -200px -41px; }
      33.333%  { background-position: 0 -82px; }
      36.111%  { background-position: -40px -82px; }
      38.889%  { background-position: -80px -82px; }
      41.667%  { background-position: -120px -82px; }
      44.444%  { background-position: -160px -82px; }
      47.222%  { background-position: -200px -82px; }
      50.000%  { background-position: 0 -123px; }
      52.778%  { background-position: -40px -123px; }
      55.556%  { background-position: -80px -123px; }
      58.333%  { background-position: -120px -123px; }
      61.111%  { background-position: -160px -123px; }
      63.889%  { background-position: -200px -123px; }
      66.667%  { background-position: 0 -164px; }
      69.444%  { background-position: -40px -164px; }
      72.222%  { background-position: -80px -164px; }
      75.000%  { background-position: -120px -164px; }
      77.778%  { background-position: -160px -164px; }
      80.556%  { background-position: -200px -164px; }
      83.333%  { background-position: 0 -205px; }
      86.111%  { background-position: -40px -205px; }
      88.889%  { background-position: -80px -205px; }
      91.667%  { background-position: -120px -205px; }
      94.444%  { background-position: -160px -205px; }
      97.222%  { background-position: -200px -205px; }
    }
    .loading-stage__chef--hit {
      filter: brightness(1.4) sepia(0.3);
    }
    .loading-stage__chef--dead {
      transition: opacity 0.08s ease-out;
    }
    .loading-stage__food-track {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 36px;
      height: 48px;
      pointer-events: none;
      z-index: 1;
    }
    .loading-stage__food {
      position: absolute;
      width: 40px;
      height: 40px;
      object-fit: contain;
      bottom: 0;
      left: 100%;
      animation: food-scroll 5s linear infinite;
      image-rendering: auto;
    }
    /* Animation delays are set dynamically via inline styles */
    @keyframes food-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-120vw); }
    }
    /* Chef animation strip – each sprite 1248×832; custom frame count and viewport */
    .chef-animations {
      display: none; /* hidden for now */
      flex-wrap: wrap;
      flex-wrap: wrap;
      gap: 1.25rem;
      padding: 1rem 0;
      margin-bottom: var(--space);
      border-bottom: 1px solid var(--border);
    }
    .chef-animations__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    .chef-animations__title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    .chef-animations__item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
    }
    .chef-animations__item .chef-anim-wrap {
      cursor: pointer;
      outline: none;
    }
    .chef-animations__item--focused .chef-anim-wrap {
      box-shadow: 0 0 0 2px var(--accent);
    }
    .chef-animations__label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .chef-anim-wrap {
      overflow: hidden;
      border-radius: var(--radius-sm);
      background-color: var(--surface-hover);
      background-repeat: no-repeat;
      flex-shrink: 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      transition: none;
      --frame-width: 50px;
      --frame-index: 0;
      --x-offset: 0px;
      --y-offset: -12px;
      --x-0: 0px; --y-0: -12px; --x-1: 0px; --y-1: -12px; --x-2: 0px; --y-2: -12px; --x-3: 0px; --y-3: -12px;
    }
    .chef-animations--tweak .chef-anim-wrap--4,
    .chef-animations--tweak .chef-anim-wrap--2,
    .chef-animations--tweak .chef-anim-wrap--2-3,
    .chef-animations--tweak .chef-anim-wrap--static,
    .chef-animations__item--focused .chef-anim-wrap--4,
    .chef-animations__item--focused .chef-anim-wrap--2,
    .chef-animations__item--focused .chef-anim-wrap--2-3,
    .chef-animations__item--focused .chef-anim-wrap--static {
      background-position: calc(-1 * var(--frame-index) * var(--frame-width) + var(--x-offset)) var(--y-offset);
    }
    .chef-animations--tweak .chef-anim-wrap--1,
    .chef-animations__item--focused .chef-anim-wrap--1 {
      background-position: var(--x-offset) var(--y-offset);
    }
    /* 1248×832 at scale 0.16 = 200×133; zoomed in so character fills more of box */
    .chef-anim-wrap--4 {
      width: 50px;
      height: 77px;
      background-size: 200px 133px;
      background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0);
      animation: chef-bg-4 1.2s steps(4) infinite;
    }
    .chef-animations--tweak .chef-anim-wrap--4,
    .chef-animations__item--focused .chef-anim-wrap--4 { animation: none; }
    @keyframes chef-bg-4 {
      0% { background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0); }
      25% { background-position: calc(-1 * var(--frame-width) + var(--x-1)) var(--y-1); }
      50% { background-position: calc(-2 * var(--frame-width) + var(--x-2)) var(--y-2); }
      75% { background-position: calc(-3 * var(--frame-width) + var(--x-3)) var(--y-3); }
      100% { background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0); }
    }
    .chef-anim-wrap--2 {
      width: 100px;
      height: 77px;
      background-size: 200px 133px;
      --frame-width: 100px;
      background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0);
      animation: chef-bg-2 0.8s steps(2) infinite;
    }
    .chef-animations--tweak .chef-anim-wrap--2,
    .chef-animations__item--focused .chef-anim-wrap--2 { animation: none; }
    @keyframes chef-bg-2 {
      0% { background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0); }
      100% { background-position: calc(-1 * var(--frame-width) + var(--x-1)) var(--y-1); }
    }
    /* 2-frame from 3-frame strip (67px per frame) */
    .chef-anim-wrap--2-3 {
      width: 67px;
      height: 77px;
      background-size: 200px 133px;
      --frame-width: 67px;
      background-position: calc(0 * var(--frame-width) + var(--x-0)) var(--y-0);
      animation: chef-bg-2 0.8s steps(2) infinite;
    }
    .chef-animations--tweak .chef-anim-wrap--2-3,
    .chef-animations__item--focused .chef-anim-wrap--2-3 { animation: none; }
    /* Single frame from a strip (e.g. frame 2 of 3) */
    .chef-anim-wrap--static {
      width: 67px;
      height: 77px;
      background-size: 200px 133px;
      --frame-width: 67px;
      --frame-index: 2;
      background-position: calc(-1 * var(--frame-index) * var(--frame-width) + var(--x-offset)) var(--y-offset);
    }
    /* 3-frame horizontal strip (flamethrower 1159×1156, 3 cols; scale 0.33 = 382×381, frame width 127px); wider */
    .chef-anim-wrap--3v {
      width: 127px;
      height: 120px;
      background-size: 382px 381px;
      --frame-index: 0;
      --frame-width: 127px;
      background-position: var(--x-offset) var(--y-offset);
      animation: chef-bg-3h 1s steps(3) infinite;
    }
    .chef-animations--tweak .chef-anim-wrap--3v,
    .chef-animations__item--focused .chef-anim-wrap--3v { animation: none; }
    .chef-animations--tweak .chef-anim-wrap--3v,
    .chef-animations__item--focused .chef-anim-wrap--3v {
      background-position: calc(-1 * var(--frame-index) * var(--frame-width) + var(--x-offset)) var(--y-offset);
    }
    @keyframes chef-bg-3h {
      0% { background-position: var(--x-offset) var(--y-offset); }
      33.33% { background-position: calc(-127px + var(--x-offset)) var(--y-offset); }
      66.66% { background-position: calc(-254px + var(--x-offset)) var(--y-offset); }
      100% { background-position: var(--x-offset) var(--y-offset); }
    }
    .chef-anim-wrap--1 {
      width: 200px;
      height: 77px;
      background-size: 200px 133px;
      background-position: var(--x-offset) var(--y-offset);
    }
    /* Tweak controls */
    .chef-anim-tweak {
      display: none;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.35rem;
      font-size: 0.6875rem;
      color: var(--text-muted);
    }
    .chef-animations--tweak .chef-anim-tweak,
    .chef-animations__item--focused .chef-anim-tweak { display: flex; }
    .chef-anim-tweak label { display: flex; align-items: center; gap: 0.25rem; }
    .chef-anim-tweak input[type="number"] { width: 3.5rem; padding: 0.2rem 0.35rem; font-size: 0.6875rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text); }
    .chef-anim-tweak .frame-btns { display: flex; gap: 0.2rem; }
    .chef-anim-tweak .frame-btns button { padding: 0.2rem 0.4rem; font-size: 0.6875rem; min-width: 1.5rem; }
    .chef-animations__item[data-frames="1"] .frame-btns { display: none; }
    .chef-anim-tweak .chef-align-all-btn { padding: 0.2rem 0.5rem; font-size: 0.6875rem; }
    .error { color: var(--danger); }
    /* 86 THE BUGS button - icon only */
    .finish-him-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
      border: 1px solid #ef4444;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .finish-him-btn svg { width: 16px; height: 16px; }
    .finish-him-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #f97316 0%, #eab308 100%);
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.6);
      border-color: #f97316;
    }
    .finish-him-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* CALL THE CHEF button - icon only */
    .review-now-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
      border: 1px solid #10b981;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .review-now-btn svg { width: 16px; height: 16px; }
    .review-now-btn:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
      border-color: #06b6d4;
    }
    /* SERVE IT / MERGE button - icon only */
    .merge-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
      border: 1px solid #8b5cf6;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .merge-btn svg { width: 16px; height: 16px; }
    .merge-btn:hover {
      background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.6);
      border-color: #a855f7;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
      white-space: nowrap;
      margin-left: 0.25rem;
    }
    .merge-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
    }
    /* ORDER UP! merge animations */
    @keyframes orderUpFlash {
      0% { opacity: 1; transform: scale(1); }
      15% { opacity: 1; transform: scale(1.08); background: rgba(16, 185, 129, 0.3); }
      30% { opacity: 1; transform: scale(1); }
      45% { opacity: 1; transform: scale(1.04); background: rgba(16, 185, 129, 0.15); }
      60% { opacity: 1; transform: scale(1); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes prRowSlideOut {
      0% { opacity: 1; transform: translateX(0); max-height: 80px; }
      60% { opacity: 0.5; transform: translateX(40px); }
      100% { opacity: 0; transform: translateX(100px); max-height: 0; padding: 0; overflow: hidden; }
    }
    @keyframes initiativeSlideAway {
      0% { opacity: 1; transform: scale(1) translateY(0); max-height: 200px; }
      30% { opacity: 1; transform: scale(1.02) translateY(0); }
      70% { opacity: 0.4; transform: scale(0.95) translateY(-10px); max-height: 200px; }
      100% { opacity: 0; transform: scale(0.8) translateY(-30px); max-height: 0; overflow: hidden; }
    }
    .order-up-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      pointer-events: none;
      animation: orderUpOverlayFade 2.5s ease-out forwards;
    }
    @keyframes orderUpOverlayFade {
      0% { opacity: 0; }
      10% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }
    .order-up-text {
      font-family: 'Press Start 2P', monospace;
      font-size: 4rem;
      color: #fbbf24;
      text-shadow:
        0 0 20px #f59e0b,
        0 0 40px #f59e0b,
        0 0 80px #ef4444,
        3px 3px 0 #b45309;
      animation: orderUpBounce 0.6s ease-out;
      letter-spacing: 0.1em;
    }
    @keyframes orderUpBounce {
      0% { transform: scale(0.3) rotate(-5deg); opacity: 0; }
      50% { transform: scale(1.15) rotate(2deg); opacity: 1; }
      70% { transform: scale(0.95) rotate(-1deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .pr-row-merging {
      animation: prRowSlideOut 0.6s ease-in forwards;
    }
    .initiative-removing {
      animation: initiativeSlideAway 0.8s ease-in forwards;
    }
    /* Custom Command Modal */
    .cmd-modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .cmd-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      width: 560px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: modalSlideUp 0.2s ease-out;
    }
    @keyframes modalSlideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .cmd-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .cmd-modal__title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }
    .cmd-modal__subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }
    .cmd-modal__close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
    }
    .cmd-modal__close:hover { color: var(--text); background: rgba(255,255,255,0.1); }
    .cmd-modal__input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--text);
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 80px;
      outline: none;
      box-sizing: border-box;
    }
    .cmd-modal__input:focus { border-color: #f59e0b; box-shadow: 0 0 0 2px rgba(245,158,11,0.2); }
    .cmd-modal__input::placeholder { color: var(--text-muted); opacity: 0.6; }
    .cmd-modal__actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    .cmd-modal__btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.15s;
    }
    .cmd-modal__btn--cancel {
      background: var(--surface);
      color: var(--text-muted);
    }
    .cmd-modal__btn--cancel:hover { background: rgba(255,255,255,0.08); color: var(--text); }
    .cmd-modal__btn--send {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      color: #fff;
      border-color: #f59e0b;
    }
    .cmd-modal__btn--send:hover { box-shadow: 0 0 12px rgba(245,158,11,0.4); transform: scale(1.02); }
    .cmd-modal__hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.75rem;
      opacity: 0.7;
    }
    /* Back Burner button - flame icon with gradient */
    .back-burner-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .back-burner-btn svg { width: 16px; height: 16px; }
    .back-burner-btn:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      color: #fff;
      border-color: #f59e0b;
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
    }
    .back-burner-btn.active {
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      color: #fff;
      border-color: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }
    .back-burner-btn.active:hover {
      background: linear-gradient(135deg, #fbbf24 0%, #f87171 100%);
      box-shadow: 0 0 16px rgba(245, 158, 11, 0.6);
    }
    /* Back-burnered row styling */
    tr.back-burnered {
      opacity: 0.4;
      filter: grayscale(0.5);
    }
    tr.back-burnered:hover {
      opacity: 0.6;
    }
    /* Back-burnered initiative group header */
    tr.initiative-group-header.back-burnered-group {
      opacity: 0.4;
      filter: grayscale(0.5);
    }
    tr.initiative-group-header.back-burnered-group:hover {
      opacity: 0.6;
    }
    /* Agent status column */
    .agent-status-cell {
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
    }
    /* Agent status banner */
    .agent-banner {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 0.25rem;
      white-space: nowrap;
    }
    .agent-banner svg { width: 12px; height: 12px; }
    a.agent-banner, button.agent-banner, .prep-work-task-row .agent-banner { text-decoration: none; cursor: pointer; }
    a.agent-banner:hover, button.agent-banner:hover, .prep-work-task-row .agent-banner:hover { filter: brightness(1.2); }
    button.agent-banner { border: 1px solid; }
    .agent-banner--pending {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }
    .agent-banner--running {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    .agent-banner--running svg { animation: spin 1s linear infinite; }
    .agent-banner--complete {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .agent-banner--failed {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .agent-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
    }
    .agent-status svg { width: 14px; height: 14px; }
    .agent-status.pending {
      background: rgba(107, 114, 128, 0.2);
      color: var(--text-muted);
    }
    .agent-status.running {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }
    .agent-status.running svg { animation: spin 1s linear infinite; }
    .agent-status.complete {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
    }
    .agent-status.failed {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }
    .agent-status-link {
      text-decoration: none;
      cursor: pointer;
      border-radius: 4px;
      transition: opacity 0.15s ease;
    }
    .agent-status-link:hover {
      opacity: 0.8;
    }
    .agent-status-link:hover .agent-status {
      filter: brightness(1.15);
    }
    .agent-status-link:hover .agent-status-empty {
      color: var(--primary);
    }
    .agent-status-empty {
      color: var(--text-muted);
      opacity: 0.5;
    }
    .back-burner-cell {
      text-align: center;
      width: 40px;
    }
    /* Back Burner section styling */
    .back-burner-section {
      opacity: 0.7;
      border: 1px solid rgba(245, 158, 11, 0.15);
    }
    .back-burner-section:hover { opacity: 0.85; }
    .back-burner-section .card-header {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(239, 68, 68, 0.05) 100%);
      color: #f59e0b;
    }
    /* Prep Work section */
    .prep-work-task-row td { padding: 0.6rem 0.75rem; }
    .prep-work-task-cmd {
      color: var(--text-muted);
      font-size: 0.8rem;
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .prep-work-clear-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      font-size: 0.7rem;
      transition: all 0.15s;
    }
    .prep-work-clear-btn:hover { color: #ef4444; border-color: #ef4444; }

    /* Agent Log Panel */
    .agent-log-toggle {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 8000;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .agent-log-toggle svg { width: 20px; height: 20px; }
    .agent-log-toggle:hover { color: #f59e0b; border-color: #f59e0b; box-shadow: 0 4px 16px rgba(245,158,11,0.3); }
    .agent-log-toggle .log-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #3b82f6;
      border: 2px solid #0f172a;
      display: none;
      animation: agentPulse 1.2s ease-in-out infinite;
    }
    .agent-log-toggle.has-activity .log-badge { display: block; }
    .agent-log-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 420px;
      height: 100vh;
      background: #0c1222;
      border-left: 1px solid var(--border);
      z-index: 8500;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
      box-shadow: -8px 0 30px rgba(0,0,0,0.4);
    }
    .agent-log-panel.open { right: 0; }
    .agent-log-panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .agent-log-panel__title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .agent-log-panel__title svg { width: 16px; height: 16px; color: #f59e0b; }
    .agent-log-panel__close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
    }
    .agent-log-panel__close:hover { color: var(--text); }
    .agent-log-panel__body {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.72rem;
      line-height: 1.5;
    }
    .agent-log-entry {
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      margin-bottom: 1px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .agent-log-entry--system {
      color: #6b7280;
      font-style: italic;
    }
    .agent-log-entry--stdout { color: #d1d5db; }
    .agent-log-entry--stderr { color: #fca5a5; }
    .agent-log-entry--status {
      color: #34d399;
      background: rgba(16, 185, 129, 0.08);
      font-weight: 500;
    }
    .agent-log-entry--status.failed {
      color: #f87171;
      background: rgba(239, 68, 68, 0.08);
    }
    .agent-log-divider {
      border: none;
      border-top: 1px solid rgba(255,255,255,0.06);
      margin: 0.5rem 0;
    }
    .agent-log-panel__clear {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
    }
    .agent-log-panel__clear:hover { color: var(--text); border-color: var(--text-muted); }
    /* Row loading overlay */
    .row-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 30, 30, 0.6);
      pointer-events: none;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .row-loading-overlay::after {
      content: '↻';
      font-size: 1.25rem;
      color: var(--text-muted);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spin { animation: spin 1s linear infinite; }
    /* Flamethrower overlay on row */
    .flamethrower-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10;
      overflow: hidden;
      display: flex;
      align-items: center;
    }
    /* Chef sprite animations - using chef-sprite-animations.png */
    /* Sprite sheet: 1088x960, frames: 272x240, flame: 544x240 (2 cols) */
    /* Display at 50% scale: 136x120 per frame, flame: 272x120 */
    .chef-sprite {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background-image: url(/images/chef-sprite-animations.png);
      background-repeat: no-repeat;
      background-size: 544px 480px; /* 50% scale */
    }
    .chef-sprite--run {
      width: 136px;
      height: 120px;
      animation: chef-run 0.4s steps(2) infinite;
    }
    @keyframes chef-run {
      0% { background-position: 0 0; }
      50% { background-position: -136px 0; }
      100% { background-position: 0 0; }
    }
    .chef-sprite--idle {
      width: 136px;
      height: 120px;
      animation: chef-idle 0.6s steps(4) infinite;
    }
    @keyframes chef-idle {
      /* idle frames are at row 2 cols 2-3 and row 3 cols 2-3 */
      0% { background-position: -272px -120px; }
      25% { background-position: -408px -120px; }
      50% { background-position: -272px -240px; }
      75% { background-position: -408px -240px; }
      100% { background-position: -272px -120px; }
    }
    .chef-sprite--attack {
      width: 136px;
      height: 120px;
      animation: chef-attack 0.25s steps(2) forwards;
    }
    @keyframes chef-attack {
      /* attack frames are at row 1 cols 2-3 */
      0% { background-position: -272px 0; }
      50% { background-position: -408px 0; }
      100% { background-position: -408px 0; }
    }
    .chef-sprite--jump {
      width: 136px;
      height: 120px;
      animation: chef-jump 0.4s steps(2) forwards;
    }
    @keyframes chef-jump {
      /* jump frames are at row 2 cols 0-1 */
      0% { background-position: 0 -120px; }
      50% { background-position: -136px -120px; }
      100% { background-position: -136px -120px; }
    }
    .chef-sprite--hurt {
      width: 136px;
      height: 120px;
      /* hurt frame is at row 4 col 0 */
      background-position: 0 -360px;
    }
    .chef-sprite--death {
      width: 136px;
      height: 120px;
      animation: chef-death 1s steps(4) forwards;
    }
    @keyframes chef-death {
      /* hurt -> death -> ash pile frames in row 4 */
      0% { background-position: 0 -360px; }
      25% { background-position: -136px -360px; }
      50% { background-position: -272px -360px; }
      75%, 100% { background-position: -408px -360px; }
    }
    /* Flame animation - wider frame (544x240 -> 272x120 at 50%) */
    .chef-sprite--flame {
      width: 272px;
      height: 120px;
      /* flame frame is at row 3 cols 0-1 */
      background-position: 0 -240px;
    }
    /* Flamethrower overlay uses the flame sprite */
    .flamethrower-chef {
      position: absolute;
      left: -20px;
      width: 272px;
      height: 120px;
      background: url(/images/chef-sprite-animations.png) no-repeat;
      background-size: 544px 480px;
      background-position: 0 -240px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      z-index: 11;
    }
    /* Sprite preview section */
    .sprite-preview {
      display: none; /* Hidden for now */
      margin-bottom: var(--space);
    }
    .sprite-preview__header {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      padding: 0 0.5rem;
    }
    .sprite-preview__title {
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text);
    }
    .sprite-preview__subtitle {
      font-size: 0.75rem;
      color: var(--text-dim);
      font-family: monospace;
    }
    .sprite-preview__grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
    }
    .sprite-preview__item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      background: #2a5030;
      border-radius: 8px;
      padding: 1rem;
      min-width: 150px;
    }
    .sprite-preview__item--wide {
      min-width: 280px;
    }
    .sprite-preview__label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .sprite-replay-btn {
      font-size: 0.625rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .sprite-replay-btn:hover {
      background: rgba(255,255,255,0.25);
    }
    /* Unassigned PRs dropdown */
    .unassigned-dropdown {
      position: relative;
    }
    .unassigned-dropdown__btn {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .unassigned-dropdown__btn:hover {
      background: var(--surface-hover);
      border-color: var(--text-dim);
    }
    .unassigned-dropdown__btn svg {
      width: 14px;
      height: 14px;
    }
    .unassigned-dropdown__badge {
      background: var(--warning);
      color: #000;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    .unassigned-dropdown__menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      min-width: 320px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .unassigned-dropdown.open .unassigned-dropdown__menu {
      display: block;
    }
    .unassigned-dropdown__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.625rem 0.875rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }
    .unassigned-dropdown__item:hover {
      background: var(--surface-hover);
    }
    .unassigned-dropdown__item:last-child {
      border-bottom: none;
    }
    .unassigned-dropdown__item-info {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      flex: 1;
      min-width: 0;
    }
    .unassigned-dropdown__item-title {
      font-size: 0.8125rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .unassigned-dropdown__item-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.6875rem;
      color: var(--text-dim);
    }
    .unassigned-dropdown__item-repo {
      font-weight: 500;
    }
    .unassigned-dropdown__item-branch {
      font-family: monospace;
      background: rgba(255,255,255,0.1);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
    }
    .unassigned-dropdown__item-action {
      font-size: 0.625rem;
      padding: 0.25rem 0.5rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }
    .unassigned-dropdown__item-action:hover {
      filter: brightness(1.1);
    }
    .unassigned-dropdown__empty {
      padding: 1rem;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.8125rem;
    }
    /* Inline initiative picker dropdown (for rows with no initiative) */
    .init-picker {
      position: relative;
      display: inline-block;
    }
    .init-picker__btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-dim);
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .init-picker__btn:hover {
      background: var(--surface-hover);
      border-color: var(--warning);
      color: var(--text);
    }
    .init-picker__btn svg {
      width: 12px;
      height: 12px;
    }
    .init-picker__menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 0.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      min-width: 180px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .init-picker.open .init-picker__menu {
      display: block;
    }
    .init-picker__item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
      font-size: 0.75rem;
    }
    .init-picker__item:hover {
      background: var(--surface-hover);
    }
    .init-picker__item:last-child {
      border-bottom: none;
    }
    .init-picker__item-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .init-picker__item-name {
      color: var(--text);
    }
    .init-picker__empty {
      padding: 0.75rem;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.75rem;
    }
    tr.finishing {
      position: relative;
    }
    tr.finishing > td {
      opacity: 0.3;
    }
    tr.finishing .flamethrower-overlay {
      opacity: 1;
    }
    .section {
      margin-top: var(--space);
    }
    .events-section .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .events-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.8125rem;
    }
    .events-list li {
      padding: 0.625rem 1.25rem;
      padding-left: 1.5rem;
      border-bottom: 1px solid var(--border);
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      transition: background 0.1s, border-left-color 0.1s;
    }
    .events-list li:has(a:hover) {
      border-left-color: var(--accent);
    }
    .events-list li:hover {
      background: rgba(39, 39, 42, 0.4);
    }
    .events-list li:last-child {
      border-bottom: none;
    }
    .event-time {
      color: var(--text-dim);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      min-width: 10rem;
    }
    .event-body {
      flex: 1;
      min-width: 0;
    }
    .event-body a {
      color: var(--text);
      font-weight: 500;
    }
    .event-body a:hover {
      color: #60a5fa;
    }
    .event-actor {
      color: var(--initiative);
      font-weight: 500;
    }
    .empty-state {
      padding: 2rem 1.25rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .initiative-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: var(--space);
    }
    .initiative-card {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.875rem;
      transition: background 0.15s, border-color 0.15s, transform 0.15s, opacity 0.15s;
      cursor: grab;
    }
    .init-card-text {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .init-status-badge {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      line-height: 1;
      width: fit-content;
    }
    .init-status--grill {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }
    .init-status--backburner {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }
    .init-status--prep {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }
    .init-status--idle {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }
    .initiative-card:active {
      cursor: grabbing;
    }
    .initiative-card.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    .initiative-card.drag-over {
      border-color: var(--accent);
      background: var(--surface-hover);
      transform: scale(1.02);
    }
    .initiative-card:hover {
      background: var(--surface-hover);
      border-color: var(--text-dim);
      text-decoration: none;
    }
    .initiative-card__buttons {
      display: flex;
      gap: 0.3rem;
      margin-left: auto;
      flex-shrink: 0;
    }
    .initiative-card__btn {
      width: 24px;
      height: 24px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--surface-hover);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s, color 0.15s, border-color 0.15s;
    }
    .initiative-card__btn svg { width: 13px; height: 13px; }
    .initiative-card:hover .initiative-card__btn { opacity: 1; }
    .initiative-card__btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .initiative-card__btn--cursor { text-decoration: none; }
    .initiative-card__btn--chat { }
    .initiative-card .initiative-icon {
      width: 32px;
      height: 32px;
    }
    .initiative-card--nolink {
      cursor: default;
    }
    /* Initiative card icon wrapper with edit button */
    .initiative-icon-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .initiative-icon-edit {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .initiative-icon-edit svg {
      width: 12px;
      height: 12px;
    }
    .initiative-icon-wrap:hover .initiative-icon-edit {
      opacity: 1;
    }
    .initiative-icon-edit:hover {
      background: var(--accent);
    }
    .initiative-card { position: relative; }
    .initiative-icon-terminal {
      position: absolute;
      top: -8px;
      right: 16px;
      width: 20px;
      height: 20px;
      background: #f59e0b;
      border: 2px solid var(--surface);
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, transform 0.15s;
      padding: 0;
      z-index: 5;
    }
    .initiative-icon-terminal svg { width: 10px; height: 10px; }
    .initiative-card:hover .initiative-icon-terminal { opacity: 1; }
    .initiative-icon-terminal:hover { background: #f97316; transform: scale(1.15); }
    .initiative-orderup-prep {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: var(--surface);
      border: 2px solid var(--surface);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, transform 0.15s;
      padding: 0;
      z-index: 5;
      overflow: hidden;
    }
    .initiative-orderup-prep img { width: 14px; height: 14px; image-rendering: pixelated; }
    .initiative-card:hover .initiative-orderup-prep { opacity: 1; }
    .initiative-orderup-prep:hover { transform: scale(1.15); border-color: var(--accent); }
    /* Placeholder/loading state for new initiatives */
    .initiative-card--creating {
      border-style: dashed;
      animation: initiative-creating-pulse 1s ease-in-out infinite alternate;
    }
    @keyframes initiative-creating-pulse {
      0% { border-color: var(--border); }
      100% { border-color: var(--accent); }
    }
    .initiative-icon-placeholder {
      width: 32px;
      height: 32px;
      background: var(--surface-hover);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      font-size: 0.75rem;
    }
    .initiative-icon-placeholder--loading {
      animation: icon-loading-spin 1s linear infinite;
    }
    @keyframes icon-loading-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .frame-coords-card .card-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
    .frame-coords-card table { font-size: 0.8125rem; }
    .frame-coords-card th, .frame-coords-card td { padding: 0.35rem 0.5rem; }
    .frame-coords-card input[type="number"] { width: 4rem; padding: 0.25rem 0.35rem; font-size: 0.8125rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text); }
    .frame-coords-card .frame-coords-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .frame-coords-card .frame-coords-saved { font-size: 0.75rem; color: var(--success); margin-left: 0.5rem; }
    .frame-coords-preview { width: 60px; height: 64px; overflow: hidden; background: url(/images/chef-run-jump.png) no-repeat; background-color: var(--surface-hover); border-radius: 4px; border: 1px solid var(--border); image-rendering: pixelated; image-rendering: crisp-edges; flex-shrink: 0; }

    /* Responsive styles for narrower widths */
    @media (max-width: 1400px) {
      .app {
        padding: var(--space) 16px 48px;
      }
      th, td {
        padding: 0.6rem 0.75rem;
      }
      .checks-container {
        min-width: 240px;
        gap: 0.75rem;
      }
      .preview-links {
        gap: 0.25rem;
      }
      .preview-link {
        padding: 0.15rem 0.4rem;
        font-size: 0.6875rem;
      }
    }

    @media (max-width: 1200px) {
      .app {
        max-width: 100%;
        padding: 1rem 12px 40px;
      }
      table {
        font-size: 0.8125rem;
      }
      th, td {
        padding: 0.5rem 0.5rem;
      }
      th {
        font-size: 0.6875rem;
      }
      .checks-container {
        min-width: 200px;
        gap: 0.5rem;
      }
      .initiative-icon {
        width: 36px;
        height: 36px;
      }
      td code {
        font-size: 0.75rem;
        padding: 0.1rem 0.3rem;
      }
      .preview-links {
        flex-direction: column;
        gap: 0.2rem;
      }
      .preview-link {
        font-size: 0.625rem;
        padding: 0.125rem 0.35rem;
      }
      .comments-unresolved {
        white-space: nowrap;
      }
      .title-cell {
        max-width: 160px;
      }
      .conflicts-banner {
        padding: 0.35rem 0.5rem;
        gap: 0.35rem;
      }
      .conflicts-banner__text {
        font-size: 0.6875rem;
      }
      .conflicts-banner__btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.6875rem;
      }
    }

    @media (max-width: 1100px) {
      .checks-container {
        min-width: 180px;
        gap: 0.35rem;
      }
      .check-icon {
        width: 18px;
        height: 18px;
        font-size: 10px;
      }
      .row-merge-btn {
        padding: 0.2rem 0.35rem;
        font-size: 0.6875rem;
      }
      .repo-cell {
        font-size: 0.75rem;
      }
      .platform-icon svg {
        width: 14px;
        height: 14px;
      }
      .title-cell {
        max-width: 140px;
      }
      .initiative-with-icon {
        gap: 0.25rem;
      }
      .initiative-icon {
        width: 32px;
        height: 32px;
      }
    }

    @media (max-width: 1000px) {
      th, td {
        padding: 0.4rem 0.4rem;
      }
      .checks-cell {
        padding: 0.35rem 0.4rem;
      }
      .checks-container {
        min-width: 160px;
        gap: 0.25rem;
      }
      .check-icon-wrap {
        min-width: 20px;
      }
      .preview-link {
        font-size: 0.5625rem;
        padding: 0.1rem 0.25rem;
      }
      .title-cell {
        max-width: 120px;
      }
      /* Show short "unresolved" count at narrow widths */
      .comments-full {
        display: none;
      }
      .comments-short {
        display: inline;
      }
      /* Icon headers scale down at narrow widths */
      .th-icon svg {
        width: 14px;
        height: 14px;
      }
      .checks-header-icons {
        gap: 0.25rem;
      }
      .comments-unresolved {
        font-size: 0.75rem;
      }
      .conflicts-banner {
        flex-direction: column;
        padding: 0.25rem 0.35rem;
        gap: 0.25rem;
      }
      .conflicts-banner__text {
        font-size: 0.625rem;
      }
    }

    @media (max-width: 900px) {
      .header {
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
      }
      .logo-img {
        height: 320px;
        display: flex;
        width: 100%;
        justify-content: space-between;
      }
      table {
        font-size: 0.75rem;
      }
      th {
        font-size: 0.625rem;
        letter-spacing: 0.02em;
      }
      th, td {
        padding: 0.35rem 0.3rem;
      }
      .checks-cell {
        padding: 0.25rem 0.3rem;
      }
      .checks-container {
        min-width: 140px;
        gap: 0.2rem;
      }
      .check-icon {
        width: 16px;
        height: 16px;
        font-size: 9px;
      }
      .initiative-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
      }
      .initiative-card .initiative-icon {
        width: 24px;
        height: 24px;
      }
      .initiative-card {
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
      }
      .title-cell {
        max-width: 100px;
      }
      .th-icon svg {
        width: 12px;
        height: 12px;
      }
      .checks-header-icons {
        gap: 0.15rem;
      }
      td code {
        font-size: 0.6875rem;
      }
      .row-refresh {
        font-size: 0.875rem;
        padding: 0.15rem 0.3rem;
      }
      .row-merge-btn {
        padding: 0.15rem 0.25rem;
        font-size: 0.625rem;
      }
      .preview-links {
        gap: 0.15rem;
      }
    }

    @media (max-width: 800px) {
      .checks-container {
        min-width: 120px;
        gap: 0.15rem;
      }
      .check-icon {
        width: 14px;
        height: 14px;
        font-size: 8px;
      }
      .title-cell {
        max-width: 80px;
      }
      .initiative-icon {
        width: 24px;
        height: 24px;
      }
      .th-icon svg {
        width: 11px;
        height: 11px;
      }
      .checks-header-icons {
        gap: 0.1rem;
      }
      .repo-cell {
        font-size: 0.6875rem;
      }
      .platform-icon svg {
        width: 12px;
        height: 12px;
      }
      .platform-icon {
        margin-right: 0.2rem;
      }
      td code {
        font-size: 0.625rem;
        padding: 0.05rem 0.2rem;
      }
    }

    /* --- Chat Panel (slide-out from right) --- */
    .chat-panel-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .chat-panel-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }
    .chat-panel {
      position: fixed;
      top: 3vh; left: 3vw; right: 3vw; bottom: 3vh;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      z-index: 9001;
      display: flex;
      flex-direction: row;
      opacity: 0;
      transform: scale(0.97);
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .chat-panel.open {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    /* Sidebar */
    .chat-modal__sidebar {
      width: 260px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--surface);
    }
    .chat-modal__sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 0.85rem;
      border-bottom: 1px solid var(--border);
      min-height: 52px;
      flex-shrink: 0;
    }
    .chat-modal__sidebar-header img {
      width: 24px; height: 24px; border-radius: 4px;
    }
    .chat-modal__sidebar-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-modal__new-chat-btn {
      margin-left: auto;
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
      font-weight: 500;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: background 0.15s;
      flex-shrink: 0;
    }
    .chat-modal__new-chat-btn svg { width: 12px; height: 12px; }
    .chat-modal__new-chat-btn:hover { background: var(--accent-hover); }
    .chat-modal__session-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.35rem 0;
    }
    .chat-modal__session-list::-webkit-scrollbar { width: 5px; }
    .chat-modal__session-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    /* Session group (per PR) in sidebar */
    .chat-sidebar__pr-group {
      padding: 0.15rem 0;
    }
    .chat-sidebar__pr-group + .chat-sidebar__pr-group {
      border-top: 1px solid var(--border);
    }
    .chat-sidebar__pr-label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.85rem 0.15rem;
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .chat-sidebar__pr-label svg { width: 12px; height: 12px; }
    .chat-sidebar__session {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.85rem;
      font-size: 0.75rem;
      color: var(--text);
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      line-height: 1.3;
    }
    .chat-sidebar__session:hover { background: var(--surface-hover); }
    .chat-sidebar__session.active { background: rgba(99, 102, 241, 0.1); }
    .chat-sidebar__session.active .chat-sidebar__session-label { color: var(--accent); }
    .chat-sidebar__session-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .chat-sidebar__session-dot--running { background: #60a5fa; animation: deploy-pulse 1.5s ease-in-out infinite; }
    .chat-sidebar__session-dot--complete { background: #22c55e; }
    .chat-sidebar__session-dot--failed { background: #ef4444; }
    .chat-sidebar__session-dot--cancelled { background: #6b7280; }
    .chat-sidebar__session-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    .chat-sidebar__session-time {
      font-size: 0.625rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .chat-sidebar__empty {
      padding: 1.5rem 0.85rem;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
    }
    /* Main chat area (right side of modal) */
    .chat-modal__main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .chat-panel__header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      min-height: 52px;
      flex-shrink: 0;
    }
    .chat-panel__title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-panel__title small {
      font-weight: 400;
      color: var(--text-muted);
      margin-left: 0.25rem;
    }
    .chat-panel__status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.6875rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-weight: 500;
    }
    .chat-panel__status--running {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }
    .chat-panel__status--complete {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }
    .chat-panel__status--failed {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }
    .chat-panel__status--cancelled {
      background: rgba(107, 114, 128, 0.15);
      color: #9ca3af;
    }
    .chat-panel__cancel-btn,
    .chat-panel__close-btn {
      padding: 0.3rem;
      background: none;
      color: var(--text-muted);
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .chat-panel__cancel-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border-color: rgba(239, 68, 68, 0.3);
    }
    .chat-panel__close-btn:hover {
      background: var(--surface-hover);
      color: var(--text);
    }
    .chat-panel__cancel-btn svg,
    .chat-panel__close-btn svg {
      width: 16px; height: 16px;
    }
    .chat-panel__messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      scroll-behavior: smooth;
    }
    .chat-panel__messages::-webkit-scrollbar {
      width: 6px;
    }
    .chat-panel__messages::-webkit-scrollbar-track {
      background: transparent;
    }
    .chat-panel__messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    /* Quick-action buttons when no session active */
    .chat-panel__actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 2rem 1.5rem;
      align-items: center;
      justify-content: center;
      flex: 1;
    }
    .chat-panel__actions-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .chat-panel__action-btn {
      width: 100%;
      max-width: 300px;
      padding: 0.75rem 1rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.15s;
    }
    .chat-panel__action-btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
      color: var(--accent-hover);
    }
    .chat-panel__action-btn svg {
      width: 18px; height: 18px;
      flex-shrink: 0;
    }
    .chat-panel__action-btn--custom {
      margin-top: 0.5rem;
      border-style: dashed;
    }
    /* Custom prompt input area */
    .chat-panel__input-area {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .chat-panel__input-area.visible {
      display: flex;
    }
    .chat-panel__input-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    .chat-panel__input {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
      font-family: inherit;
      resize: none;
      min-height: 36px;
      max-height: 120px;
      outline: none;
    }
    .chat-panel__input:focus {
      border-color: var(--accent);
    }
    .chat-panel__input.drag-over {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.06);
    }
    .chat-panel__attach-btn {
      padding: 0.4rem;
      background: none;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .chat-panel__attach-btn:hover {
      background: var(--surface-hover);
      color: var(--text);
      border-color: var(--accent);
    }
    .chat-panel__attach-btn svg {
      width: 16px; height: 16px;
    }
    .chat-panel__send-btn {
      padding: 0.4rem 0.75rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s;
      flex-shrink: 0;
    }
    .chat-panel__send-btn:hover {
      background: var(--accent-hover);
    }
    .chat-panel__send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Image attachment previews */
    .chat-panel__attachments {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .chat-panel__attachments:empty {
      display: none;
    }
    .chat-attachment {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--bg);
    }
    .chat-attachment img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .chat-attachment__remove {
      position: absolute;
      top: 2px; right: 2px;
      width: 18px; height: 18px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 11px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .chat-attachment__remove:hover {
      background: rgba(239, 68, 68, 0.9);
    }
    .chat-attachment--uploading {
      opacity: 0.5;
    }
    .chat-attachment--uploading::after {
      content: '';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.3);
    }
    /* Inline image in chat messages */
    .chat-msg--image {
      max-width: 280px;
    }
    .chat-msg--image img {
      width: 100%;
      border-radius: 6px;
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .chat-msg--image img:hover {
      border-color: var(--accent);
    }
    /* Prompt images */
    .chat-prompt__images {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .chat-prompt__images img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 6px;
      border: 1px solid var(--border);
      object-fit: contain;
      cursor: pointer;
      background: var(--bg);
    }
    .chat-prompt__images img:hover {
      border-color: var(--accent);
    }
    /* Thinking indicator */
    .chat-msg--thinking {
      color: var(--text-dim);
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      user-select: none;
    }
    .chat-msg--thinking svg {
      width: 12px; height: 12px;
      flex-shrink: 0;
    }
    .chat-msg--thinking .thinking-label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .chat-msg--thinking.active .thinking-dots::after {
      content: '';
      animation: thinking-dots 1.4s infinite;
    }
    @keyframes thinking-dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    .chat-msg--thinking .thinking-body {
      display: none;
      margin-top: 0.35rem;
      padding: 0.35rem 0.5rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 200px;
      overflow-y: auto;
      font-style: italic;
    }
    .chat-msg--thinking.expanded .thinking-body {
      display: block;
    }
    .chat-msg--thinking .thinking-chevron {
      margin-left: auto;
      transition: transform 0.15s;
    }
    .chat-msg--thinking.expanded .thinking-chevron {
      transform: rotate(90deg);
    }
    /* Collapsed previous conversation turns */
    .chat-history-turn {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      flex-shrink: 0;
    }
    .chat-history-turn__header {
      padding: 0.5rem 0.75rem;
      background: var(--surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      user-select: none;
      transition: background 0.15s;
    }
    .chat-history-turn__header:hover {
      background: var(--surface-hover);
    }
    .chat-history-turn__header svg {
      width: 12px; height: 12px;
      flex-shrink: 0;
    }
    .chat-history-turn__prompt {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
      color: var(--text);
    }
    .chat-history-turn__prompt img {
      height: 16px;
      width: 16px;
      border-radius: 3px;
      object-fit: cover;
      vertical-align: middle;
      margin-left: 0.25rem;
    }
    .chat-history-turn__summary {
      font-size: 0.6875rem;
      color: var(--text-dim);
      flex-shrink: 0;
    }
    .chat-history-turn__chevron {
      transition: transform 0.15s;
      flex-shrink: 0;
    }
    .chat-history-turn.expanded .chat-history-turn__chevron {
      transform: rotate(90deg);
    }
    .chat-history-turn__body {
      display: none;
      border-top: 1px solid var(--border);
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      max-height: 300px;
      overflow-y: auto;
    }
    .chat-history-turn__body .chat-msg {
      font-size: 0.75rem;
    }
    .chat-history-turn.expanded .chat-history-turn__body {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .chat-history-divider {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
      color: var(--text-dim);
      font-size: 0.6875rem;
      padding: 0.25rem 0;
    }
    .chat-history-divider::before,
    .chat-history-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    /* Chat messages */
    .chat-msg {
      font-size: 0.8125rem;
      line-height: 1.5;
      flex-shrink: 0;
    }
    .chat-msg--system {
      color: var(--text-dim);
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: rgba(99, 102, 241, 0.06);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .chat-msg--system svg {
      width: 12px; height: 12px;
      flex-shrink: 0;
    }
    .chat-msg--assistant {
      color: var(--text);
      padding: 0.5rem 0.75rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .chat-msg--assistant code {
      background: rgba(99, 102, 241, 0.1);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-size: 0.75rem;
    }
    .chat-msg--assistant pre {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem;
      overflow-x: auto;
      margin: 0.5rem 0;
      font-size: 0.75rem;
    }
    .chat-msg--tool {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .chat-msg--tool-header {
      padding: 0.5rem 0.6rem;
      background: var(--surface-hover);
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-weight: 500;
      cursor: pointer;
      min-height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      user-select: none;
      transition: background 0.15s;
    }
    .chat-msg--tool-header:hover {
      background: var(--border);
    }
    .chat-msg--tool-header svg {
      width: 12px; height: 12px;
      flex-shrink: 0;
    }
    .chat-msg--tool-header .tool-chevron {
      margin-left: auto;
      transition: transform 0.15s;
    }
    .chat-msg--tool-header.expanded .tool-chevron {
      transform: rotate(90deg);
    }
    .chat-msg--tool-body {
      display: none;
      padding: 0.5rem 0.6rem;
      background: var(--bg);
      font-size: 0.6875rem;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
    .chat-msg--tool-body.expanded {
      display: block;
    }
    .chat-msg--result {
      color: var(--text-dim);
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .chat-msg--result.success {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: #34d399;
    }
    .chat-msg--result.failed {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #f87171;
    }
    .chat-msg--result svg {
      width: 14px; height: 14px;
      flex-shrink: 0;
    }
    .chat-msg--stderr {
      color: #f87171;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: rgba(239, 68, 68, 0.06);
      border-radius: 6px;
      font-family: monospace;
    }
    .chat-msg--raw {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-family: monospace;
      padding: 0.2rem 0.4rem;
    }
    /* Git commit card */
    .chat-msg--commit {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0.65rem;
      background: rgba(34, 197, 94, 0.06);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
    }
    .chat-msg--commit svg { width: 16px; height: 16px; color: #22c55e; flex-shrink: 0; margin-top: 1px; }
    .chat-msg--commit-body { flex: 1; min-width: 0; }
    .chat-msg--commit-msg { font-weight: 500; color: var(--text); word-break: break-word; }
    .chat-msg--commit-meta { font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.15rem; }
    .chat-msg--commit-sha { font-family: monospace; color: #22c55e; }
    .chat-msg--prompt {
      color: var(--accent-hover);
      font-size: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(99, 102, 241, 0.08);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 120px;
      overflow-y: auto;
    }
    /* Chat button on PR row */
    .chat-btn {
      padding: 0.35rem;
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .chat-btn svg { width: 16px; height: 16px; }
    .chat-btn:hover {
      background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
      color: #fff;
      border-color: #6366f1;
      box-shadow: 0 0 12px rgba(99, 102, 241, 0.4);
    }
    .chat-btn .chat-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--surface);
      pointer-events: none;
    }
    .chat-btn .chat-badge--running {
      background: #3b82f6;
      animation: agentPulse 1.2s ease-in-out infinite;
    }
    .chat-btn .chat-badge--complete { background: #10b981; }
    .chat-btn .chat-badge--failed { background: #ef4444; }
    /* Typing cursor animation for streaming text */
    .typing-cursor::after {
      content: '▊';
      animation: blink 0.8s step-end infinite;
      color: var(--accent);
      font-weight: bold;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    @media (max-width: 700px) {
      .chat-panel { top: 0; left: 0; right: 0; bottom: 0; border-radius: 0; }
      .chat-modal__sidebar { width: 200px; }
    }
    @media (max-width: 500px) {
      .chat-modal__sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="drag-bar"></div>
  <!-- Chat Panel (slide-out from right) -->
  <div class="chat-panel-backdrop" id="chat-panel-backdrop"></div>
  <div class="chat-panel" id="chat-panel">
    <!-- Sidebar -->
    <div class="chat-modal__sidebar" id="chat-modal-sidebar">
      <div class="chat-modal__sidebar-header">
        <span id="chat-sidebar-icon"></span>
        <span class="chat-modal__sidebar-title" id="chat-sidebar-title">Sessions</span>
        <button class="chat-modal__new-chat-btn" id="chat-sidebar-new" title="Start new chat"><i data-lucide="plus"></i> New</button>
      </div>
      <div class="chat-modal__session-list" id="chat-sidebar-sessions"></div>
    </div>
    <!-- Main chat area -->
    <div class="chat-modal__main">
      <div class="chat-panel__header">
        <span class="chat-panel__title" id="chat-panel-title">Agent Chat</span>
        <span class="chat-panel__status" id="chat-panel-status" style="display:none;"></span>
        <button class="chat-panel__cancel-btn" id="chat-panel-cancel" title="Cancel agent" style="display:none;"><i data-lucide="square"></i></button>
        <button class="chat-panel__close-btn" id="chat-panel-close" title="Close"><i data-lucide="x"></i></button>
      </div>
      <div class="chat-panel__messages" id="chat-panel-messages"></div>
      <div class="chat-panel__input-area" id="chat-panel-input-area">
        <div class="chat-panel__attachments" id="chat-panel-attachments"></div>
        <div class="chat-panel__input-row">
          <button class="chat-panel__attach-btn" id="chat-panel-attach" title="Attach image (or paste/drop)"><i data-lucide="paperclip"></i></button>
          <textarea class="chat-panel__input" id="chat-panel-input" placeholder="Send a prompt to the agent... (paste or drop images)" rows="1"></textarea>
          <button class="chat-panel__send-btn" id="chat-panel-send"><i data-lucide="send"></i> Run</button>
        </div>
        <input type="file" id="chat-panel-file-input" accept="image/*" multiple style="display:none;">
      </div>
    </div>
  </div>
  <button class="agent-log-toggle" id="agent-log-toggle" title="Agent Log"><i data-lucide="scroll-text"></i><span class="log-badge"></span></button>
  <div class="agent-log-panel" id="agent-log-panel">
    <div class="agent-log-panel__header">
      <span class="agent-log-panel__title"><i data-lucide="scroll-text"></i> Agent Log</span>
      <div style="display:flex;gap:0.5rem;align-items:center;">
        <button class="agent-log-panel__clear" id="agent-log-clear">Clear</button>
        <button class="agent-log-panel__close" id="agent-log-close"><i data-lucide="x"></i></button>
      </div>
    </div>
    <div class="agent-log-panel__body" id="agent-log-body"></div>
  </div>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <a href="#" class="logo-link" id="logo-link" title="Order Up!"><img src="/images/orderup.png" alt="Order Up!" class="logo-img" /></a>
        <div class="game-stats" id="game-stats">
          <div class="game-stats__scores">
            <div class="game-stats__player">
              <span class="game-stats__player-label">1UP</span>
              <span class="game-stats__player-score" id="stat-score">000000</span>
            </div>
            <div class="game-stats__high">
              <span class="game-stats__high-label">HIGH SCORE</span>
              <span class="game-stats__high-value" id="stat-high-score">000000</span>
            </div>
          </div>
          <div class="game-stats__counters">
            <div class="game-stats__counter">
              <span class="game-stats__counter-label">SERVED</span>
              <span class="game-stats__counter-value game-stats__value--served" id="stat-served">00</span>
            </div>
            <div class="game-stats__counter">
              <span class="game-stats__counter-label">BUGS</span>
              <span class="game-stats__counter-value game-stats__value--bugs" id="stat-bugs">00</span>
            </div>
            <div class="game-stats__counter">
              <span class="game-stats__counter-label">COMMENTS</span>
              <span class="game-stats__counter-value game-stats__value--comments" id="stat-comments">00</span>
            </div>
            <div class="game-stats__counter">
              <span class="game-stats__counter-label">CONFLICTS</span>
              <span class="game-stats__counter-value game-stats__value--conflicts" id="stat-conflicts">00</span>
            </div>
          <div class="game-stats__counter">
            <span class="game-stats__counter-label">REVIEWS</span>
            <span class="game-stats__counter-value game-stats__value--reviews" id="stat-reviews">00</span>
          </div>
          <div class="game-stats__counter">
            <span class="game-stats__counter-label">GAME HI</span>
            <span class="game-stats__counter-value game-stats__value--game" id="stat-game-high">00</span>
          </div>
        </div>
        <button type="button" class="game-stats__reset" id="stats-reset" title="Reset all stats">RESET</button>
        </div>
        <span class="meta" id="updated">—</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div class="tool-selector">
          <span class="tool-selector-label">Tool:</span>
          <select id="tool-select" title="Choose your AI coding tool">
            <option value="cursor-ide">Cursor IDE</option>
            <option value="cursor-web">Cursor Web</option>
            <option value="claude-code">Claude Code</option>
            <option value="generic">Generic</option>
          </select>
        </div>
        <button type="button" id="fix-all-issues" class="btn" title="Fix all failed checks and unresolved comments">Fix All Issues</button>
        <button type="button" id="new-food-project" class="btn" title="Create a new project named after a random food, with generated icon and cloned repos">New food project</button>
        <button type="button" id="refresh" class="btn btn-primary">Refresh</button>
      </div>
    </header>

    <div class="initiative-cards" id="initiative-cards-root" aria-label="Initiatives"></div>

    <section class="section" id="frame-coords-section" aria-label="Chef run/jump frame coordinates" style="display: none;">
      <div class="card frame-coords-card">
        <div class="card-header">
          <span>Chef run/jump frame coordinates</span>
          <div class="frame-coords-actions">
            <button type="button" id="frame-coords-load-defaults" class="btn" title="Fill form from code defaults (does not save)">Load defaults</button>
            <button type="button" id="frame-coords-reset" class="btn">Reset to default</button>
            <button type="button" id="frame-coords-save" class="btn btn-primary">Save</button>
            <span class="frame-coords-saved" id="frame-coords-saved-msg" aria-live="polite"></span>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Frame</th><th>Preview</th><th>X</th><th>Y</th><th>Width</th><th>Height</th></tr>
            </thead>
            <tbody id="frame-coords-tbody">
              <tr data-frame="0"><td>0</td><td><div class="frame-coords-preview" data-frame="0" aria-label="Frame 0 preview"></div></td><td><input type="number" data-frame="0" data-field="x" value="4" /></td><td><input type="number" data-frame="0" data-field="y" value="0" /></td><td><input type="number" data-frame="0" data-field="w" value="550" /></td><td><input type="number" data-frame="0" data-field="h" value="600" /></td></tr>
              <tr data-frame="1"><td>1</td><td><div class="frame-coords-preview" data-frame="1" aria-label="Frame 1 preview"></div></td><td><input type="number" data-frame="1" data-field="x" value="575" /></td><td><input type="number" data-frame="1" data-field="y" value="0" /></td><td><input type="number" data-frame="1" data-field="w" value="550" /></td><td><input type="number" data-frame="1" data-field="h" value="600" /></td></tr>
              <tr data-frame="2"><td>2</td><td><div class="frame-coords-preview" data-frame="2" aria-label="Frame 2 preview"></div></td><td><input type="number" data-frame="2" data-field="x" value="1160" /></td><td><input type="number" data-frame="2" data-field="y" value="0" /></td><td><input type="number" data-frame="2" data-field="w" value="550" /></td><td><input type="number" data-frame="2" data-field="h" value="600" /></td></tr>
              <tr data-frame="3"><td>3</td><td><div class="frame-coords-preview" data-frame="3" aria-label="Frame 3 preview"></div></td><td><input type="number" data-frame="3" data-field="x" value="1695" /></td><td><input type="number" data-frame="3" data-field="y" value="0" /></td><td><input type="number" data-frame="3" data-field="w" value="550" /></td><td><input type="number" data-frame="3" data-field="h" value="600" /></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="chef-animations" id="chef-animations-section" aria-label="Chef animation previews">
      <div class="chef-animations__header">
        <span class="chef-animations__title">Chef animations</span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <button type="button" id="chef-reset-defaults" class="btn" title="Restore built-in position defaults for all animations">Reset to defaults</button>
          <button type="button" id="chef-tweak-toggle" class="btn">Tweak position</button>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="walk" data-frames="4">
        <span class="chef-animations__label">Walk</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-walk-cycle.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="run" data-frames="4">
        <span class="chef-animations__label">Run</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-run-cycle.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="idle-attack" data-frames="4">
        <span class="chef-animations__label">Idle + attack</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-idle-attack.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="idle-bob" data-frames="4">
        <span class="chef-animations__label">Idle bob</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-idle-bob.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="poses" data-frames="4">
        <span class="chef-animations__label">Poses</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-poses.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="spatula" data-frames="4">
        <span class="chef-animations__label">Spatula attack</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-spatula-attack.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="overhead" data-frames="4">
        <span class="chef-animations__label">Overhead</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-overhead-attack.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="hurt" data-frames="4">
        <span class="chef-animations__label">Hurt + debris</span>
        <div class="chef-anim-wrap chef-anim-wrap--4" style="background-image: url(/images/chef-hurt-debris.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-12" /> px</label>
          <label>W <input type="number" class="chef-frame-width" placeholder="50" /> px</label>
        </div>
      </div>
      <div class="chef-animations__item" data-chef-id="flamethrower" data-frames="3">
        <span class="chef-animations__label">Flamethrower</span>
        <div class="chef-anim-wrap chef-anim-wrap--3v" style="background-image: url(/images/chef-flamethrower.png);"></div>
        <div class="chef-anim-tweak">
          <span class="frame-btns" aria-label="Frame"></span>
          <label>X <input type="number" class="chef-offset-x" value="0" /> px</label>
          <label>Y <input type="number" class="chef-offset-y" value="-88" /> px</label>
        </div>
      </div>
    </section>

    <section class="sprite-preview" id="sprite-preview-section" aria-label="Unified sprite sheet preview">
      <div class="sprite-preview__header">
        <span class="sprite-preview__title">Sprite Sheet Preview</span>
        <span class="sprite-preview__subtitle">chef-sprite-animations.png</span>
      </div>
      <div class="sprite-preview__grid">
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Run</span>
          <div class="chef-sprite chef-sprite--run"></div>
        </div>
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Idle</span>
          <div class="chef-sprite chef-sprite--idle"></div>
        </div>
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Attack</span>
          <div class="chef-sprite chef-sprite--attack" id="sprite-attack"></div>
          <button type="button" class="sprite-replay-btn" data-target="sprite-attack" data-class="chef-sprite--attack">Replay</button>
        </div>
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Jump</span>
          <div class="chef-sprite chef-sprite--jump" id="sprite-jump"></div>
          <button type="button" class="sprite-replay-btn" data-target="sprite-jump" data-class="chef-sprite--jump">Replay</button>
        </div>
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Hurt</span>
          <div class="chef-sprite chef-sprite--hurt"></div>
        </div>
        <div class="sprite-preview__item">
          <span class="sprite-preview__label">Death</span>
          <div class="chef-sprite chef-sprite--death" id="sprite-death"></div>
          <button type="button" class="sprite-replay-btn" data-target="sprite-death" data-class="chef-sprite--death">Replay</button>
        </div>
        <div class="sprite-preview__item sprite-preview__item--wide">
          <span class="sprite-preview__label">Flame</span>
          <div class="chef-sprite chef-sprite--flame"></div>
        </div>
      </div>
    </section>

    <div id="root">
      <div class="card loading-card">
        <div class="loading-stage" aria-hidden="true">
          <p class="loading-stage__title">Checking the kitchen…</p>
          <div class="loading-stage__food-track" id="loading-food-track">
            <!-- Food items populated dynamically from initiatives -->
          </div>
          <div class="loading-stage__chef" role="img" aria-hidden="true"></div>
          <div class="loading-stage__ground"></div>
          <span class="loading-stage__hint"><kbd>W</kbd> to jump</span>
        </div>
      </div>
    </div>

    <section class="section local-section" id="local-section" aria-label="Local branches" style="display:none;">
      <div class="card">
        <div class="card-header">Local branches</div>
        <div id="local-root">
          <p class="loading">Loading…</p>
        </div>
      </div>
    </section>

    <section class="section events-section" id="events-section" aria-label="GitHub events" style="display:none;">
      <div class="card">
        <div class="card-header">Recent activity</div>
        <ul class="events-list" id="events-list">
          <li class="loading">Loading…</li>
        </ul>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" aria-live="polite">
    <i data-lucide="check-circle"></i>
    <span id="toast-message">Copied!</span>
  </div>

  <script>
    const root = document.getElementById('root');
    const updated = document.getElementById('updated');
    const refreshBtn = document.getElementById('refresh');
    // Cache last known initiatives so they remain visible during loading
    var INITIATIVES_CACHE_KEY = 'prWatcher_cachedInitiatives';
    var INITIATIVE_FOCUS_KEY = 'prWatcher_initiativeFocus';
    var INITIATIVE_ORDER_KEY = 'prWatcher_initiativeOrder';
    var BACK_BURNER_KEY = 'prWatcher_backBurner';
    var cachedInitiatives = null;
    var initiativeFocuses = {};
    var initiativeOrder = [];
    var backBurnerPRs = {}; // { "repo#number": true }
    // Try to restore from localStorage on page load
    try {
      var stored = localStorage.getItem(INITIATIVES_CACHE_KEY);
      if (stored) cachedInitiatives = JSON.parse(stored);
    } catch (e) {}
    try {
      var storedFocus = localStorage.getItem(INITIATIVE_FOCUS_KEY);
      if (storedFocus) initiativeFocuses = JSON.parse(storedFocus);
    } catch (e) {}
    try {
      var storedOrder = localStorage.getItem(INITIATIVE_ORDER_KEY);
      if (storedOrder) initiativeOrder = JSON.parse(storedOrder);
    } catch (e) {}
    try {
      var storedBackBurner = localStorage.getItem(BACK_BURNER_KEY);
      if (storedBackBurner) backBurnerPRs = JSON.parse(storedBackBurner);
    } catch (e) {}
    
    // Game Stats - track actions locally
    var GAME_STATS_KEY = 'prWatcher_gameStats';
    var HIGH_SCORE_KEY = 'prWatcher_highScore';
    var gameStats = {
      served: 0,    // PRs merged
      bugs: 0,      // Check fixes initiated
      comments: 0,  // Comment resolutions initiated
      conflicts: 0, // Conflict resolutions initiated
      reviews: 0    // Review requests
    };
    var highScore = 0;
    // Point values for each action
    var STAT_POINTS = {
      served: 100,
      bugs: 25,
      comments: 15,
      conflicts: 50,
      reviews: 10
    };
    try {
      var storedStats = localStorage.getItem(GAME_STATS_KEY);
      if (storedStats) gameStats = JSON.parse(storedStats);
    } catch (e) {}
    try {
      var storedHigh = localStorage.getItem(HIGH_SCORE_KEY);
      if (storedHigh) highScore = parseInt(storedHigh, 10) || 0;
    } catch (e) {}
    
    function saveGameStats() {
      try { localStorage.setItem(GAME_STATS_KEY, JSON.stringify(gameStats)); } catch (e) {}
    }
    
    function saveHighScore() {
      try { localStorage.setItem(HIGH_SCORE_KEY, String(highScore)); } catch (e) {}
    }
    
    function calculateScore() {
      return (gameStats.served * STAT_POINTS.served) +
             (gameStats.bugs * STAT_POINTS.bugs) +
             (gameStats.comments * STAT_POINTS.comments) +
             (gameStats.conflicts * STAT_POINTS.conflicts) +
             (gameStats.reviews * STAT_POINTS.reviews);
    }
    
    function formatArcadeNumber(num, digits) {
      var s = String(num);
      while (s.length < digits) s = '0' + s;
      return s;
    }
    
    function renderGameStats() {
      var el;
      var score = calculateScore();
      
      // Update high score if current score beats it
      if (score > highScore) {
        highScore = score;
        saveHighScore();
      }
      
      // Counters
      el = document.getElementById('stat-served');
      if (el) el.textContent = formatArcadeNumber(gameStats.served, 2);
      el = document.getElementById('stat-bugs');
      if (el) el.textContent = formatArcadeNumber(gameStats.bugs, 2);
      el = document.getElementById('stat-comments');
      if (el) el.textContent = formatArcadeNumber(gameStats.comments, 2);
      el = document.getElementById('stat-conflicts');
      if (el) el.textContent = formatArcadeNumber(gameStats.conflicts, 2);
      el = document.getElementById('stat-reviews');
      if (el) el.textContent = formatArcadeNumber(gameStats.reviews, 2);
      
      // 1UP Score (current score)
      el = document.getElementById('stat-score');
      if (el) el.textContent = formatArcadeNumber(score, 6);
      
      // High Score
      el = document.getElementById('stat-high-score');
      if (el) el.textContent = formatArcadeNumber(highScore, 6);
    }
    
    function incrementStat(statName) {
      if (gameStats.hasOwnProperty(statName)) {
        var oldScore = calculateScore();
        var wasHighScore = highScore;
        
        gameStats[statName]++;
        saveGameStats();
        renderGameStats();
        
        var newScore = calculateScore();
        
        // Trigger bump animation on counter
        var el = document.getElementById('stat-' + statName);
        if (el) {
          el.classList.remove('bump');
          void el.offsetWidth; // Force reflow
          el.classList.add('bump');
        }
        // Also bump 1UP score
        var scoreEl = document.getElementById('stat-score');
        if (scoreEl) {
          scoreEl.classList.remove('bump');
          void scoreEl.offsetWidth;
          scoreEl.classList.add('bump');
        }
        // If new high score, bump and flash the high score
        if (newScore > wasHighScore) {
          var highEl = document.getElementById('stat-high-score');
          if (highEl) {
            highEl.classList.remove('bump');
            void highEl.offsetWidth;
            highEl.classList.add('bump');
          }
          // Show toast for new high score
          if (wasHighScore > 0) {
            showToast('NEW HIGH SCORE! ' + formatArcadeNumber(newScore, 6));
          }
        }
      }
    }
    
    function resetGameStats() {
      gameStats = { served: 0, bugs: 0, comments: 0, conflicts: 0, reviews: 0 };
      saveGameStats();
      renderGameStats();
      // Also reset loading game high score
      loadingGameHighScore = 0;
      try { localStorage.setItem(LOADING_GAME_HIGH_KEY, '0'); } catch (e) {}
      renderLoadingGameHighScore();
    }
    
    // Render stats on page load
    document.addEventListener('DOMContentLoaded', function() {
      renderGameStats();
      renderLoadingGameHighScore();
      var resetBtn = document.getElementById('stats-reset');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (confirm('Reset all game stats to zero?')) {
            resetGameStats();
            showToast('Stats reset!');
          }
        });
      }
    });
    
    function isBackBurner(repo, number) {
      return backBurnerPRs[repo + '#' + number] === true;
    }
    function toggleBackBurner(repo, number) {
      var key = repo + '#' + number;
      if (backBurnerPRs[key]) {
        delete backBurnerPRs[key];
      } else {
        backBurnerPRs[key] = true;
      }
      try { localStorage.setItem(BACK_BURNER_KEY, JSON.stringify(backBurnerPRs)); } catch (e) {}
    }
    function getInitiativeFocus(name) {
      return initiativeFocuses[name] || '';
    }
    function setInitiativeFocus(name, focus) {
      initiativeFocuses[name] = focus;
      try { localStorage.setItem(INITIATIVE_FOCUS_KEY, JSON.stringify(initiativeFocuses)); } catch (e) {}
    }
    function prLink(repo, number) {
      return 'https://github.com/' + repo + '/pull/' + number;
    }

    /** Build copyable prompt adapted to the current tool. */
    function buildCopyText(repo, number, kind, context) {
      if (!repo || !number) return '';
      var link = prLink(repo, number);
      var statusReminder = '\n\n**IMPORTANT**: After completing, report status to Order Up:\ncurl -X POST http://localhost:3333/api/agent-job -H "Content-Type: application/json" -d \'{"repo":"' + repo + '","number":' + number + ',"status":"complete","type":"' + kind + '","summary":"Done"}\'';
      
      var resolveReminder = '';
      if (kind === 'comments') {
        resolveReminder = '\n\n**CRITICAL**: After addressing each comment, you MUST mark it as resolved in GitHub using:\n```bash\ngh api graphql -f query=\'mutation { resolveReviewThread(input: {threadId: "THREAD_ID"}) { thread { isResolved } } }\'\n```\nGet thread IDs from: `gh api graphql -f query=\'{ repository(owner: "OWNER", name: "REPO") { pullRequest(number: ' + number + ') { reviewThreads(first: 100) { nodes { id isResolved comments(first: 1) { nodes { body } } } } } } }\'`\nJust addressing the code is NOT enough - comments must show as resolved in GitHub!';
      }

      // Cursor IDE/Web: use skill references
      if (toolSettings.tool === 'cursor-ide' || toolSettings.tool === 'cursor-web') {
        if (kind === 'comments') {
          var countText = context && context.unresolved ? ' (' + context.unresolved + ' unresolved comment' + (context.unresolved > 1 ? 's' : '') + ')' : '';
          return 'Use @handle-pr-comments for PR #' + number + countText + ': ' + link + resolveReminder + statusReminder;
        }
        var checkText = context && context.check ? ' (failing ' + context.check + ' check)' : '';
        return 'Use @handle-pr-checks for PR #' + number + checkText + ': ' + link + statusReminder;
      }

      // Claude Code / Generic: use direct prompts
      if (kind === 'comments') {
        var countText = context && context.unresolved ? ' (' + context.unresolved + ' unresolved comment' + (context.unresolved > 1 ? 's' : '') + ')' : '';
        return 'Handle PR #' + number + ' in ' + repo + countText + ': Address all unresolved review comments. Follow the workflow in skills/workflows/handle-comments.md. PR: ' + link + resolveReminder + statusReminder;
      }
      var checkText = context && context.check ? ' (failing ' + context.check + ' check)' : '';
      return 'Handle PR #' + number + ' in ' + repo + checkText + ': Fix the failing CI checks. Follow the workflow in skills/workflows/handle-checks.md. PR: ' + link + statusReminder;
    }

    /** Build comprehensive rebase/conflict resolution instructions */
    function buildRebaseCommand(repo, number, branch) {
      var instructions = '# Resolve Merge Conflicts for PR #' + number + '\n\n';
      instructions += '## Steps to resolve:\n\n';
      instructions += '1. First, fetch latest and start rebase:\n';
      instructions += '```bash\n';
      instructions += 'git fetch origin\n';
      instructions += 'git rebase origin/main\n';
      instructions += '```\n\n';
      instructions += '2. For each conflicted file:\n';
      instructions += '   - Open the file and look for conflict markers: `<<<<<<<`, `=======`, `>>>>>>>`\n';
      instructions += '   - **IMPORTANT**: Keep BOTH the existing logic AND the new changes where applicable\n';
      instructions += '   - Don\'t just pick one side - merge the intent of both changes\n';
      instructions += '   - Remove all conflict markers when done\n\n';
      instructions += '3. After resolving each file:\n';
      instructions += '```bash\n';
      instructions += 'git add <resolved-file>\n';
      instructions += 'git rebase --continue\n';
      instructions += '```\n\n';
      instructions += '4. If you get stuck or make a mistake:\n';
      instructions += '```bash\n';
      instructions += 'git rebase --abort  # Start over\n';
      instructions += '```\n\n';
      instructions += '5. After all conflicts resolved, force push (required after rebase):\n';
      instructions += '```bash\n';
      instructions += 'git push --force-with-lease\n';
      instructions += '```\n\n';
      instructions += '## Common conflict scenarios:\n';
      instructions += '- **Import conflicts**: Keep all unique imports from both sides\n';
      instructions += '- **Function changes**: Merge logic from both - don\'t lose either side\'s changes\n';
      instructions += '- **Package.json**: Keep all dependencies, resolve version conflicts to latest\n\n';
      
      if (repo && number) {
        instructions += '**IMPORTANT**: After completing, report status to Order Up:\n';
        instructions += 'curl -X POST http://localhost:3333/api/agent-job -H "Content-Type: application/json" -d \'{"repo":"' + repo + '","number":' + number + ',"status":"complete","type":"conflicts","summary":"Conflicts resolved"}\'\n';
      }
      
      return instructions;
    }

    /** Check if PR has merge conflicts */
    function hasConflicts(pr) {
      // mergeable === false is the most reliable indicator of actual conflicts
      if (pr.mergeable === false) return true;
      var status = (pr.mergeStateStatus || '').toUpperCase();
      // DIRTY = has conflicts, CONFLICTING = has conflicts
      // Note: BLOCKED means merge is blocked (checks, reviews, etc.) - NOT conflicts
      return status === 'DIRTY' || status === 'CONFLICTING';
    }

    /** Build conflicts banner HTML when PR has merge conflicts */
    function buildConflictsBanner(path, repo, number, branch) {
      return '<div class="conflicts-banner">' +
        '<button type="button" class="conflicts-banner__btn" data-resolve-conflicts data-path="' + escapeAttr(path || '') + '" data-repo="' + escapeAttr(repo || '') + '" data-number="' + (number || '') + '" data-branch="' + escapeAttr(branch || '') + '" title="Copy rebase instructions and open in Cursor">' +
        'Resolve conflicts' +
        '</button>' +
        '</div>';
    }

    function copyCommand(cmd, message) {
      if (!cmd) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(cmd).then(function() {
          showToast(message || 'Command copied!');
        }).catch(function(err) {
          console.error('Clipboard write failed:', err);
        });
      }
    }

    // Custom command modal
    function openCustomCmdModal(repo, number, path, branch) {
      // Remove existing modal if any
      var existing = document.querySelector('.cmd-modal-backdrop');
      if (existing) existing.remove();
      
      var backdrop = document.createElement('div');
      backdrop.className = 'cmd-modal-backdrop';
      backdrop.innerHTML = '<div class="cmd-modal">' +
        '<div class="cmd-modal__header">' +
          '<div>' +
            '<div class="cmd-modal__title">Send Command to Agent</div>' +
            '<div class="cmd-modal__subtitle">' + escapeHtml(repo) + ' #' + number + (branch ? ' — ' + escapeHtml(branch) : '') + '</div>' +
          '</div>' +
          '<button type="button" class="cmd-modal__close" id="cmd-modal-close"><i data-lucide="x"></i></button>' +
        '</div>' +
        '<textarea class="cmd-modal__input" id="cmd-modal-input" placeholder="Type your command for the Cursor agent...&#10;&#10;e.g. Fix the type errors in UserProfile.tsx"></textarea>' +
        '<div class="cmd-modal__actions">' +
          '<button type="button" class="cmd-modal__btn cmd-modal__btn--cancel" id="cmd-modal-cancel">Cancel</button>' +
          '<button type="button" class="cmd-modal__btn cmd-modal__btn--send" id="cmd-modal-send">Copy &amp; Open Cursor</button>' +
        '</div>' +
        '<div class="cmd-modal__hint">Your command will be wrapped with agent status tracking calls to Order Up</div>' +
      '</div>';
      
      document.body.appendChild(backdrop);
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      var input = document.getElementById('cmd-modal-input');
      input.focus();
      
      function close() { backdrop.remove(); }
      
      // Close on backdrop click
      backdrop.addEventListener('click', function(e) {
        if (e.target === backdrop) close();
      });
      document.getElementById('cmd-modal-close').addEventListener('click', close);
      document.getElementById('cmd-modal-cancel').addEventListener('click', close);
      
      // Send button
      document.getElementById('cmd-modal-send').addEventListener('click', function() {
        var userCmd = input.value.trim();
        if (!userCmd) { input.focus(); return; }
        
        // Build wrapped command with status tracking
        var cmd = userCmd + '\n\n';
        cmd += '**IMPORTANT**: Report your status to Order Up dashboard so the user can track progress.\n\n';
        cmd += 'On Start (run immediately):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/agent-job -H "Content-Type: application/json" -d \'{"repo":"' + repo + '","number":' + number + ',"status":"running","type":"all"}\'\n';
        cmd += '```\n\n';
        cmd += 'On Complete (run after finishing):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/agent-job -H "Content-Type: application/json" -d \'{"repo":"' + repo + '","number":' + number + ',"status":"complete","type":"all","summary":"Done"}\'\n';
        cmd += '```\n\n';
        cmd += 'On Failure (if you cannot complete):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/agent-job -H "Content-Type: application/json" -d \'{"repo":"' + repo + '","number":' + number + ',"status":"failed","type":"all","error":"Brief description"}\'\n';
        cmd += '```\n';
        
        // Dispatch agent
        dispatchAgent(path, cmd, { repo: repo, number: parseInt(number, 10), type: 'all', toastMessage: 'Custom command sent!' });
        
        close();
      });
      
      // Enter to send (Cmd/Ctrl+Enter)
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          document.getElementById('cmd-modal-send').click();
        }
        if (e.key === 'Escape') close();
      });
    }

    // Initiative command modal (non-PR tasks)
    function openInitiativeCmdModal(initiative, initPath) {
      var existing = document.querySelector('.cmd-modal-backdrop');
      if (existing) existing.remove();
      
      var backdrop = document.createElement('div');
      backdrop.className = 'cmd-modal-backdrop';
      backdrop.innerHTML = '<div class="cmd-modal">' +
        '<div class="cmd-modal__header">' +
          '<div>' +
            '<div class="cmd-modal__title">Send Command to Agent</div>' +
            '<div class="cmd-modal__subtitle">' + escapeHtml(initiative) + ' (no PR)</div>' +
          '</div>' +
          '<button type="button" class="cmd-modal__close" id="cmd-modal-close"><i data-lucide="x"></i></button>' +
        '</div>' +
        '<textarea class="cmd-modal__input" id="cmd-modal-input" placeholder="Type your command for the Cursor agent...&#10;&#10;e.g. Set up the project structure for the new feature"></textarea>' +
        '<div class="cmd-modal__actions">' +
          '<button type="button" class="cmd-modal__btn cmd-modal__btn--cancel" id="cmd-modal-cancel">Cancel</button>' +
          '<button type="button" class="cmd-modal__btn cmd-modal__btn--send" id="cmd-modal-send">Copy &amp; Open Cursor</button>' +
        '</div>' +
        '<div class="cmd-modal__hint">Your command will be wrapped with agent status tracking calls to Order Up</div>' +
      '</div>';
      
      document.body.appendChild(backdrop);
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      var input = document.getElementById('cmd-modal-input');
      input.focus();
      
      function close() { backdrop.remove(); }
      backdrop.addEventListener('click', function(e) { if (e.target === backdrop) close(); });
      document.getElementById('cmd-modal-close').addEventListener('click', close);
      document.getElementById('cmd-modal-cancel').addEventListener('click', close);
      
      document.getElementById('cmd-modal-send').addEventListener('click', function() {
        var userCmd = input.value.trim();
        if (!userCmd) { input.focus(); return; }
        
        var taskId = initiative + '-' + Date.now();
        
        var cmd = userCmd + '\n\n';
        cmd += '**IMPORTANT**: Report your status to Order Up dashboard so the user can track progress.\n\n';
        cmd += 'On Start (run immediately):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + taskId + '","initiative":"' + initiative + '","path":"' + (initPath || '') + '","command":"' + userCmd.replace(/'/g, "\\'").replace(/"/g, '\\"').slice(0, 100) + '","status":"running"}\'\n';
        cmd += '```\n\n';
        cmd += 'On Complete (run after finishing):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + taskId + '","status":"complete","summary":"Done"}\'\n';
        cmd += '```\n\n';
        cmd += 'On Failure (if you cannot complete):\n';
        cmd += '```bash\n';
        cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + taskId + '","status":"failed","error":"Brief description"}\'\n';
        cmd += '```\n';
        
        // Create pending task locally and on server
        initiativeTasks[taskId] = {
          id: taskId,
          initiative: initiative,
          path: initPath || '',
          command: userCmd,
          status: 'pending',
          startedAt: Date.now()
        };
        fetch('/api/initiative-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: taskId, initiative: initiative, path: initPath || '', command: userCmd, status: 'pending' })
        }).catch(function() {});
        renderPrepWorkTable();
        
        dispatchAgent(initPath, cmd, { taskId: taskId, toastMessage: 'Initiative command sent!' });
        close();
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          document.getElementById('cmd-modal-send').click();
        }
        if (e.key === 'Escape') close();
      });
    }

    var toastTimeout = null;
    function showToast(message) {
      var toast = document.getElementById('toast');
      var toastMsg = document.getElementById('toast-message');
      if (!toast || !toastMsg) return;
      toastMsg.textContent = message || 'Copied!';
      if (toastTimeout) clearTimeout(toastTimeout);
      toast.classList.add('show');
      toastTimeout = setTimeout(function() {
        toast.classList.remove('show');
      }, 2000);
    }

    function copyToClipboard(text, message) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          showToast(message || 'Copied to clipboard!');
        }).catch(function() {});
      }
    }

    function checkCell(status, path, repo, number, category) {
      var title = category === 'lint' ? 'Lint' : category === 'type' ? 'Type' : category === 'test' ? 'Test' : category === 'e2e' ? 'E2E' : 'Other';
      if (status === 'success') return '<span class="check-icon pass" title="Pass"><i data-lucide="chef-hat"></i></span>';
      if (status === 'failure' && repo != null && number != null) {
        var fixUrl = (path && path.trim()) ? (toolLink(path) || '#') : '#';
        return '<a href="' + fixUrl + '" class="check-icon fail fix-check" data-path="' + escapeAttr(path || '') + '" data-repo="' + escapeHtml(repo) + '" data-number="' + number + '" data-check="' + escapeHtml(category) + '" title="Fix ' + title + '"><i data-lucide="skull"></i></a>';
      }
      if (status === 'failure') return '<span class="check-icon fail" title="Fail"><i data-lucide="skull"></i></span>';
      if (status === 'pending') return '<span class="check-icon pending" title="Pending"><i data-lucide="flame"></i></span>';
      return '<span class="check-icon none" title="None">—</span>';
    }
    function previewDeployDot(state) {
      if (!state) return '';
      var cls = 'preview-deploy-dot preview-deploy-dot--' + state;
      var label = state.charAt(0).toUpperCase() + state.slice(1);
      return '<span class="' + cls + '" title="' + label + '"></span>';
    }
    function previewLinks(p, deployStatus) {
      if (!p || (!p.viewer && !p.creator && !p.storybook)) return '<span class="check-icon none">—</span>';
      var ds = deployStatus || {};
      var parts = [];
      if (p.viewer) parts.push('<a href="' + escapeUri(p.viewer) + '" class="preview-link preview-link--' + (ds.viewer || 'none') + '" target="_blank" rel="noopener" title="Viewer' + (ds.viewer ? ' (' + ds.viewer + ')' : '') + '">' + previewDeployDot(ds.viewer) + 'Viewer</a>');
      if (p.creator) parts.push('<a href="' + escapeUri(p.creator) + '" class="preview-link preview-link--' + (ds.creator || 'none') + '" target="_blank" rel="noopener" title="Creator' + (ds.creator ? ' (' + ds.creator + ')' : '') + '">' + previewDeployDot(ds.creator) + 'Creator</a>');
      if (p.storybook) parts.push('<a href="' + escapeUri(p.storybook) + '" class="preview-link preview-link--' + (ds.storybook || 'none') + '" target="_blank" rel="noopener" title="Storybook' + (ds.storybook ? ' (' + ds.storybook + ')' : '') + '">' + previewDeployDot(ds.storybook) + 'Storybook</a>');
      return '<div class="preview-links">' + parts.join('') + '</div>';
    }
    function mergeCell(mergeable, mergeStateStatus) {
      if (mergeable === true) return '<span class="check-icon pass" title="No conflicts"><i data-lucide="chef-hat"></i></span>';
      if (mergeable === false) return '<span class="check-icon fail" title="Has conflicts – resolve before merge"><i data-lucide="skull"></i></span>';
      var status = (mergeStateStatus || '').toUpperCase();
      if (status === 'DIRTY' || status === 'CONFLICTING' || status === 'BLOCKED') {
        return '<span class="check-icon fail" title="' + escapeAttr(mergeStateStatus || 'Has conflicts') + ' – resolve before merge"><i data-lucide="skull"></i></span>';
      }
      var tip = (mergeStateStatus && status !== 'CLEAN') ? escapeAttr(mergeStateStatus) : 'Unknown';
      return '<span class="check-icon none" title="' + tip + '">—</span>';
    }
    function initiativeIconHtml(name, cacheBust) {
      if (!name || name === '—') return '';
      var src = '/images/initiatives/' + escapeAttr(name) + '.png';
      if (cacheBust) src += '?_t=' + Number(cacheBust);
      return '<img src="' + src + '" alt="" class="initiative-icon" />';
    }
    function getPlatformIcon(repo) {
      var repoLower = (repo || '').toLowerCase();
      if (repoLower.includes('-ios') || repoLower.includes('ios')) {
        return { icon: 'apple', color: '#a1a1aa', label: 'iOS' };
      }
      if (repoLower.includes('-android') || repoLower.includes('android')) {
        return { icon: 'smartphone', color: '#22c55e', label: 'Android' };
      }
      if (repoLower.includes('backend') || repoLower.includes('api') || repoLower.includes('server')) {
        return { icon: 'server', color: '#f97316', label: 'Backend' };
      }
      // Default to web for nugs, frontend, web, etc.
      return { icon: 'globe', color: '#60a5fa', label: 'Web' };
    }
    function getPlatformSortOrder(repo) {
      var repoLower = (repo || '').toLowerCase();
      // Order: nugs/web (0), backend (1), ios (2), android (3)
      if (repoLower.includes('nugs') || repoLower.includes('web') || repoLower.includes('frontend')) {
        return 0;
      }
      if (repoLower.includes('backend') || repoLower.includes('api') || repoLower.includes('server')) {
        return 1;
      }
      if (repoLower.includes('-ios') || repoLower.includes('ios')) {
        return 2;
      }
      if (repoLower.includes('-android') || repoLower.includes('android')) {
        return 3;
      }
      return 4; // Other/unknown goes last
    }
    function sortPrsByPlatform(prs) {
      return prs.slice().sort(function(a, b) {
        return getPlatformSortOrder(a.repo) - getPlatformSortOrder(b.repo);
      });
    }
    function formatRepoName(repo) {
      // Strip org prefix like "FrontRowXP/"
      return (repo || '').replace(/^[^\/]+\//, '');
    }
    // Look up the initiative path for a given repo+number from cached data
    function lookupInitiativePath(repo, number) {
      var num = parseInt(number, 10);
      for (var i = 0; i < _cachedInitiatives.length; i++) {
        var init = _cachedInitiatives[i];
        var prs = init.prs || [];
        for (var j = 0; j < prs.length; j++) {
          if (prs[j].repo === repo && prs[j].number === num) {
            return prs[j].initiativePath || init.path || '';
          }
        }
      }
      return '';
    }
    // Global list of available initiatives for the picker dropdown
    var availableInitiativeNames = [];
    
    // Global agent jobs state - tracks running/completed agent jobs per PR
    var agentJobs = {};
    var initiativeTasks = {}; // { id: task }
    var canDispatchAgent = false; // set by /api/capabilities on load
    var toolSettings = { tool: 'cursor-ide', agentCommand: null }; // set by /api/settings on load

    // --- Chat Panel State ---
    var chatPanelOpen = false;
    var chatActiveSessionId = null;   // currently displayed session ID
    var chatSessionMessages = {};     // sessionId -> [messages]
    var chatSessionMeta = {};         // sessionId -> { repo, number, status, label, ... }
    var chatPanelPrContext = null;    // { repo, number, path, branch } for the PR the panel is open for
    var chatAssistantEl = null;       // reference to the current streaming assistant text element
    var chatThinkingEl = null;        // reference to the current thinking indicator element
    var chatAutoScroll = true;

    // Chat panel DOM references (available after DOMContentLoaded, but since script is at bottom, OK)
    var chatPanel = document.getElementById('chat-panel');
    var chatBackdrop = document.getElementById('chat-panel-backdrop');
    var chatPanelTitle = document.getElementById('chat-panel-title');
    var chatPanelStatus = document.getElementById('chat-panel-status');
    var chatPanelMessages = document.getElementById('chat-panel-messages');
    var chatPanelCancel = document.getElementById('chat-panel-cancel');
    var chatPanelClose = document.getElementById('chat-panel-close');
    var chatSidebarIcon = document.getElementById('chat-sidebar-icon');
    var chatSidebarTitle = document.getElementById('chat-sidebar-title');
    var chatSidebarSessions = document.getElementById('chat-sidebar-sessions');
    var chatSidebarNewBtn = document.getElementById('chat-sidebar-new');
    var chatModalInitiative = null; // current initiative name the modal is scoped to
    var chatPanelInputArea = document.getElementById('chat-panel-input-area');
    var chatPanelInput = document.getElementById('chat-panel-input');
    var chatPanelSend = document.getElementById('chat-panel-send');
    var chatPanelAttach = document.getElementById('chat-panel-attach');
    var chatPanelFileInput = document.getElementById('chat-panel-file-input');
    var chatPanelAttachments = document.getElementById('chat-panel-attachments');
    var chatPendingImages = []; // Array of { dataUrl, serverPath, filename, uploading }

    // Open the chat modal. Can be called with initiative name, PR context, or session ID.
    function openChatModal(initiativeName, focusPr, focusSessionId) {
      chatModalInitiative = initiativeName || null;
      chatPanelOpen = true;
      chatPanel.classList.add('open');
      chatBackdrop.classList.add('open');

      // Update sidebar header
      if (initiativeName) {
        chatSidebarIcon.innerHTML = initiativeIconHtml(initiativeName);
        chatSidebarTitle.textContent = initiativeName;
      } else {
        chatSidebarIcon.innerHTML = '';
        chatSidebarTitle.textContent = 'Sessions';
      }

      // If we have a focus session, use it directly
      if (focusSessionId && chatSessionMeta[focusSessionId]) {
        var meta = chatSessionMeta[focusSessionId];
        if (meta.repo && meta.number) {
          chatPanelPrContext = { repo: meta.repo, number: String(meta.number), path: meta.path || lookupInitiativePath(meta.repo, meta.number) };
        }
        switchChatSession(focusSessionId);
        renderSidebar();
        return;
      }

      // If we have a PR context, find or prompt
      if (focusPr) {
        var prContext = focusPr;
        chatPanelPrContext = prContext;
        var existingSessionId = findSessionForPr(prContext);
        if (existingSessionId) {
          switchChatSession(existingSessionId);
          renderSidebar();
        } else {
          fetchAndSyncSessions(function() {
            var serverSessionId = findSessionForPr(prContext);
            if (serverSessionId) {
              switchChatSession(serverSessionId);
            } else {
              showChatQuickActions(prContext);
            }
            renderSidebar();
          });
        }
      } else {
        // No specific PR — show quick actions or first session
        fetchAndSyncSessions(function() {
          var firstSession = findFirstSessionForInitiative(initiativeName);
          if (firstSession) {
            var m = chatSessionMeta[firstSession];
            chatPanelPrContext = { repo: m.repo, number: String(m.number), path: m.path || lookupInitiativePath(m.repo, m.number) };
            switchChatSession(firstSession);
          } else {
            // Find first PR for this initiative and show quick actions
            var firstPr = findFirstPrForInitiative(initiativeName);
            if (firstPr) {
              chatPanelPrContext = firstPr;
              showChatQuickActions(firstPr);
            } else {
              chatPanelPrContext = null;
              showChatQuickActions(null);
            }
          }
          renderSidebar();
        });
      }
      renderSidebar();
    }

    // Backward compat wrapper
    function openChatPanel(prContext) {
      // Find initiative for this PR
      var initName = lookupInitiativeForPr(prContext);
      openChatModal(initName, prContext, null);
    }

    // Find the initiative name for a given PR
    function lookupInitiativeForPr(prContext) {
      if (!prContext || !prContext.repo || !prContext.number) return null;
      var num = parseInt(prContext.number, 10);
      for (var i = 0; i < _cachedInitiatives.length; i++) {
        var init = _cachedInitiatives[i];
        var prs = init.prs || [];
        for (var j = 0; j < prs.length; j++) {
          if (prs[j].repo === prContext.repo && prs[j].number === num) {
            return init.name;
          }
        }
      }
      return null;
    }

    // Find first (most recent) session for an initiative
    function findFirstSessionForInitiative(initName) {
      if (!initName) return null;
      var initPrs = getInitiativePrs(initName);
      var bestSid = null;
      var bestTime = 0;
      for (var sid in chatSessionMeta) {
        var m = chatSessionMeta[sid];
        if (!m || !m.repo) continue;
        for (var p = 0; p < initPrs.length; p++) {
          if (m.repo === initPrs[p].repo && parseInt(m.number, 10) === initPrs[p].number) {
            var t = m.startedAt || 0;
            if (t >= bestTime) { bestSid = sid; bestTime = t; }
          }
        }
      }
      return bestSid;
    }

    // Get PRs for an initiative from cached data
    function getInitiativePrs(initName) {
      if (!initName) return [];
      for (var i = 0; i < _cachedInitiatives.length; i++) {
        if (_cachedInitiatives[i].name === initName) {
          return (_cachedInitiatives[i].prs || []).filter(function(pr) {
            var branch = (pr.branch || '').toLowerCase();
            return branch !== 'main' && branch !== 'master';
          });
        }
      }
      return [];
    }

    // Find first PR for an initiative
    function findFirstPrForInitiative(initName) {
      var prs = getInitiativePrs(initName);
      if (prs.length === 0) return null;
      var pr = prs[0];
      return { repo: pr.repo, number: String(pr.number), path: pr.initiativePath || '' };
    }

    function findSessionForPr(prContext) {
      if (!prContext || !prContext.repo || !prContext.number) return null;
      var targetNum = parseInt(prContext.number, 10);
      // Find the most recent session for this PR
      var bestSid = null;
      var bestTime = 0;
      for (var sid in chatSessionMeta) {
        var m = chatSessionMeta[sid];
        if (m && m.repo === prContext.repo && parseInt(m.number, 10) === targetNum) {
          var t = m.startedAt || 0;
          if (t >= bestTime) { bestSid = sid; bestTime = t; }
        }
      }
      return bestSid;
    }

    function fetchAndSyncSessions(callback) {
      fetch('/api/agent-sessions')
        .then(function(r) { return r.json(); })
        .then(function(sessions) {
          if (!Array.isArray(sessions)) return;
          for (var i = 0; i < sessions.length; i++) {
            var s = sessions[i];
            if (!chatSessionMeta[s.id]) {
              chatSessionMeta[s.id] = {
                repo: s.repo,
                number: s.number,
                status: s.status,
                label: s.label || s.id,
                startedAt: s.startedAt,
                completedAt: s.completedAt,
                cursorChatId: s.cursorChatId
              };
            } else {
              // Update status and cursorChatId
              chatSessionMeta[s.id].status = s.status;
              if (s.cursorChatId) chatSessionMeta[s.id].cursorChatId = s.cursorChatId;
            }
            if (!chatSessionMessages[s.id]) {
              chatSessionMessages[s.id] = [];
            }
          }
          renderSidebar();
          if (callback) callback();
        })
        .catch(function() {
          if (callback) callback();
        });
    }

    // Render the session sidebar based on current initiative
    function renderSidebar() {
      if (!chatSidebarSessions) return;
      var initName = chatModalInitiative;
      var initPrs = initName ? getInitiativePrs(initName) : [];

      // If no initiative, gather all PRs with sessions
      if (!initName) {
        var prSet = {};
        for (var sid in chatSessionMeta) {
          var sm = chatSessionMeta[sid];
          if (sm && sm.repo && sm.number) {
            var key = sm.repo + '#' + sm.number;
            if (!prSet[key]) prSet[key] = { repo: sm.repo, number: sm.number };
          }
        }
        initPrs = Object.values(prSet);
      }

      var html = '';
      for (var p = 0; p < initPrs.length; p++) {
        var pr = initPrs[p];
        var prNum = parseInt(pr.number, 10);
        // Gather sessions for this PR
        var prSessions = [];
        for (var sid2 in chatSessionMeta) {
          var m = chatSessionMeta[sid2];
          if (m && m.repo === pr.repo && parseInt(m.number, 10) === prNum) {
            prSessions.push({ id: sid2, meta: m });
          }
        }
        // Sort by startedAt descending (most recent first)
        prSessions.sort(function(a, b) { return (b.meta.startedAt || 0) - (a.meta.startedAt || 0); });

        // PR group header
        var platform = getPlatformIcon(pr.repo);
        html += '<div class="chat-sidebar__pr-group">';
        html += '<div class="chat-sidebar__pr-label">';
        html += '<span style="color:' + platform.color + ';"><i data-lucide="' + platform.icon + '"></i></span> ';
        html += escapeHtml(formatRepoName(pr.repo)) + ' #' + prNum;
        html += '</div>';

        if (prSessions.length === 0) {
          html += '<div class="chat-sidebar__empty" style="padding:0.3rem 0.85rem;font-size:0.6875rem;">No sessions</div>';
        } else {
          for (var s = 0; s < prSessions.length; s++) {
            var sess = prSessions[s];
            var isActive = sess.id === chatActiveSessionId;
            var dotClass = 'chat-sidebar__session-dot chat-sidebar__session-dot--' + (sess.meta.status || 'complete');
            var timeStr = sess.meta.startedAt ? timeAgo(sess.meta.startedAt) : '';
            var sessLabel = sess.meta.label || 'Session';
            // Strip "Custom: repo #num" prefix for cleaner display
            sessLabel = sessLabel.replace(/^Custom:\s*/i, '').replace(/^(checks|comments|conflicts|all):\s*/i, '');
            if (sessLabel.length > 35) sessLabel = sessLabel.slice(0, 35) + '...';
            html += '<button class="chat-sidebar__session' + (isActive ? ' active' : '') + '" data-session-id="' + escapeAttr(sess.id) + '">';
            html += '<span class="' + dotClass + '"></span>';
            html += '<span class="chat-sidebar__session-label">' + escapeHtml(sessLabel) + '</span>';
            html += '<span class="chat-sidebar__session-time">' + escapeHtml(timeStr) + '</span>';
            html += '</button>';
          }
        }
        html += '</div>';
      }

      if (!html) {
        html = '<div class="chat-sidebar__empty">No agent sessions yet. Start a new chat to begin.</div>';
      }

      chatSidebarSessions.innerHTML = html;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Simple time-ago helper
    function timeAgo(timestamp) {
      var diff = Date.now() - timestamp;
      if (diff < 60000) return 'now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
      return Math.floor(diff / 86400000) + 'd';
    }

    function closeChatPanel() {
      chatPanelOpen = false;
      chatPanel.classList.remove('open');
      chatBackdrop.classList.remove('open');
      chatAssistantEl = null;
    }

    function showChatQuickActions(prContext) {
      chatActiveSessionId = null;
      chatAssistantEl = null;
      chatPanelInputArea.classList.add('visible');
      chatPanelCancel.style.display = 'none';
      chatPanelStatus.style.display = 'none';

      var label = 'Agent Chat';
      if (prContext && prContext.repo && prContext.number) {
        label = formatRepoName(prContext.repo) + ' #' + prContext.number;
      }
      chatPanelTitle.innerHTML = escapeHtml(label);

      var html = '<div class="chat-panel__actions">';
      html += '<div class="chat-panel__actions-title">What would you like to do?</div>';
      if (prContext && prContext.repo) {
        html += '<button class="chat-panel__action-btn" data-chat-action="checks"><i data-lucide="shield-check"></i> Fix Failing Checks</button>';
        html += '<button class="chat-panel__action-btn" data-chat-action="comments"><i data-lucide="message-square"></i> Handle PR Comments</button>';
        html += '<button class="chat-panel__action-btn" data-chat-action="conflicts"><i data-lucide="git-merge"></i> Resolve Conflicts</button>';
      }
      html += '<button class="chat-panel__action-btn chat-panel__action-btn--custom" data-chat-action="custom"><i data-lucide="terminal"></i> Custom Prompt</button>';
      html += '</div>';
      chatPanelMessages.innerHTML = html;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function switchChatSession(sessionId) {
      chatActiveSessionId = sessionId;
      chatAssistantEl = null;
      chatThinkingEl = null;
      var meta = chatSessionMeta[sessionId];

      // Update header — show session type/label as title, PR context in dropdown
      var label = (meta && meta.label) ? meta.label : 'Chat';
      chatPanelTitle.innerHTML = escapeHtml(label);
      if (meta && meta.repo && meta.number) {
        var sessionPath = meta.path || '';
        // If no path stored, try to find it from cached initiatives
        if (!sessionPath) {
          sessionPath = lookupInitiativePath(meta.repo, meta.number) || '';
        }
        chatPanelPrContext = { repo: meta.repo, number: String(meta.number), path: sessionPath };
      }
      updateChatPanelStatusBadge(meta ? meta.status : 'running');

      // Always show cancel when running, always show input area
      if (meta && meta.status === 'running') {
        chatPanelCancel.style.display = '';
      } else {
        chatPanelCancel.style.display = 'none';
      }
      chatPanelInputArea.classList.add('visible');

      // Build the conversation chain (oldest first)
      var chain = getSessionChain(sessionId);

      // Render the full conversation
      chatPanelMessages.innerHTML = '';

      // Render previous turns as collapsed blocks
      for (var c = 0; c < chain.length - 1; c++) {
        renderCollapsedTurn(chain[c], c + 1);
      }

      // Divider before current turn if there's history
      if (chain.length > 1) {
        var divider = document.createElement('div');
        divider.className = 'chat-history-divider';
        divider.textContent = 'Current';
        chatPanelMessages.appendChild(divider);
      }

      // Render current session messages
      var msgs = chatSessionMessages[sessionId] || [];
      for (var i = 0; i < msgs.length; i++) {
        appendChatMessage(msgs[i], true);
      }
      scrollChatToBottom();
      renderSidebar();

      // Also fetch from server to catch up on any messages we missed
      fetchSessionMessages(sessionId, msgs.length);
    }

    // Walk the _prevSessionId chain and return [oldest, ..., newest]
    function getSessionChain(sessionId) {
      var chain = [];
      var sid = sessionId;
      var visited = {};
      while (sid && !visited[sid]) {
        visited[sid] = true;
        chain.unshift(sid); // prepend so oldest is first
        var m = chatSessionMeta[sid];
        sid = m ? m._prevSessionId : null;
      }
      return chain;
    }

    // Extract a clean prompt text from a session's messages (the 'user' type message)
    function getSessionPromptText(sessionId) {
      var msgs = chatSessionMessages[sessionId] || [];
      for (var i = 0; i < msgs.length; i++) {
        if (msgs[i].type === 'user') {
          var raw = msgs[i].raw || {};
          if (raw.message && raw.message.content) {
            var arr = Array.isArray(raw.message.content) ? raw.message.content : [raw.message.content];
            for (var j = 0; j < arr.length; j++) {
              if (typeof arr[j] === 'string') return arr[j];
              if (arr[j] && arr[j].text) return arr[j].text;
            }
          }
        }
      }
      // Fallback to the session's stored prompt
      var meta = chatSessionMeta[sessionId];
      return (meta && meta._promptText) || '';
    }

    // Get the final assistant response text from a session
    function getSessionResponseSummary(sessionId) {
      var msgs = chatSessionMessages[sessionId] || [];
      var lastAssistant = '';
      for (var i = 0; i < msgs.length; i++) {
        if (msgs[i].type === 'assistant') {
          var raw = msgs[i].raw || {};
          // Only take non-partial (final) messages
          if (!raw.timestamp_ms && raw.message && raw.message.content) {
            var arr = Array.isArray(raw.message.content) ? raw.message.content : [raw.message.content];
            for (var j = 0; j < arr.length; j++) {
              if (typeof arr[j] === 'string') lastAssistant = arr[j];
              else if (arr[j] && arr[j].text) lastAssistant = arr[j].text;
            }
          }
        }
      }
      if (lastAssistant.length > 80) return lastAssistant.slice(0, 80) + '...';
      return lastAssistant;
    }

    // Render a collapsed conversation turn
    function renderCollapsedTurn(sid, turnNumber) {
      var promptText = getSessionPromptText(sid);
      // Strip image attachment paths from display
      var cleanPrompt = promptText.replace(/\n\n\[Attached images?:[\s\S]*?\]/g, '').trim();
      var hasImages = /\[Attached images?:/.test(promptText);
      var responseSummary = getSessionResponseSummary(sid);
      var turnMeta = chatSessionMeta[sid];

      var wrapper = document.createElement('div');
      wrapper.className = 'chat-history-turn';
      wrapper.setAttribute('data-session-id', sid);

      var header = document.createElement('div');
      header.className = 'chat-history-turn__header';
      header.addEventListener('click', function() {
        wrapper.classList.toggle('expanded');
      });

      var promptSpan = document.createElement('span');
      promptSpan.className = 'chat-history-turn__prompt';
      var displayPrompt = cleanPrompt.length > 60 ? cleanPrompt.slice(0, 60) + '...' : cleanPrompt;
      promptSpan.innerHTML = escapeHtml(displayPrompt || 'Turn ' + turnNumber);
      if (hasImages) {
        promptSpan.innerHTML += ' <i data-lucide="image" style="width:12px;height:12px;display:inline;vertical-align:middle;color:var(--text-dim)"></i>';
      }

      var summary = document.createElement('span');
      summary.className = 'chat-history-turn__summary';
      summary.textContent = responseSummary ? responseSummary.slice(0, 40) + (responseSummary.length > 40 ? '...' : '') : (turnMeta && turnMeta.status) || '';

      var chevron = document.createElement('span');
      chevron.className = 'chat-history-turn__chevron';
      chevron.innerHTML = '<i data-lucide="chevron-right"></i>';

      header.appendChild(promptSpan);
      header.appendChild(summary);
      header.appendChild(chevron);
      wrapper.appendChild(header);

      // Body: render messages lazily on first expand
      var body = document.createElement('div');
      body.className = 'chat-history-turn__body';
      body.setAttribute('data-rendered', 'false');
      wrapper.appendChild(body);

      // Lazy render on first expand
      header.addEventListener('click', function() {
        if (body.getAttribute('data-rendered') === 'false') {
          body.setAttribute('data-rendered', 'true');
          renderTurnBody(body, sid);
        }
      });

      chatPanelMessages.appendChild(wrapper);
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Render messages for a collapsed turn's body
    function renderTurnBody(container, sid) {
      var msgs = chatSessionMessages[sid] || [];
      var tempAssistant = null;
      var tempThinking = null;

      for (var i = 0; i < msgs.length; i++) {
        var msg = msgs[i];
        var raw = msg.raw || {};
        var el = null;

        if (msg.type === 'user' || msg.type === 'thinking') {
          // Skip user (shown in header) and thinking deltas
          if (msg.type === 'thinking' && msg.subtype === 'delta') continue;
          if (msg.type === 'user') continue;
          // Final thinking — show collapsed
          var thinkText = raw.text || '';
          if (!thinkText) continue;
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--thinking';
          el.innerHTML = '<div class="thinking-label" onclick="this.parentNode.classList.toggle(\'expanded\')">' +
            '<i data-lucide="brain"></i> <span>Thought</span>' +
            '<span class="thinking-chevron"><i data-lucide="chevron-right"></i></span></div>' +
            '<div class="thinking-body">' + escapeHtml(thinkText.length > 1000 ? thinkText.slice(0, 1000) + '...' : thinkText) + '</div>';

        } else if (msg.type === 'assistant') {
          var content = '';
          if (raw.message && raw.message.content) {
            var arr = Array.isArray(raw.message.content) ? raw.message.content : [raw.message.content];
            for (var j = 0; j < arr.length; j++) {
              if (typeof arr[j] === 'string') content += arr[j];
              else if (arr[j] && arr[j].text) content += arr[j].text;
            }
          }
          if (!content) continue;
          // Only show final messages
          if (raw.timestamp_ms) continue;
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--assistant';
          el.innerHTML = formatChatText(content);

        } else if (msg.type === 'tool_call') {
          var commitInfo = detectGitCommit(raw);
          if (commitInfo && msg.subtype === 'completed') {
            el = document.createElement('div');
            el.className = 'chat-msg chat-msg--commit';
            el.innerHTML = '<i data-lucide="git-commit"></i><div class="chat-msg--commit-body">' +
              '<div class="chat-msg--commit-msg">' + escapeHtml(commitInfo.message) + '</div>' +
              '<div class="chat-msg--commit-meta">' +
              (commitInfo.sha ? '<span class="chat-msg--commit-sha">' + commitInfo.sha + '</span> ' : '') +
              (commitInfo.files ? commitInfo.files + ' files changed' : '') +
              '</div></div>';
          } else {
            el = document.createElement('div');
            el.className = 'chat-msg chat-msg--tool';
            var toolName = getToolName(raw);
            var isCompleted = msg.subtype === 'completed';
            var statusIcon = isCompleted ? 'check-circle' : 'play';
            el.innerHTML = '<div class="chat-msg--tool-header" onclick="this.classList.toggle(\'expanded\');this.nextElementSibling.classList.toggle(\'expanded\')">' +
              '<i data-lucide="' + statusIcon + '"></i> ' + escapeHtml(toolName) +
              '<span class="tool-chevron"><i data-lucide="chevron-right"></i></span></div>' +
              '<div class="chat-msg--tool-body">' + escapeHtml(getToolDetail(raw)) + '</div>';
          }

        } else if (msg.type === 'result') {
          var dur = raw.duration_ms ? (raw.duration_ms / 1000).toFixed(1) + 's' : '';
          var isSuccess = raw.subtype !== 'error';
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--result ' + (isSuccess ? 'success' : 'failed');
          el.innerHTML = '<i data-lucide="' + (isSuccess ? 'check-circle' : 'alert-circle') + '"></i> ' +
            (isSuccess ? 'Completed' : 'Failed') + (dur ? ' in ' + dur : '');
        }

        if (el) container.appendChild(el);
      }

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Fetch session messages from server (reusable)
    function fetchSessionMessages(sessionId, localCount) {
      fetch('/api/agent-session/' + encodeURIComponent(sessionId))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data || !data.messages) return;
          // Update meta from server
          if (data.status) {
            if (!chatSessionMeta[sessionId]) chatSessionMeta[sessionId] = {};
            chatSessionMeta[sessionId].status = data.status;
            if (data.cursorChatId) chatSessionMeta[sessionId].cursorChatId = data.cursorChatId;
            if (chatActiveSessionId === sessionId) {
              updateChatPanelStatusBadge(data.status);
              if (data.status !== 'running') {
                chatPanelCancel.style.display = 'none';
              }
            }
          }
          // Replace local buffer with server's full buffer if server has more
          var serverMsgs = data.messages || [];
          if (serverMsgs.length > (localCount || 0)) {
            chatSessionMessages[sessionId] = serverMsgs;
            // Re-render current session messages only (not collapsed history)
            if (chatActiveSessionId === sessionId) {
              // Remove everything after the last .chat-history-divider (or from start if none)
              var divider = chatPanelMessages.querySelector('.chat-history-divider');
              var startNode = divider ? divider.nextSibling : chatPanelMessages.firstChild;
              // Remove old current-session messages
              while (startNode && startNode !== chatPanelMessages.lastChild) {
                var next = startNode.nextSibling;
                if (startNode !== divider) chatPanelMessages.removeChild(startNode);
                startNode = next;
              }
              if (startNode && startNode !== divider) chatPanelMessages.removeChild(startNode);

              // Re-render
              chatAssistantEl = null;
              chatThinkingEl = null;
              for (var j = 0; j < serverMsgs.length; j++) {
                appendChatMessage(serverMsgs[j], true);
              }
              scrollChatToBottom();
            }
          }
        })
        .catch(function(err) {
          console.error('Failed to fetch session:', err);
        });
    }

    function updateChatPanelStatusBadge(status) {
      if (!status || status === 'pending') {
        chatPanelStatus.style.display = 'none';
        return;
      }
      chatPanelStatus.style.display = '';
      chatPanelStatus.className = 'chat-panel__status chat-panel__status--' + status;
      var icon = 'loader-2';
      var text = status;
      if (status === 'running') { icon = 'loader-2'; text = 'Running'; }
      else if (status === 'complete') { icon = 'check-circle'; text = 'Complete'; }
      else if (status === 'failed') { icon = 'alert-circle'; text = 'Failed'; }
      else if (status === 'cancelled') { icon = 'ban'; text = 'Cancelled'; }
      chatPanelStatus.innerHTML = '<i data-lucide="' + icon + '"></i> ' + escapeHtml(text);
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // (Old PR switcher dropdown removed — replaced by renderSidebar above)

    function appendChatMessage(msg, skipScroll) {
      var el = null;
      var raw = msg.raw || {};

      if (msg.type === 'user') {
        // User prompt message from the CLI stream — skip rendering since we show it as prompt
        return;

      } else if (msg.type === 'thinking') {
        // Thinking messages — show a subtle collapsible indicator
        var thinkText = raw.text || '';
        var isPartial = msg.subtype === 'delta';

        if (skipScroll) {
          // Re-rendering from buffer: skip deltas, only show final thinking
          if (isPartial) return;
          if (!thinkText) return;
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--thinking';
          el.setAttribute('data-think-text', thinkText);
          el.innerHTML = '<div class="thinking-label" onclick="this.parentNode.classList.toggle(\'expanded\')">' +
            '<i data-lucide="brain"></i> <span>Thought for a moment</span>' +
            '<span class="thinking-chevron"><i data-lucide="chevron-right"></i></span>' +
            '</div>' +
            '<div class="thinking-body">' + escapeHtml(thinkText.length > 2000 ? thinkText.slice(0, 2000) + '...' : thinkText) + '</div>';
          chatThinkingEl = null;
        } else {
          // Live streaming
          if (isPartial) {
            if (chatThinkingEl && chatThinkingEl.parentNode) {
              // Accumulate thinking text silently
              var cur = chatThinkingEl.getAttribute('data-think-text') || '';
              cur += thinkText;
              chatThinkingEl.setAttribute('data-think-text', cur);
            } else {
              // Create thinking indicator
              el = document.createElement('div');
              el.className = 'chat-msg chat-msg--thinking active';
              el.setAttribute('data-think-text', thinkText);
              el.innerHTML = '<div class="thinking-label">' +
                '<i data-lucide="brain"></i> <span>Thinking<span class="thinking-dots"></span></span>' +
                '</div>';
              chatThinkingEl = el;
            }
          } else {
            // Final thinking message — finalize the indicator
            if (chatThinkingEl && chatThinkingEl.parentNode) {
              var fullThink = chatThinkingEl.getAttribute('data-think-text') || thinkText || '';
              chatThinkingEl.classList.remove('active');
              chatThinkingEl.setAttribute('data-think-text', fullThink);
              chatThinkingEl.innerHTML = '<div class="thinking-label" onclick="this.parentNode.classList.toggle(\'expanded\')">' +
                '<i data-lucide="brain"></i> <span>Thought for a moment</span>' +
                '<span class="thinking-chevron"><i data-lucide="chevron-right"></i></span>' +
                '</div>' +
                '<div class="thinking-body">' + escapeHtml(fullThink.length > 2000 ? fullThink.slice(0, 2000) + '...' : fullThink) + '</div>';
              if (typeof lucide !== 'undefined') lucide.createIcons();
              chatThinkingEl = null;
            }
          }
        }
        // Don't scroll for every thinking delta
        if (isPartial) return;

      } else if (msg.type === 'system') {
        // Close thinking if active
        closeThinking();
        el = document.createElement('div');
        el.className = 'chat-msg chat-msg--system';
        var sysText = '';
        if (msg.subtype === 'init' && raw.model) {
          sysText = 'Model: ' + (raw.model || 'unknown');
        } else {
          sysText = raw.text || raw.message || JSON.stringify(raw);
        }
        el.innerHTML = '<i data-lucide="info"></i> ' + escapeHtml(sysText);

      } else if (msg.type === 'assistant') {
        // Close thinking indicator when assistant starts responding
        closeThinking();

        // Extract text content from the message
        var content = '';
        if (raw.message && raw.message.content) {
          var contentArr = Array.isArray(raw.message.content) ? raw.message.content : [raw.message.content];
          for (var i = 0; i < contentArr.length; i++) {
            if (typeof contentArr[i] === 'string') content += contentArr[i];
            else if (contentArr[i] && contentArr[i].text) content += contentArr[i].text;
          }
        }
        if (!content && raw.text) content = raw.text;
        if (!content) return;

        // stream-json sends partial deltas AND a final complete message.
        // The final message (no timestamp_ms) contains the full accumulated text.
        var isPartialAssistant = !!raw.timestamp_ms;

        if (skipScroll) {
          // Re-rendering from buffer: only show final (non-partial) messages
          if (isPartialAssistant) return;
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--assistant';
          el.setAttribute('data-full-text', content);
          el.innerHTML = formatChatText(content);
          chatAssistantEl = el;
        } else {
          // Live streaming: accumulate partial deltas
          if (chatAssistantEl && chatAssistantEl.parentNode) {
            if (isPartialAssistant) {
              chatAssistantEl.classList.add('typing-cursor');
              var currentText = chatAssistantEl.getAttribute('data-full-text') || '';
              currentText += content;
              chatAssistantEl.setAttribute('data-full-text', currentText);
              chatAssistantEl.innerHTML = formatChatText(currentText);
            } else {
              chatAssistantEl.classList.remove('typing-cursor');
              chatAssistantEl.setAttribute('data-full-text', content);
              chatAssistantEl.innerHTML = formatChatText(content);
            }
          } else {
            el = document.createElement('div');
            el.className = 'chat-msg chat-msg--assistant' + (isPartialAssistant ? ' typing-cursor' : '');
            el.setAttribute('data-full-text', content);
            el.innerHTML = formatChatText(content);
            chatAssistantEl = el;
          }
        }

      } else if (msg.type === 'tool_call') {
        // Close thinking and streaming assistant
        closeThinking();
        if (chatAssistantEl) {
          chatAssistantEl.classList.remove('typing-cursor');
          chatAssistantEl = null;
        }
        var commitInfo2 = detectGitCommit(raw);
        if (commitInfo2 && msg.subtype === 'completed') {
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--commit';
          el.innerHTML = '<i data-lucide="git-commit"></i><div class="chat-msg--commit-body">' +
            '<div class="chat-msg--commit-msg">' + escapeHtml(commitInfo2.message) + '</div>' +
            '<div class="chat-msg--commit-meta">' +
            (commitInfo2.sha ? '<span class="chat-msg--commit-sha">' + commitInfo2.sha + '</span> ' : '') +
            (commitInfo2.files ? commitInfo2.files + ' files changed' : '') +
            '</div></div>';
        } else {
          el = document.createElement('div');
          el.className = 'chat-msg chat-msg--tool';
          var toolName = getToolName(raw);
          var toolDetail = getToolDetail(raw);
          var isCompleted = msg.subtype === 'completed';
          var statusIcon = isCompleted ? 'check-circle' : 'play';
          el.innerHTML = '<div class="chat-msg--tool-header" onclick="this.classList.toggle(\'expanded\');this.nextElementSibling.classList.toggle(\'expanded\')">' +
            '<i data-lucide="' + statusIcon + '"></i> ' + escapeHtml(toolName) +
            '<span class="tool-chevron"><i data-lucide="chevron-right"></i></span>' +
            '</div>' +
            '<div class="chat-msg--tool-body">' + escapeHtml(toolDetail) + '</div>';
        }

      } else if (msg.type === 'result') {
        // Close thinking and streaming assistant
        closeThinking();
        if (chatAssistantEl) {
          chatAssistantEl.classList.remove('typing-cursor');
          chatAssistantEl = null;
        }
        el = document.createElement('div');
        var dur = raw.duration_ms ? (raw.duration_ms / 1000).toFixed(1) + 's' : '';
        var isSuccess = raw.subtype !== 'error';
        el.className = 'chat-msg chat-msg--result ' + (isSuccess ? 'success' : 'failed');
        el.innerHTML = '<i data-lucide="' + (isSuccess ? 'check-circle' : 'alert-circle') + '"></i> ' +
          (isSuccess ? 'Completed' : 'Failed') + (dur ? ' in ' + dur : '');

      } else if (msg.type === 'stderr') {
        el = document.createElement('div');
        el.className = 'chat-msg chat-msg--stderr';
        el.textContent = raw.text || '';

      } else if (msg.type === 'raw') {
        el = document.createElement('div');
        el.className = 'chat-msg chat-msg--raw';
        el.textContent = raw.text || JSON.stringify(raw);

      } else {
        // Unknown type — silently ignore rather than dumping JSON
        // (catches future new types gracefully)
        return;
      }

      if (el) {
        chatPanelMessages.appendChild(el);
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
      if (!skipScroll && chatAutoScroll) {
        scrollChatToBottom();
      }
    }

    // Collapse current visible messages into a history turn
    function collapseCurrentMessages(sessionId) {
      // Find the "Current" divider — everything after it is current session content
      var dividers = chatPanelMessages.querySelectorAll('.chat-history-divider');
      var lastDivider = dividers.length > 0 ? dividers[dividers.length - 1] : null;

      // Collect nodes to remove (current session messages)
      var nodesToRemove = [];
      var startRemoving = !lastDivider; // if no divider, remove from first non-history-turn
      var children = chatPanelMessages.children;
      for (var i = 0; i < children.length; i++) {
        if (children[i] === lastDivider) {
          startRemoving = true;
          nodesToRemove.push(children[i]); // remove the divider too
          continue;
        }
        if (startRemoving && !children[i].classList.contains('chat-history-turn')) {
          nodesToRemove.push(children[i]);
        }
      }

      // Remove them
      for (var j = 0; j < nodesToRemove.length; j++) {
        chatPanelMessages.removeChild(nodesToRemove[j]);
      }

      // Reset streaming state
      chatAssistantEl = null;
      chatThinkingEl = null;

      // Add a collapsed turn for the session that just finished
      var chain = getSessionChain(sessionId);
      var turnNum = chain.length;
      renderCollapsedTurn(sessionId, turnNum);
    }

    function closeThinking() {
      if (chatThinkingEl && chatThinkingEl.parentNode) {
        var fullThink = chatThinkingEl.getAttribute('data-think-text') || '';
        chatThinkingEl.classList.remove('active');
        if (fullThink) {
          chatThinkingEl.innerHTML = '<div class="thinking-label" onclick="this.parentNode.classList.toggle(\'expanded\')">' +
            '<i data-lucide="brain"></i> <span>Thought for a moment</span>' +
            '<span class="thinking-chevron"><i data-lucide="chevron-right"></i></span>' +
            '</div>' +
            '<div class="thinking-body">' + escapeHtml(fullThink.length > 2000 ? fullThink.slice(0, 2000) + '...' : fullThink) + '</div>';
        } else {
          chatThinkingEl.innerHTML = '<div class="thinking-label"><i data-lucide="brain"></i> <span>Thought for a moment</span></div>';
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
        chatThinkingEl = null;
      }
    }

    function scrollChatToBottom() {
      chatPanelMessages.scrollTop = chatPanelMessages.scrollHeight;
    }

    // Track scroll position to disable auto-scroll when user scrolls up
    if (chatPanelMessages) {
      chatPanelMessages.addEventListener('scroll', function() {
        var threshold = 60;
        var atBottom = chatPanelMessages.scrollHeight - chatPanelMessages.scrollTop - chatPanelMessages.clientHeight < threshold;
        chatAutoScroll = atBottom;
      });
    }

    function formatChatText(text) {
      // Simple markdown-like formatting: code blocks, inline code, bold
      var escaped = escapeHtml(text);
      // Code blocks: ```...```
      escaped = escaped.replace(/```([^`]*?)```/g, '<pre><code>$1</code></pre>');
      // Inline code: `...`
      escaped = escaped.replace(/`([^`]+?)`/g, '<code>$1</code>');
      // Bold: **...**
      escaped = escaped.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
      return escaped;
    }

    function getToolName(raw) {
      var tc = raw.tool_call || raw;
      if (tc.bashToolCall) return 'Bash';
      if (tc.readToolCall) return 'Read: ' + (tc.readToolCall.args && tc.readToolCall.args.path ? shortenPath(tc.readToolCall.args.path) : '');
      if (tc.writeToolCall) return 'Write: ' + (tc.writeToolCall.args && tc.writeToolCall.args.path ? shortenPath(tc.writeToolCall.args.path) : '');
      if (tc.editToolCall) return 'Edit: ' + (tc.editToolCall.args && tc.editToolCall.args.path ? shortenPath(tc.editToolCall.args.path) : '');
      if (tc.globToolCall) return 'Glob';
      if (tc.grepToolCall) return 'Grep';
      if (tc.name) return tc.name;
      if (tc.type) return tc.type;
      return 'Tool';
    }

    function getToolDetail(raw) {
      var tc = raw.tool_call || raw;
      // Show command or args
      if (tc.bashToolCall) {
        var cmd = tc.bashToolCall.args && tc.bashToolCall.args.command ? tc.bashToolCall.args.command : '';
        var result = tc.bashToolCall.result ? JSON.stringify(tc.bashToolCall.result, null, 2) : '';
        return cmd + (result ? '\n---\n' + result : '');
      }
      if (tc.readToolCall) {
        if (tc.readToolCall.result && tc.readToolCall.result.success) {
          return 'Read ' + (tc.readToolCall.result.success.totalLines || '?') + ' lines';
        }
        return tc.readToolCall.args ? JSON.stringify(tc.readToolCall.args) : '';
      }
      if (tc.writeToolCall) {
        if (tc.writeToolCall.result && tc.writeToolCall.result.success) {
          return 'Created ' + (tc.writeToolCall.result.success.linesCreated || '?') + ' lines (' + (tc.writeToolCall.result.success.fileSize || '?') + ' bytes)';
        }
        return tc.writeToolCall.args ? JSON.stringify(tc.writeToolCall.args) : '';
      }
      if (tc.editToolCall) {
        return tc.editToolCall.args ? JSON.stringify(tc.editToolCall.args, null, 2).slice(0, 500) : '';
      }
      return JSON.stringify(tc, null, 2).slice(0, 500);
    }

    function shortenPath(p) {
      if (!p) return '';
      var parts = p.split('/');
      if (parts.length <= 3) return p;
      return '.../' + parts.slice(-2).join('/');
    }

    // Detect if a tool call is a git commit and extract info
    function detectGitCommit(raw) {
      var tc = raw.tool_call || raw;
      if (!tc.bashToolCall) return null;
      var cmd = (tc.bashToolCall.args && tc.bashToolCall.args.command) || '';
      if (!/git\s+commit/.test(cmd)) return null;
      // Parse commit message from -m flag
      var msgMatch = cmd.match(/-m\s+["']([^"']+)["']/);
      var commitMsg = msgMatch ? msgMatch[1] : cmd.replace(/.*git\s+commit\s*/, '').trim();
      // Check for result with commit SHA
      var sha = '';
      var resultStr = tc.bashToolCall.result ? JSON.stringify(tc.bashToolCall.result) : '';
      var shaMatch = resultStr.match(/\b([0-9a-f]{7,40})\b/);
      if (shaMatch) sha = shaMatch[1].slice(0, 7);
      // Check for file count in output
      var filesMatch = resultStr.match(/(\d+)\s+files?\s+changed/);
      var fileCount = filesMatch ? filesMatch[1] : '';
      return { message: commitMsg, sha: sha, files: fileCount };
    }

    function startChatSession(prompt, label, type, resumeSessionId, imageDataUrls) {
      if (!chatPanelPrContext || !chatPanelPrContext.path) {
        showToast('No project path available');
        return;
      }
      var body = {
        path: chatPanelPrContext.path,
        prompt: prompt,
        label: label || 'Agent session',
      };
      if (chatPanelPrContext.repo) body.repo = chatPanelPrContext.repo;
      if (chatPanelPrContext.number) body.number = chatPanelPrContext.number;
      if (type) body.type = type;
      if (resumeSessionId) body.resumeSessionId = resumeSessionId;

      // Show the follow-up prompt immediately in the current panel
      if (resumeSessionId && chatActiveSessionId) {
        // Collapse all current content into history, then show new prompt
        collapseCurrentMessages(resumeSessionId);
        var divider = document.createElement('div');
        divider.className = 'chat-history-divider';
        divider.textContent = 'Current';
        chatPanelMessages.appendChild(divider);
        var promptEl = createPromptElement(prompt, imageDataUrls);
        chatPanelMessages.appendChild(promptEl);
        scrollChatToBottom();
      }

      fetch('/api/agent-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.sessionId) {
          var sessionId = data.sessionId;
          // DON'T reset chatSessionMessages — SSE events may have already populated it
          if (!chatSessionMessages[sessionId]) chatSessionMessages[sessionId] = [];
          // Only set meta if SSE hasn't already set it
          if (!chatSessionMeta[sessionId]) {
            chatSessionMeta[sessionId] = {
              repo: chatPanelPrContext.repo,
              number: chatPanelPrContext.number ? parseInt(chatPanelPrContext.number, 10) : undefined,
              path: chatPanelPrContext.path || '',
              status: 'running',
              label: label || 'Agent session',
              startedAt: Date.now()
            };
          } else if (!chatSessionMeta[sessionId].path && chatPanelPrContext.path) {
            chatSessionMeta[sessionId].path = chatPanelPrContext.path;
          }

          if (resumeSessionId) {
            // For resumed sessions, link the new session to the old one's chat panel
            // Keep viewing the same conversation — new messages stream into the active panel
            chatActiveSessionId = sessionId;
            chatSessionMeta[sessionId].label = chatSessionMeta[resumeSessionId] ? chatSessionMeta[resumeSessionId].label : label;
            // Store the chain so we know this is a continuation
            if (!chatSessionMeta[sessionId]._prevSessionId) {
              chatSessionMeta[sessionId]._prevSessionId = resumeSessionId;
            }
            updateChatPanelStatusBadge('running');
            chatPanelCancel.style.display = '';
            renderSidebar();
          } else {
            switchChatSession(sessionId);
            // Prepend the prompt as the first visual element (before streamed messages)
            var promptEl2 = createPromptElement(prompt, imageDataUrls);
            chatPanelMessages.insertBefore(promptEl2, chatPanelMessages.firstChild);
          }

          showToast(data.resumed ? 'Resuming conversation' : 'Agent started');
          // Update chat badge on PR row
          updateChatBadge(chatPanelPrContext.repo, chatPanelPrContext.number, 'running');
        } else {
          showToast('Failed to start agent: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(function(err) {
        showToast('Error starting agent');
        console.error('Start session error:', err);
      });
    }

    function updateChatBadge(repo, number, status) {
      if (!repo || !number) return;
      var btn = document.querySelector('.chat-btn[data-repo="' + repo + '"][data-number="' + number + '"]');
      if (!btn) return;
      var badge = btn.querySelector('.chat-badge');
      if (status && status !== 'cleared') {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'chat-badge';
          btn.appendChild(badge);
        }
        badge.className = 'chat-badge chat-badge--' + status;
      } else if (badge) {
        badge.remove();
      }
    }

    // Chat panel event handlers
    chatPanelClose.addEventListener('click', closeChatPanel);
    chatBackdrop.addEventListener('click', closeChatPanel);

    chatPanelCancel.addEventListener('click', function() {
      if (!chatActiveSessionId) return;
      fetch('/api/agent-session/' + encodeURIComponent(chatActiveSessionId), { method: 'DELETE' })
        .then(function(r) { return r.json(); })
        .then(function() {
          showToast('Agent cancelled');
        })
        .catch(function() {
          showToast('Failed to cancel agent');
        });
    });

    // Sidebar session click
    chatSidebarSessions.addEventListener('click', function(e) {
      var sessionBtn = e.target.closest('.chat-sidebar__session');
      if (!sessionBtn) return;
      var sid = sessionBtn.getAttribute('data-session-id');
      if (!sid || !chatSessionMeta[sid]) return;
      var meta = chatSessionMeta[sid];
      if (meta.repo && meta.number) {
        chatPanelPrContext = { repo: meta.repo, number: String(meta.number), path: meta.path || lookupInitiativePath(meta.repo, meta.number) };
      }
      switchChatSession(sid);
      renderSidebar();
    });

    // Sidebar "New" button
    chatSidebarNewBtn.addEventListener('click', function() {
      // Find first PR for current initiative and show quick actions
      var firstPr = findFirstPrForInitiative(chatModalInitiative);
      if (firstPr) {
        chatPanelPrContext = firstPr;
        showChatQuickActions(firstPr);
      } else {
        showChatQuickActions(null);
      }
    });

    // Quick-action buttons
    chatPanelMessages.addEventListener('click', function(e) {
      var actionBtn = e.target.closest('[data-chat-action]');
      if (!actionBtn) return;
      var action = actionBtn.getAttribute('data-chat-action');
      if (!chatPanelPrContext) return;
      var repo = chatPanelPrContext.repo;
      var num = chatPanelPrContext.number;
      var path = chatPanelPrContext.path;
      var branch = chatPanelPrContext.branch;

      if (action === 'custom') {
        chatPanelInputArea.classList.add('visible');
        chatPanelInput.focus();
        return;
      }

      if (action === 'checks') {
        // Fetch check failures and start session
        fetch('/api/check-failures?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var failures = data.failures || [];
            var failureText = '';
            if (failures.length > 0) {
              failureText = '\n\nFailing checks:\n';
              for (var i = 0; i < failures.length; i++) {
                var f = failures[i];
                failureText += '\n' + (i + 1) + '. ' + f.name + ' (' + f.conclusion + ')';
                if (f.errors && f.errors.length > 0) {
                  failureText += '\n   Errors from logs:';
                  for (var j = 0; j < f.errors.length; j++) {
                    failureText += '\n   - ' + f.errors[j];
                  }
                } else if (f.annotations && f.annotations.length > 0) {
                  failureText += '\n   Errors:';
                  for (var j = 0; j < f.annotations.length; j++) {
                    var ann = f.annotations[j];
                    failureText += '\n   - ' + ann.path + (ann.line ? ':' + ann.line : '') + ': ' + ann.message;
                  }
                }
              }
            }
            var prompt = buildCopyText(repo, num, 'checks', {}) + failureText;
            startChatSession(prompt, 'Fix checks: ' + formatRepoName(repo) + ' #' + num, 'checks');
          })
          .catch(function() {
            var prompt = buildCopyText(repo, num, 'checks', {});
            startChatSession(prompt, 'Fix checks: ' + formatRepoName(repo) + ' #' + num, 'checks');
          });
      } else if (action === 'comments') {
        fetch('/api/pr-comments?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var comments = data.comments || [];
            var commentText = '';
            if (comments.length > 0) {
              commentText = '\n\nUnresolved comments:\n';
              for (var i = 0; i < comments.length; i++) {
                var c = comments[i];
                commentText += '\n' + (i + 1) + '. ' + (c.path ? c.path + (c.line ? ':' + c.line : '') + ' - ' : '') + '@' + c.author + ':\n   ' + (c.body || '').split('\n').join('\n   ') + '\n';
              }
            }
            var prompt = buildCopyText(repo, num, 'comments', { unresolved: comments.length }) + commentText;
            startChatSession(prompt, 'Comments: ' + formatRepoName(repo) + ' #' + num, 'comments');
          })
          .catch(function() {
            var prompt = buildCopyText(repo, num, 'comments', {});
            startChatSession(prompt, 'Comments: ' + formatRepoName(repo) + ' #' + num, 'comments');
          });
      } else if (action === 'conflicts') {
        var prompt = buildRebaseCommand(repo, num, branch);
        startChatSession(prompt, 'Conflicts: ' + formatRepoName(repo) + ' #' + num, 'conflicts');
      }
    });

    // Custom prompt send — resumes current conversation if one exists
    chatPanelSend.addEventListener('click', function() {
      var prompt = chatPanelInput.value.trim();
      var imagePaths = getAttachedImagePaths();
      var imageDataUrls = getAttachedImageDataUrls();

      // Need either text or images
      if (!prompt && imagePaths.length === 0) return;

      // Check if any images are still uploading
      var stillUploading = chatPendingImages.some(function(e) { return e.uploading; });
      if (stillUploading) {
        showToast('Wait for images to finish uploading');
        return;
      }

      // Append image references to the prompt
      if (imagePaths.length > 0) {
        var imageRef = '\n\n[Attached image' + (imagePaths.length > 1 ? 's' : '') + ':\n';
        for (var i = 0; i < imagePaths.length; i++) {
          imageRef += '  ' + imagePaths[i] + '\n';
        }
        imageRef += 'Read ' + (imagePaths.length > 1 ? 'these images' : 'this image') + ' to see what I\'m referring to.]';
        prompt = (prompt || 'See attached image' + (imagePaths.length > 1 ? 's' : '')) + imageRef;
      }

      chatPanelInput.value = '';
      chatPanelInput.style.height = 'auto';
      clearAttachments();

      // Find a session with a cursorChatId to resume — walk the chain
      var resumeId = findResumableSession();

      var label = 'Custom: ';
      if (chatPanelPrContext && chatPanelPrContext.repo) {
        label += formatRepoName(chatPanelPrContext.repo) + ' #' + (chatPanelPrContext.number || '');
      } else {
        label += prompt.replace(/\n\n\[Attached images?:[\s\S]*?\]/g, '').trim().slice(0, 40);
      }

      if (resumeId) {
        startChatSession(prompt, label, 'all', resumeId, imageDataUrls);
      } else {
        startChatSession(prompt, label, 'all', null, imageDataUrls);
      }
    });

    // Walk the session chain to find one with a cursorChatId for --resume
    function findResumableSession() {
      if (!chatActiveSessionId) return null;
      // Check current session
      var sid = chatActiveSessionId;
      var visited = {};
      while (sid && !visited[sid]) {
        visited[sid] = true;
        var meta = chatSessionMeta[sid];
        if (!meta) break;
        // Can only resume completed/failed sessions (not currently running)
        if (meta.status === 'running') return null;
        if (meta.cursorChatId) return sid;
        // Walk back to previous session in the chain
        sid = meta._prevSessionId;
      }
      return null;
    }

    chatPanelInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatPanelSend.click();
      }
    });

    // Auto-resize textarea
    chatPanelInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // --- Image attachment handling ---

    // Click attach button → open file picker
    chatPanelAttach.addEventListener('click', function() {
      chatPanelFileInput.click();
    });

    // File picker change
    chatPanelFileInput.addEventListener('change', function() {
      var files = chatPanelFileInput.files;
      if (files && files.length > 0) {
        for (var i = 0; i < files.length; i++) {
          addImageFile(files[i]);
        }
        chatPanelFileInput.value = '';
      }
    });

    // Paste image from clipboard
    chatPanelInput.addEventListener('paste', function(e) {
      var items = (e.clipboardData || e.originalEvent && e.originalEvent.clipboardData || {}).items;
      if (!items) return;
      for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          e.preventDefault();
          var file = items[i].getAsFile();
          if (file) addImageFile(file);
        }
      }
    });

    // Drag and drop on textarea
    chatPanelInput.addEventListener('dragover', function(e) {
      e.preventDefault();
      chatPanelInput.classList.add('drag-over');
    });
    chatPanelInput.addEventListener('dragleave', function() {
      chatPanelInput.classList.remove('drag-over');
    });
    chatPanelInput.addEventListener('drop', function(e) {
      e.preventDefault();
      chatPanelInput.classList.remove('drag-over');
      var files = e.dataTransfer && e.dataTransfer.files;
      if (files) {
        for (var i = 0; i < files.length; i++) {
          if (files[i].type.indexOf('image') !== -1) {
            addImageFile(files[i]);
          }
        }
      }
    });

    function addImageFile(file) {
      if (!file || file.type.indexOf('image') === -1) return;
      // Max 10MB
      if (file.size > 10 * 1024 * 1024) {
        showToast('Image too large (max 10MB)');
        return;
      }
      var reader = new FileReader();
      reader.onload = function(ev) {
        var dataUrl = ev.target.result;
        var entry = {
          dataUrl: dataUrl,
          serverPath: null,
          filename: file.name || ('paste-' + Date.now() + '.png'),
          uploading: true
        };
        chatPendingImages.push(entry);
        renderAttachments();
        uploadImage(entry);
      };
      reader.readAsDataURL(file);
    }

    function uploadImage(entry) {
      var projectPath = (chatPanelPrContext && chatPanelPrContext.path) || '';
      fetch('/api/upload-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          data: entry.dataUrl,
          filename: entry.filename,
          projectPath: projectPath
        })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success && data.path) {
          entry.serverPath = data.path;
          entry.uploading = false;
          renderAttachments();
        } else {
          showToast('Upload failed: ' + (data.error || 'unknown'));
          removeAttachment(entry);
        }
      })
      .catch(function(err) {
        console.error('Upload error:', err);
        showToast('Image upload failed');
        removeAttachment(entry);
      });
    }

    function removeAttachment(entry) {
      var idx = chatPendingImages.indexOf(entry);
      if (idx !== -1) chatPendingImages.splice(idx, 1);
      renderAttachments();
    }

    function renderAttachments() {
      chatPanelAttachments.innerHTML = '';
      for (var i = 0; i < chatPendingImages.length; i++) {
        var entry = chatPendingImages[i];
        var div = document.createElement('div');
        div.className = 'chat-attachment' + (entry.uploading ? ' chat-attachment--uploading' : '');
        var img = document.createElement('img');
        img.src = entry.dataUrl;
        img.alt = entry.filename;
        div.appendChild(img);
        var rmBtn = document.createElement('button');
        rmBtn.className = 'chat-attachment__remove';
        rmBtn.innerHTML = '&times;';
        rmBtn.setAttribute('data-idx', String(i));
        rmBtn.addEventListener('click', (function(idx) {
          return function(e) {
            e.stopPropagation();
            chatPendingImages.splice(idx, 1);
            renderAttachments();
          };
        })(i));
        div.appendChild(rmBtn);
        chatPanelAttachments.appendChild(div);
      }
    }

    function getAttachedImagePaths() {
      var paths = [];
      for (var i = 0; i < chatPendingImages.length; i++) {
        if (chatPendingImages[i].serverPath) {
          paths.push(chatPendingImages[i].serverPath);
        }
      }
      return paths;
    }

    function getAttachedImageDataUrls() {
      var urls = [];
      for (var i = 0; i < chatPendingImages.length; i++) {
        if (chatPendingImages[i].dataUrl) {
          urls.push(chatPendingImages[i].dataUrl);
        }
      }
      return urls;
    }

    function clearAttachments() {
      chatPendingImages = [];
      renderAttachments();
    }

    // Create a prompt element that shows clean text + inline image previews
    function createPromptElement(promptText, imageDataUrls) {
      var el = document.createElement('div');
      el.className = 'chat-msg chat-msg--prompt';

      // Strip the [Attached image...] block from display text
      var cleanText = promptText.replace(/\n\n\[Attached images?:[\s\S]*?\]/g, '').trim();
      if (cleanText.length > 300) cleanText = cleanText.slice(0, 300) + '...';

      var textSpan = document.createElement('div');
      textSpan.textContent = cleanText;
      el.appendChild(textSpan);

      // Show inline image thumbnails
      if (imageDataUrls && imageDataUrls.length > 0) {
        var imgContainer = document.createElement('div');
        imgContainer.className = 'chat-prompt__images';
        for (var i = 0; i < imageDataUrls.length; i++) {
          var img = document.createElement('img');
          img.src = imageDataUrls[i];
          img.alt = 'Attached image ' + (i + 1);
          img.addEventListener('click', (function(src) {
            return function() { window.open(src, '_blank'); };
          })(imageDataUrls[i]));
          imgContainer.appendChild(img);
        }
        el.appendChild(imgContainer);
      }
      return el;
    }

    // Fetch tool settings
    fetch('/api/settings')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        toolSettings = data;
        var sel = document.getElementById('tool-select');
        if (sel) sel.value = data.tool || 'cursor-ide';
        console.log('[Settings] Tool:', toolSettings.tool);
      })
      .catch(function() { /* defaults */ });

    // Save tool setting when dropdown changes
    document.addEventListener('DOMContentLoaded', function() {
      var sel = document.getElementById('tool-select');
      if (sel) {
        sel.addEventListener('change', function() {
          var newTool = sel.value;
          toolSettings.tool = newTool;
          fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tool: newTool })
          }).then(function() {
            showToast('Tool set to ' + newTool);
          }).catch(function() {
            showToast('Failed to save tool setting');
          });
        });
      }
    });

    // Check if agent CLI dispatch is available
    fetch('/api/capabilities')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        canDispatchAgent = !!data.agentCli;
        console.log('[Capabilities] Agent CLI dispatch:', canDispatchAgent);
      })
      .catch(function() { canDispatchAgent = false; });

    /** Whether the current tool supports background agent spawning. */
    function toolCanSpawn() {
      return toolSettings.tool === 'cursor-ide' || toolSettings.tool === 'claude-code';
    }

    /** Build the appropriate "open in tool" URL for a path. Returns null for tools that don't support deep links. */
    function toolLink(path) {
      if (!path || !path.trim()) return null;
      if (toolSettings.tool === 'cursor-ide' || toolSettings.tool === 'cursor-web') {
        return 'cursor://file/' + escapeUri(path);
      }
      // claude-code and generic don't have deep links
      return null;
    }

    /** Title text for "open in" links. */
    function toolOpenTitle() {
      switch (toolSettings.tool) {
        case 'cursor-ide': return 'Open in Cursor';
        case 'cursor-web': return 'Open in Cursor';
        case 'claude-code': return 'Open in terminal';
        default: return 'Open';
      }
    }

    /** Build an <a> tag or <span> for a path, adapting to the current tool. */
    function toolAnchor(path, innerHtml, extraClass, extraAttrs) {
      var href = toolLink(path);
      var title = toolOpenTitle();
      var cls = extraClass ? ' class="' + extraClass + '"' : '';
      var attrs = extraAttrs || '';
      if (href) {
        return '<a href="' + href + '"' + cls + ' title="' + title + '"' + attrs + '>' + innerHtml + '</a>';
      }
      if (path && path.trim() && toolSettings.tool === 'claude-code') {
        // For claude-code, clicking copies a cd + claude command
        return '<a href="#" onclick="copyCommand(\'cd ' + escapeAttr(path) + ' && claude\', \'Terminal command copied!\'); return false;"' + cls + ' title="Copy terminal command"' + attrs + '>' + innerHtml + '</a>';
      }
      return '<span' + cls + '>' + innerHtml + '</span>';
    }

    /** Show a modal with a prompt for the user to copy (for clipboard-based tools). */
    function showPromptModal(title, prompt) {
      var overlay = document.createElement('div');
      overlay.className = 'prompt-modal-overlay';
      overlay.innerHTML = '<div class="prompt-modal">' +
        '<h3>' + escapeHtml(title) + '</h3>' +
        '<pre>' + escapeHtml(prompt) + '</pre>' +
        '<div class="prompt-modal-actions">' +
        '<button class="btn" onclick="this.closest(\'.prompt-modal-overlay\').remove()">Close</button>' +
        '<button class="btn btn-primary" id="prompt-modal-copy">Copy to clipboard</button>' +
        '</div></div>';
      document.body.appendChild(overlay);
      overlay.addEventListener('click', function(ev) {
        if (ev.target === overlay) overlay.remove();
      });
      var copyBtn = overlay.querySelector('#prompt-modal-copy');
      if (copyBtn) {
        copyBtn.addEventListener('click', function() {
          copyCommand(prompt, 'Prompt copied!');
          overlay.remove();
        });
      }
    }

    // Dispatch a prompt to the agent, adapting to the current tool
    function dispatchAgent(projectPath, prompt, opts) {
      opts = opts || {};

      // If agent CLI is available, use embedded chat panel
      if (canDispatchAgent && projectPath) {
        var prContext = {
          repo: opts.repo || '',
          number: opts.number || '',
          path: projectPath,
          branch: opts.branch || ''
        };
        // Open chat panel and start a session
        openChatPanel(prContext);
        var label = opts.label || 'Agent';
        if (opts.repo && opts.number) {
          label = (opts.type || 'Agent') + ': ' + formatRepoName(opts.repo) + ' #' + opts.number;
        }
        chatPanelPrContext = prContext;
        startChatSession(prompt, label, opts.type || 'all');
        return Promise.resolve(true);
      }

      // Fallback: copy to clipboard
      copyCommand(prompt, null);

      // For cursor-ide fallback: copy to clipboard and open Cursor
      if (toolSettings.tool === 'cursor-ide' || toolSettings.tool === 'cursor-web') {
        copyCommand(prompt, opts.toastMessage || 'Command copied!');
        if (projectPath) {
          var cursorHref = 'cursor://file/' + encodeURI(projectPath).replace(/[#?]/g, encodeURIComponent);
          window.location.href = cursorHref;
        }
        return Promise.resolve(false);
      }

      // For claude-code: show a terminal command in a modal
      if (toolSettings.tool === 'claude-code') {
        var claudeCmd = 'cd ' + (projectPath || '.') + ' && claude -p ' + JSON.stringify(prompt);
        showPromptModal('Claude Code Command', claudeCmd);
        return Promise.resolve(false);
      }

      // For generic: show the raw prompt in a modal
      showPromptModal('Agent Prompt', prompt);
      return Promise.resolve(false);
    }
    
    function renderPrepWorkTable() {
      var body = document.getElementById('prep-work-body');
      if (!body) return;
      var tasks = Object.values(initiativeTasks);
      if (tasks.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1.5rem; color:var(--text-muted); font-size:0.8rem;">No prep tasks — click the terminal icon on an initiative to start one</td></tr>';
        return;
      }
      var html = '';
      for (var i = 0; i < tasks.length; i++) {
        var t = tasks[i];
        var icon = initiativeIconHtml(t.initiative);
        var initLink = t.path
          ? toolAnchor(t.path, escapeHtml(t.initiative), 'init')
          : escapeHtml(t.initiative);
        var initCell = icon ? '<span class="initiative-with-icon">' + icon + initLink + '</span>' : initLink;
        var cmdText = '<span class="prep-work-task-cmd" title="' + escapeAttr(t.command) + '">' + escapeHtml(t.command.slice(0, 80)) + (t.command.length > 80 ? '…' : '') + '</span>';
        var bannerIcon = 'clock';
        var bannerText = 'Pending...';
        if (t.status === 'running') { bannerIcon = 'loader-2'; bannerText = 'Agent running'; }
        else if (t.status === 'complete') { bannerIcon = 'check-circle'; bannerText = 'Done'; }
        else if (t.status === 'failed') { bannerIcon = 'alert-circle'; bannerText = 'Failed'; }
        var bannerClass = 'agent-banner agent-banner--' + t.status;
        var grillSprite = (t.status === 'pending' || t.status === 'running') ? '<span class="chef-grilling"></span> ' : '';
        var statusLinkHref = toolLink(t.path);
        var statusHtml = statusLinkHref
          ? '<a href="' + statusLinkHref + '" class="' + bannerClass + '">' + grillSprite + bannerText + '</a>'
          : '<div class="' + bannerClass + '">' + grillSprite + bannerText + '</div>';
        var clearBtn = '<button class="prep-work-clear-btn" data-clear-task="' + escapeAttr(t.id) + '" title="Remove"><i data-lucide="x"></i></button>';
        html += '<tr class="prep-work-task-row" data-task-id="' + escapeAttr(t.id) + '"><td>' + initCell + '</td><td>' + cmdText + '</td><td class="agent-status-cell">' + statusHtml + '</td><td>' + clearBtn + '</td></tr>';
      }
      body.innerHTML = html;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function loadInitiativeTasks() {
      fetch('/api/initiative-tasks')
        .then(function(r) { return r.json(); })
        .then(function(tasks) {
          initiativeTasks = {};
          for (var i = 0; i < tasks.length; i++) {
            initiativeTasks[tasks[i].id] = tasks[i];
          }
          renderPrepWorkTable();
        })
        .catch(function() {});
    }

    function getAgentStatusHtml(repo, number, path) {
      var key = repo + '#' + number;
      var job = agentJobs[key];
      if (!job) {
        // No job - still make clickable if path exists
        if (path && path.trim()) {
          var emptyHref = toolLink(path);
          if (emptyHref) return '<a href="' + emptyHref + '" class="agent-status-link" title="' + toolOpenTitle() + '"><span class="agent-status-empty">—</span></a>';
          return '<span class="agent-status-empty">—</span>';
        }
        return '<span class="agent-status-empty">—</span>';
      }
      
      var icon = 'loader-2';
      var statusClass = job.status;
      var text = 'Pending';
      var title = '';
      
      if (job.status === 'running') {
        icon = 'loader-2';
        text = 'Running...';
        title = 'Agent working on ' + (job.type || 'fixes') + ' - Click to open in Cursor';
      } else if (job.status === 'complete') {
        icon = 'check';
        text = 'Done';
        title = (job.summary || 'Agent completed') + ' - Click to open in Cursor';
      } else if (job.status === 'failed') {
        icon = 'alert-circle';
        text = 'Failed';
        title = (job.error || 'Agent failed') + ' - Click to open in Cursor';
      } else if (job.status === 'pending') {
        icon = 'clock';
        text = 'Pending';
        title = 'Waiting for agent to start - Click to open in Cursor';
      }
      
      var statusSpan = '<span class="agent-status ' + statusClass + '" title="' + escapeAttr(title) + '"><i data-lucide="' + icon + '"></i> ' + escapeHtml(text) + '</span>';
      
      // Wrap in link if path exists
      var agentHref = toolLink(path);
      if (agentHref) {
        return '<a href="' + agentHref + '" class="agent-status-link">' + statusSpan + '</a>';
      }
      return statusSpan;
    }
    
    function buildInitPickerDropdown(pr) {
      var branch = pr.branch || pr.headRefName || '';
      var repo = pr.repo || '';
      var itemsHtml = '';
      for (var i = 0; i < availableInitiativeNames.length; i++) {
        var name = availableInitiativeNames[i];
        itemsHtml += '<div class="init-picker__item" data-init-name="' + escapeAttr(name) + '">' +
          '<img class="init-picker__item-icon" src="/images/initiatives/' + escapeAttr(name) + '.png" alt="" />' +
          '<span class="init-picker__item-name">' + escapeHtml(name) + '</span>' +
        '</div>';
      }
      if (!itemsHtml) {
        itemsHtml = '<div class="init-picker__empty">No initiatives</div>';
      }
      return '<div class="init-picker" data-repo="' + escapeAttr(repo) + '" data-branch="' + escapeAttr(branch) + '" data-number="' + (pr.number || '') + '">' +
        '<button type="button" class="init-picker__btn" title="Select initiative to checkout branch">' +
          '<span>—</span>' +
          '<i data-lucide="chevron-down"></i>' +
        '</button>' +
        '<div class="init-picker__menu">' + itemsHtml + '</div>' +
      '</div>';
    }
    
    function buildPrRowCells(pr) {
      var c = pr.checks || {};
      var path = (pr.initiativePath && typeof pr.initiativePath === 'string') ? pr.initiativePath : '';
      var initLabel = (pr.initiativeName && typeof pr.initiativeName === 'string') ? pr.initiativeName : '—';
      var initCell;
      if (initLabel === '—') {
        // No initiative - show picker dropdown
        initCell = buildInitPickerDropdown(pr);
      } else {
        // Initiative name/icon shown in group header, leave PR row cell empty
        initCell = '';
      }
      var commentsContent = pr.unresolved > 0
        ? '<span class="comments-unresolved">' + pr.unresolved + '</span>'
        : '<span class="check-icon none">0</span>';
      var commentsHref = toolLink(path);
      var commentsHtml = commentsHref
        ? '<a href="' + commentsHref + '" class="comments-link" data-unresolved="' + (pr.unresolved || 0) + '" title="' + toolOpenTitle() + '">' + commentsContent + '</a>'
        : commentsContent;
      var hasIssues = pr.unresolved > 0 || c.lint === 'failure' || c.type === 'failure' || c.test === 'failure' || c.e2e === 'failure' || c.other === 'failure' || hasConflicts(pr);
      // Store issue context as data attributes for the copy command
      var failingChecks = [];
      if (c.lint === 'failure') failingChecks.push('lint');
      if (c.type === 'failure') failingChecks.push('type');
      if (c.test === 'failure') failingChecks.push('test');
      if (c.e2e === 'failure') failingChecks.push('e2e');
      if (c.other === 'failure') failingChecks.push('other');
      var finishBtn = hasIssues ? '<button type="button" class="finish-him-btn" title="86 THE BUGS - Fix all issues" data-failing-checks="' + escapeAttr(failingChecks.join(',')) + '" data-unresolved="' + (pr.unresolved || 0) + '" data-has-conflicts="' + (hasConflicts(pr) ? '1' : '0') + '"><i data-lucide="bug"></i></button>' : '';
      // Show REVIEW NOW or MERGE button depending on approval status
      var allChecksPassing = c.lint !== 'failure' && c.type !== 'failure' && c.test !== 'failure' && c.e2e !== 'failure' && c.other !== 'failure';
      var readyForReview = !hasIssues && allChecksPassing && pr.mergeable !== false;
      var isApproved = pr.reviewDecision === 'APPROVED';
      // Debug: log button decision for this PR
      if (readyForReview) {
        console.log('PR #' + pr.number + ' readyForReview:', readyForReview, 'isApproved:', isApproved, 'reviewDecision:', pr.reviewDecision);
      }
      var reviewBtn = '';
      if (readyForReview && isApproved) {
        // PR is approved - show MERGE button (utensils icon for "SERVE IT")
        reviewBtn = '<button type="button" class="merge-btn" title="SERVE IT - Merge this PR" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '"><i data-lucide="utensils"></i></button>';
      } else if (readyForReview) {
        // PR needs review - show REVIEW NOW button (chef-hat icon for "CALL THE CHEF")
        reviewBtn = '<button type="button" class="review-now-btn" title="CALL THE CHEF - Request review" data-title="' + escapeAttr(pr.title || '') + '" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '"><i data-lucide="chef-hat"></i></button>';
      }
      var forkBtn = path ? '<button type="button" class="fork-btn" title="Open in Fork app" data-path="' + escapeAttr(path) + '"><i data-lucide="git-fork"></i></button>' : '';
      var isOnBackBurner = isBackBurner(pr.repo, pr.number);
      var backBurnerBtn = '<button type="button" class="back-burner-btn' + (isOnBackBurner ? ' active' : '') + '" title="' + (isOnBackBurner ? 'Move back to active' : 'Move to back burner') + '" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '"><i data-lucide="flame"></i></button>';
      var prCell = '<span class="pr-cell"><a href="https://github.com/' + escapeHtml(pr.repo) + '/pull/' + pr.number + '" target="_blank" rel="noopener">#' + pr.number + '</a></span>';
      var agentStatusHtml = getAgentStatusHtml(pr.repo, pr.number, path);
      var customCmdBtn = '<button type="button" class="custom-cmd-btn" title="Send custom command to agent" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '" data-path="' + escapeAttr(path || '') + '" data-branch="' + escapeAttr(pr.branch || '') + '"><i data-lucide="terminal"></i></button>';
      // Chat button with badge for active sessions
      var chatBadgeHtml = '';
      for (var _sid in chatSessionMeta) {
        var _sm = chatSessionMeta[_sid];
        if (_sm && _sm.repo === pr.repo && _sm.number === pr.number && _sm.status) {
          chatBadgeHtml = '<span class="chat-badge chat-badge--' + _sm.status + '"></span>';
          break;
        }
      }
      var chatBtn = '<button type="button" class="chat-btn" title="Open agent chat" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '" data-path="' + escapeAttr(path || '') + '" data-branch="' + escapeAttr(pr.branch || '') + '"><i data-lucide="message-circle"></i>' + chatBadgeHtml + '</button>';
      var actionsCell = '<div class="actions-cell"><button type="button" class="row-refresh" title="Refresh this PR"><i data-lucide="refresh-cw"></i></button>' + forkBtn + chatBtn + customCmdBtn + finishBtn + reviewBtn + '</div>';
      var conflictsBanner = hasConflicts(pr) ? buildConflictsBanner(path, pr.repo, pr.number, pr.branch) : '';
      var checksHtml = '<div class="checks-container">' +
        '<span class="check-icon-wrap">' + checkCell(c.lint, path, pr.repo, pr.number, 'lint') + '</span>' +
        '<span class="check-icon-wrap">' + checkCell(c.type, path, pr.repo, pr.number, 'type') + '</span>' +
        '<span class="check-icon-wrap">' + checkCell(c.test, path, pr.repo, pr.number, 'test') + '</span>' +
        '<span class="check-icon-wrap">' + checkCell(c.e2e, path, pr.repo, pr.number, 'e2e') + '</span>' +
        '<span class="check-icon-wrap">' + checkCell(c.other, path, pr.repo, pr.number, 'other') + '</span>' +
        conflictsBanner +
        '</div>';
      var titleDisplay = '<span class="pr-title" title="' + escapeAttr(pr.title) + '">' + escapeHtml(pr.title.slice(0, 60)) + (pr.title.length > 60 ? '…' : '') + '</span>';
      // Agent status banner - shown inline under the title when an agent is active
      var agentBanner = '';
      var agentKey = pr.repo + '#' + pr.number;
      var agentJob = agentJobs[agentKey];
      if (agentJob) {
        var bannerClass = 'agent-banner agent-banner--' + agentJob.status;
        var bannerIcon = 'clock';
        var bannerText = 'Pending...';
        if (agentJob.status === 'running') { bannerIcon = 'loader-2'; bannerText = 'Agent running'; }
        else if (agentJob.status === 'complete') { bannerIcon = 'check-circle'; bannerText = 'Agent done'; }
        else if (agentJob.status === 'failed') { bannerIcon = 'alert-circle'; bannerText = 'Agent failed'; }
        var grillSprite = (agentJob.status === 'pending' || agentJob.status === 'running') ? '<span class="chef-grilling"></span> ' : '';
        agentBanner = '<button type="button" class="' + bannerClass + '" data-agent-banner="' + escapeAttr(agentKey) + '" data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '" data-path="' + escapeAttr(path || '') + '">' + grillSprite + escapeHtml(bannerText) + '</button>';
      }
      return '<td>' + initCell + '</td>' +
        '<td><span class="repo-cell"><span class="platform-icon" style="color: ' + getPlatformIcon(pr.repo).color + ';" title="' + getPlatformIcon(pr.repo).label + '"><i data-lucide="' + getPlatformIcon(pr.repo).icon + '"></i></span>' + escapeHtml(formatRepoName(pr.repo)) + ' ' + prCell + (pr.branch ? ' <code class="branch-name" data-branch="' + escapeAttr(pr.branch) + '" title="Click to copy">' + escapeHtml(pr.branch) + '</code>' : '') + '<br>' + titleDisplay + '</span></td>' +
        '<td class="agent-status-cell">' + agentBanner + '</td>' +
        '<td class="actions-col">' + actionsCell + '</td>' +
        '<td>' + commentsHtml + '</td>' +
        '<td class="checks-cell" colspan="5">' + checksHtml + '</td>' +
        '<td>' + previewLinks(pr.previews, pr.previewDeployStatus) + '</td>';
    }

    function sortInitiativesByOrder(initiatives) {
      if (!initiativeOrder || initiativeOrder.length === 0) return initiatives;
      var sorted = initiatives.slice().sort(function(a, b) {
        var aIdx = initiativeOrder.indexOf(a.name);
        var bIdx = initiativeOrder.indexOf(b.name);
        // Items not in order go to the end
        if (aIdx === -1) aIdx = 999;
        if (bIdx === -1) bIdx = 999;
        return aIdx - bIdx;
      });
      return sorted;
    }
    
    function saveInitiativeOrder() {
      var cardsRoot = document.getElementById('initiative-cards-root');
      if (!cardsRoot) return;
      var cards = cardsRoot.querySelectorAll('.initiative-card[data-initiative-name]');
      initiativeOrder = [];
      cards.forEach(function(card) {
        var name = card.getAttribute('data-initiative-name');
        if (name) initiativeOrder.push(name);
      });
      try { localStorage.setItem(INITIATIVE_ORDER_KEY, JSON.stringify(initiativeOrder)); } catch (e) {}
    }
    
    function renderInitiativeCards(allInitiatives, newlyCreatedName, keepCached) {
      var cardsRoot = document.getElementById('initiative-cards-root');
      if (!cardsRoot) return;
      // If keepCached is true, don't clear - just return (used during loading)
      if (keepCached && (!Array.isArray(allInitiatives) || allInitiatives.length === 0)) {
        return;
      }
      if (!Array.isArray(allInitiatives) || allInitiatives.length === 0) {
        // Only clear if we don't have cached data to show
        if (!cachedInitiatives || cachedInitiatives.length === 0) {
          cardsRoot.innerHTML = '';
        }
        return;
      }
      // Cache the initiatives for showing during loading
      cachedInitiatives = allInitiatives;
      try { localStorage.setItem(INITIATIVES_CACHE_KEY, JSON.stringify(allInitiatives)); } catch (e) {}
      var iconCacheBust = (typeof window.__lastCreatedInitiativeTime === 'number' && newlyCreatedName)
        ? window.__lastCreatedInitiativeTime
        : null;
      // Sort by saved order
      var sortedInitiatives = sortInitiativesByOrder(allInitiatives);
      var html = '';
      for (var i = 0; i < sortedInitiatives.length; i++) {
        var init = sortedInitiatives[i];
        var name = (init.name && typeof init.name === 'string') ? init.name : '';
        var path = (init.path && typeof init.path === 'string') ? init.path.trim() : '';
        var bust = (iconCacheBust && name === newlyCreatedName) ? iconCacheBust : null;
        var iconSrc = '/images/initiatives/' + escapeAttr(name) + '.png' + (bust ? '?_t=' + bust : '');
        var iconWithEdit = '<span class="initiative-icon-wrap">' +
          '<img src="' + iconSrc + '" alt="" class="initiative-icon" />' +
          '<button type="button" class="initiative-icon-edit" data-edit-initiative="' + escapeAttr(name) + '" title="Regenerate icon"><i data-lucide="pencil"></i></button>' +
          '</span>';
        var terminalBtn = '<button type="button" class="initiative-icon-terminal" data-init-cmd="' + escapeAttr(name) + '" data-init-path="' + escapeAttr(path || '') + '" title="Send command to agent"><i data-lucide="terminal"></i></button>';
        var orderupPrepBtn = '<button type="button" class="initiative-orderup-prep" data-orderup-prep="' + escapeAttr(name) + '" title="Add prep work for Order Up"><img src="/images/orderup.png" alt="Order Up" /></button>';
        var label = escapeHtml(name);
        var statusBadge = getInitiativeStatusBadge(name);
        var textBlock = '<span class="init-card-text"><span>' + label + '</span>' + statusBadge + '</span>';
        var cursorBtn = path ? '<a href="' + (toolLink(path) || '#') + '" class="initiative-card__btn initiative-card__btn--cursor" title="' + toolOpenTitle() + '" onclick="event.stopPropagation()"><i data-lucide="external-link"></i></a>' : '';
        var chatBtnHtml = '<button type="button" class="initiative-card__btn initiative-card__btn--chat" data-init-chat="' + escapeAttr(name) + '" data-init-path="' + escapeAttr(path || '') + '" title="Open agent chat" onclick="event.stopPropagation()"><i data-lucide="message-circle"></i></button>';
        var cardButtons = '<span class="initiative-card__buttons">' + cursorBtn + chatBtnHtml + '</span>';
        html += '<div class="initiative-card" draggable="true" data-initiative-name="' + escapeAttr(name) + '">' + iconWithEdit + textBlock + cardButtons + terminalBtn + orderupPrepBtn + '</div>';
      }
      cardsRoot.innerHTML = html;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    /** Add a placeholder initiative card while creating */
    function addPlaceholderInitiativeCard(name) {
      var cardsRoot = document.getElementById('initiative-cards-root');
      if (!cardsRoot) return;
      var placeholder = document.createElement('div');
      placeholder.className = 'initiative-card initiative-card--creating';
      placeholder.id = 'creating-initiative-' + name;
      placeholder.innerHTML = '<span class="initiative-icon-placeholder initiative-icon-placeholder--loading">⟳</span><span>' + escapeHtml(name) + '</span>';
      cardsRoot.insertBefore(placeholder, cardsRoot.firstChild);
    }

    /** Update placeholder card with the real icon */
    function updatePlaceholderWithIcon(name, imagePath) {
      var placeholder = document.getElementById('creating-initiative-' + name);
      if (!placeholder) return;
      var iconEl = placeholder.querySelector('.initiative-icon-placeholder');
      if (iconEl) {
        var img = document.createElement('img');
        img.src = imagePath + '?_t=' + Date.now();
        img.alt = '';
        img.className = 'initiative-icon';
        iconEl.parentNode.replaceChild(img, iconEl);
      }
      placeholder.classList.remove('initiative-card--creating');
    }

    /** Remove placeholder card */
    function removePlaceholderCard(name) {
      var placeholder = document.getElementById('creating-initiative-' + name);
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
      }
    }

    // Cached dashboard initiatives for chat PR switcher
    var _cachedInitiatives = []; // Array of { name, prs: [...] } from last render

    // Compute status for each initiative: "grill", "backburner", "prep", "idle"
    var initiativeStatuses = {}; // { name: "grill" | "backburner" | "prep" | "idle" }
    function computeInitiativeStatuses(initiatives) {
      initiativeStatuses = {};
      var initNames = new Set();
      // Check PRs
      for (var i = 0; i < (initiatives || []).length; i++) {
        var init = initiatives[i];
        if (!init.name || init.name === '—') continue;
        var prs = init.prs || [];
        for (var j = 0; j < prs.length; j++) {
          var pr = prs[j];
          var branch = (pr.branch || '').toLowerCase();
          if (branch === 'main' || branch === 'master') continue;
          initNames.add(init.name);
          if (isBackBurner(pr.repo, pr.number)) {
            if (!initiativeStatuses[init.name] || initiativeStatuses[init.name] === 'idle') {
              initiativeStatuses[init.name] = 'backburner';
            }
          } else {
            initiativeStatuses[init.name] = 'grill'; // active PR trumps all
          }
        }
      }
      // Check prep tasks
      var tasks = Object.values(initiativeTasks);
      for (var k = 0; k < tasks.length; k++) {
        var t = tasks[k];
        if (t.initiative && t.status !== 'complete' && t.status !== 'failed' && t.status !== 'cleared') {
          if (!initiativeStatuses[t.initiative] || initiativeStatuses[t.initiative] === 'idle') {
            initiativeStatuses[t.initiative] = 'prep';
          }
        }
      }
    }

    function getInitiativeStatusBadge(name) {
      var status = initiativeStatuses[name];
      if (status === 'grill') return '<span class="init-status-badge init-status--grill">On the Grill</span>';
      if (status === 'backburner') return '<span class="init-status-badge init-status--backburner">Back Burner</span>';
      if (status === 'prep') return '<span class="init-status-badge init-status--prep">In Prep</span>';
      return '<span class="init-status-badge init-status--idle">Idle</span>';
    }

    function render(data, newlyCreatedName) {
      _cachedInitiatives = data.initiatives || [];
      computeInitiativeStatuses(data.initiatives);
      renderInitiativeCards(data.allInitiatives || [], newlyCreatedName);
      // Populate available initiative names for the picker dropdown
      // Only show initiatives that DON'T have any open PRs
      availableInitiativeNames = [];
      var initiativesWithPRs = new Set();
      if (data.initiatives) {
        for (var i = 0; i < data.initiatives.length; i++) {
          var initName = data.initiatives[i].name;
          if (initName && initName !== '—') {
            initiativesWithPRs.add(initName.toLowerCase());
          }
        }
      }
      // Add all initiatives that don't have PRs
      if (data.allInitiatives) {
        for (var i = 0; i < data.allInitiatives.length; i++) {
          var name = data.allInitiatives[i].name;
          if (name && !initiativesWithPRs.has(name.toLowerCase())) {
            availableInitiativeNames.push(name);
          }
        }
      }
      if (data.error) {
        root.innerHTML = '<div class="card"><p class="error">' + escapeHtml(data.error) + '</p></div>';
        renderLocal(data.localBranches);
        loadEvents();
        return;
      }
      updated.textContent = data.updatedAt ? 'Updated ' + new Date(data.updatedAt).toLocaleString() : '—';
      if (!data.initiatives?.length) {
        root.innerHTML = '<div class="card"><p class="empty-state">No open PRs.</p></div>';
      } else {
      function previewLinks(p, deployStatus) {
        if (!p || (!p.viewer && !p.creator && !p.storybook)) return '<span class="check-icon none">—</span>';
        var ds = deployStatus || {};
        const parts = [];
        if (p.viewer) parts.push('<a href="' + escapeUri(p.viewer) + '" class="preview-link preview-link--' + (ds.viewer || 'none') + '" target="_blank" rel="noopener" title="Viewer' + (ds.viewer ? ' (' + ds.viewer + ')' : '') + '">' + previewDeployDot(ds.viewer) + 'Viewer</a>');
        if (p.creator) parts.push('<a href="' + escapeUri(p.creator) + '" class="preview-link preview-link--' + (ds.creator || 'none') + '" target="_blank" rel="noopener" title="Creator' + (ds.creator ? ' (' + ds.creator + ')' : '') + '">' + previewDeployDot(ds.creator) + 'Creator</a>');
        if (p.storybook) parts.push('<a href="' + escapeUri(p.storybook) + '" class="preview-link preview-link--' + (ds.storybook || 'none') + '" target="_blank" rel="noopener" title="Storybook' + (ds.storybook ? ' (' + ds.storybook + ')' : '') + '">' + previewDeployDot(ds.storybook) + 'Storybook</a>');
        return '<div class="preview-links">' + parts.join('') + '</div>';
      }
      // --- Separate PRs into active vs back-burnered ---
      var activePrGroups = [];
      var backBurnerPrGroups = [];
      var sortedTableInitiatives = sortInitiativesByOrder(data.initiatives);
      for (const init of sortedTableInitiatives) {
        var filteredPrs = (init.prs || []).filter(function(pr) {
          var branch = (pr.branch || pr.headRefName || '').toLowerCase();
          return branch !== 'main' && branch !== 'master';
        });
        var active = filteredPrs.filter(function(pr) { return !isBackBurner(pr.repo, pr.number); });
        var burnered = filteredPrs.filter(function(pr) { return isBackBurner(pr.repo, pr.number); });
        if (active.length) activePrGroups.push({ name: init.name, prs: sortPrsByPlatform(active) });
        if (burnered.length) backBurnerPrGroups.push({ name: init.name, prs: sortPrsByPlatform(burnered) });
      }

      // Helper to build a PR table section
      var prTableHeaders = '<thead><tr><th>Initiative</th><th>Repo / PR</th><th><span class="th-icon" title="Agent Status"><i data-lucide="bot"></i></span></th><th><span class="th-icon" title="Actions"><i data-lucide="zap"></i></span></th><th><span class="th-icon" title="Unresolved comments"><i data-lucide="message-square"></i></span></th><th colspan="5" class="checks-header"><div class="checks-header-icons"><span class="th-icon" title="Lint checks"><i data-lucide="sparkles"></i></span><span class="th-icon" title="Type checks"><i data-lucide="file-type"></i></span><span class="th-icon" title="Test results"><i data-lucide="flask-conical"></i></span><span class="th-icon" title="E2E tests"><i data-lucide="monitor-check"></i></span><span class="th-icon" title="Other checks"><i data-lucide="circle-ellipsis"></i></span></div></th><th><span class="th-icon" title="Preview links"><i data-lucide="external-link"></i></span></th></tr></thead>';

      function buildPrGroupRows(groups) {
        var rows = '';
        for (var g = 0; g < groups.length; g++) {
          var grp = groups[g];
          var groupLabel = grp.name === '—' ? 'No initiative' : escapeHtml(grp.name);
          var groupIcon = initiativeIconHtml(grp.name);
          var groupPath = (grp.prs && grp.prs.length > 0 && grp.prs[0].initiativePath) ? grp.prs[0].initiativePath : '';
          var groupHref = (grp.name !== '—' && groupPath) ? toolLink(groupPath) : null;
          var groupNameHtml = groupHref
            ? '<a href="' + groupHref + '" class="init" title="' + toolOpenTitle() + '">' + groupLabel + '</a>'
            : groupLabel;
          var groupCell = groupIcon ? '<span class="initiative-with-icon">' + groupIcon + groupNameHtml + '</span>' : groupNameHtml;
          var focusValue = getInitiativeFocus(grp.name);
          var focusInput = grp.name !== '—'
            ? '<input type="text" class="initiative-focus-input" data-initiative="' + escapeHtml(grp.name) + '" placeholder="What\'s the focus?" value="' + escapeHtml(focusValue).replace(/"/g, '&quot;') + '" />'
            : '';
          // Build back-burner buttons for all PRs in this group (data attrs hold all repo#numbers)
          var bbData = '';
          for (var bp = 0; bp < grp.prs.length; bp++) {
            bbData += (bp > 0 ? ',' : '') + grp.prs[bp].repo + '#' + grp.prs[bp].number;
          }
          var anyOnBB = grp.prs.some(function(pr) { return isBackBurner(pr.repo, pr.number); });
          var bbBtn = grp.name !== '—' ? '<button type="button" class="back-burner-btn back-burner-group-btn' + (anyOnBB ? ' active' : '') + '" title="' + (anyOnBB ? 'Move back to active' : 'Move to back burner') + '" data-bb-prs="' + escapeAttr(bbData) + '"><i data-lucide="flame"></i></button>' : '';
          rows += '<tr class="initiative-group-header" data-initiative="' + escapeHtml(grp.name) + '"><td colspan="10"><div>' + groupCell + focusInput + '</div></td><td class="back-burner-cell">' + bbBtn + '</td></tr>';
          for (var p = 0; p < grp.prs.length; p++) {
            var pr = grp.prs[p];
            var conflictsAttr = hasConflicts(pr) ? ' data-has-conflicts="true"' : '';
            rows += '<tr data-repo="' + escapeAttr(pr.repo) + '" data-number="' + pr.number + '" data-path="' + escapeAttr(pr.initiativePath || '') + '"' + conflictsAttr + '>' + buildPrRowCells(pr) + '</tr>';
          }
        }
        return rows;
      }

      // --- Section 1: Orders on the Grill (active PRs) ---
      let html = '<div class="card"><div class="card-header">Orders on the Grill</div><div class="table-wrap"><table>' + prTableHeaders + '<tbody>';
      html += buildPrGroupRows(activePrGroups);
      if (activePrGroups.length === 0) {
        html += '<tr><td colspan="11" style="text-align:center; padding:2rem; color:var(--text-muted);">No active PRs — all clear!</td></tr>';
      }
      html += '</tbody></table></div></div>';

      // --- Section 2: Prep Work (non-PR initiative tasks) ---
      html += '<div class="card" id="prep-work-card" style="margin-top: var(--space);"><div class="card-header">Prep Work</div><div class="table-wrap"><table><thead><tr><th>Initiative</th><th>Task</th><th><span class="th-icon" title="Agent Status"><i data-lucide="bot"></i></span></th><th></th></tr></thead><tbody id="prep-work-body">';
      html += '</tbody></table></div></div>';

      // --- Section 3: Back Burner (draft PRs) ---
      if (backBurnerPrGroups.length > 0) {
        html += '<div class="card back-burner-section" style="margin-top: var(--space);"><div class="card-header">Back Burner</div><div class="table-wrap"><table>' + prTableHeaders + '<tbody>';
        html += buildPrGroupRows(backBurnerPrGroups);
        html += '</tbody></table></div></div>';
      }
      root.innerHTML = html;
      if (typeof lucide !== 'undefined') lucide.createIcons();
      }
      // Update unassigned PRs dropdown
      updateUnassignedDropdown(data.initiatives);
      renderLocal(data.localBranches);
      loadEvents();
      loadInitiativeTasks();
    }

    function updateUnassignedDropdown(initiatives) {
      var countEl = document.getElementById('unassigned-count');
      var menuEl = document.getElementById('unassigned-menu');
      if (!countEl || !menuEl) return;
      
      // Find PRs with no initiative (name === '—')
      var unassignedPrs = [];
      for (var i = 0; i < (initiatives || []).length; i++) {
        var init = initiatives[i];
        if (init.name === '—') {
          for (var j = 0; j < (init.prs || []).length; j++) {
            unassignedPrs.push(init.prs[j]);
          }
        }
      }
      
      countEl.textContent = unassignedPrs.length;
      countEl.style.display = unassignedPrs.length > 0 ? '' : 'none';
      
      if (unassignedPrs.length === 0) {
        menuEl.innerHTML = '<div class="unassigned-dropdown__empty">No unassigned PRs</div>';
        return;
      }
      
      var menuHtml = '';
      for (var k = 0; k < unassignedPrs.length; k++) {
        var pr = unassignedPrs[k];
        var repoShort = (pr.repo || '').split('/').pop() || pr.repo;
        var branch = pr.branch || pr.headRefName || '';
        var title = pr.title || 'PR #' + pr.number;
        menuHtml += '<div class="unassigned-dropdown__item" ' +
          'data-repo="' + escapeAttr(pr.repo) + '" ' +
          'data-branch="' + escapeAttr(branch) + '" ' +
          'data-number="' + pr.number + '">' +
          '<div class="unassigned-dropdown__item-info">' +
            '<span class="unassigned-dropdown__item-title" title="' + escapeAttr(title) + '">' + escapeHtml(title) + '</span>' +
            '<div class="unassigned-dropdown__item-meta">' +
              '<span class="unassigned-dropdown__item-repo">' + escapeHtml(repoShort) + ' #' + pr.number + '</span>' +
              (branch ? '<span class="unassigned-dropdown__item-branch">' + escapeHtml(branch) + '</span>' : '') +
            '</div>' +
          '</div>' +
          '<button type="button" class="unassigned-dropdown__item-action">Checkout</button>' +
        '</div>';
      }
      menuEl.innerHTML = menuHtml;
    }

    function renderLocal(localBranches) {
      var localRoot = document.getElementById('local-root');
      if (!localRoot) return;
      var rows = localBranches;
      if (!Array.isArray(rows) || rows.length === 0) {
        localRoot.innerHTML = '<p class="empty-state">No local subfolders (backend, nugs, frontrow-creator-ios, frontrow-creator-android) found in initiative folders.</p>';
        return;
      }
      var localHtml = '<div class="table-wrap"><table><thead><tr><th>Initiative</th><th>Subfolder</th><th>Branch</th><th>PR</th><th>Title</th><th>Repo</th></tr></thead><tbody>';
      for (var i = 0; i < rows.length; i++) {
        var r = rows[i];
        var initPath = (r.path || '').trim();
        var branchHref = initPath ? toolLink(initPath) : null;
        var initLink = branchHref
          ? '<a href="' + branchHref + '" class="init" title="' + toolOpenTitle() + '">' + escapeHtml(r.initiative) + '</a>'
          : escapeHtml(r.initiative);
        var initIcon = initiativeIconHtml(r.initiative);
        var initCellLocal = initIcon ? '<span class="initiative-with-icon">' + initIcon + initLink + '</span>' : initLink;
        var prCell = r.prNumber != null
          ? '<a href="https://github.com/' + escapeHtml(r.repo) + '/pull/' + r.prNumber + '" target="_blank" rel="noopener">#' + r.prNumber + '</a>'
          : '<span class="check-icon none">—</span>';
        var titleCell = r.prTitle != null
          ? '<span title="' + escapeAttr(r.prTitle) + '">' + escapeHtml(r.prTitle.slice(0, 55)) + (r.prTitle.length > 55 ? '…' : '') + '</span>'
          : '<span class="check-icon none">—</span>';
        localHtml += '<tr><td>' + initCellLocal + '</td><td>' + escapeHtml(r.subfolder) + '</td><td><code>' + escapeHtml(r.branch) + '</code></td><td>' + prCell + '</td><td>' + titleCell + '</td><td>' + escapeHtml(r.repo) + '</td></tr>';
      }
      localHtml += '</tbody></table></div>';
      localRoot.innerHTML = localHtml;
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function escapeAttr(s) {
      // Escape for HTML attributes (quotes and special chars)
      return (s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function escapeUri(s) {
      // URL encode for href attributes
      return encodeURI(s || '').replace(/[#?]/g, encodeURIComponent);
    }

    // Sprite sheet configs for chef animations
    // Defaults can be overridden by the sprite editor (saved in localStorage)
    var SPRITE_DEFAULTS = {
      running: { url: '/images/sprite-running.png', sheetW: 772, sheetH: 1024, cols: 6, rows: 6, totalFrames: 36, fps: 15 },
      jumping: { url: '/images/sprite-jumping.png', sheetW: 686, sheetH: 1024, cols: 6, rows: 6, totalFrames: 36, fps: 15 },
      grilling: { url: '/images/sprite-grilling.png', sheetW: 945, sheetH: 1024, cols: 6, rows: 6, totalFrames: 36, fps: 15 }
    };

    function loadSpriteConfig(name) {
      // Try loading pre-computed frames from sprite editor
      try {
        var saved = localStorage.getItem('orderup_sprite_' + name + '_frames');
        if (saved) {
          var data = JSON.parse(saved);
          if (data && data.frames && data.frames.length > 0) return data;
        }
      } catch(e) {}
      return SPRITE_DEFAULTS[name];
    }

    var SPRITE_RUNNING = loadSpriteConfig('running');
    var SPRITE_JUMPING = loadSpriteConfig('jumping');
    var SPRITE_GRILLING = loadSpriteConfig('grilling');

    // Get frame from pre-computed array or calculate from grid
    function getSpriteFrame(sprite, frameIndex) {
      var fi = frameIndex % (sprite.totalFrames || 42);
      // If we have pre-computed frames from the sprite editor, use those
      if (sprite.frames && sprite.frames[fi]) {
        return sprite.frames[fi];
      }
      // Fallback: calculate from grid
      var cols = sprite.cols || 6;
      var rows = sprite.rows || 7;
      var col = fi % cols;
      var row = Math.floor(fi / cols);
      var w = Math.round(sprite.sheetW / cols);
      var h = Math.round(sprite.sheetH / rows);
      return { x: col * w, y: row * h, w: w, h: h };
    }
    var CHEF_RUN_JUMP_FRAMES_KEY = 'orderup_chef_run_jump_frames';
    var DEFAULT_FRAME_COORDS = {
      imageWidth: 2245,
      imageHeight: 600,
      frames: [
        { x: 4, y: 0, w: 550, h: 600 },
        { x: 575, y: 0, w: 550, h: 600 },
        { x: 1160, y: 0, w: 550, h: 600 },
        { x: 1695, y: 0, w: 550, h: 600 }
      ]
    };
    function getFrameCoords() {
      try {
        var raw = localStorage.getItem(CHEF_RUN_JUMP_FRAMES_KEY);
        if (raw) {
          var data = JSON.parse(raw);
          if (data && data.frames && data.frames.length > 0) return data;
        }
      } catch (e) {}
      return null;
    }
    function saveFrameCoords(data) {
      try {
        localStorage.setItem(CHEF_RUN_JUMP_FRAMES_KEY, JSON.stringify(data));
      } catch (e) {}
    }
    function frameCoordsInit() {
      var tbody = document.getElementById('frame-coords-tbody');
      var saveBtn = document.getElementById('frame-coords-save');
      var resetBtn = document.getElementById('frame-coords-reset');
      var loadDefaultsBtn = document.getElementById('frame-coords-load-defaults');
      var savedMsg = document.getElementById('frame-coords-saved-msg');
      if (!tbody || !saveBtn) return;
      function fromStorage() {
        var data = getFrameCoords();
        if (!data) data = DEFAULT_FRAME_COORDS;
        return data;
      }
      function fillInputs(data) {
        data.frames.forEach(function(f, i) {
          ['x', 'y', 'w', 'h'].forEach(function(field) {
            var el = tbody.querySelector('input[data-frame="' + i + '"][data-field="' + field + '"]');
            if (el && f[field] != null) el.value = f[field];
          });
        });
      }
      function updatePreview() {
        var imgW = DEFAULT_FRAME_COORDS.imageWidth;
        var imgH = DEFAULT_FRAME_COORDS.imageHeight;
        var previewHeight = 64;
        for (var i = 0; i < 4; i++) {
          var x = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="x"]').value, 10);
          var y = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="y"]').value, 10);
          var w = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="w"]').value, 10);
          var h = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="h"]').value, 10);
          if (isNaN(x)) x = DEFAULT_FRAME_COORDS.frames[i].x;
          if (isNaN(y)) y = DEFAULT_FRAME_COORDS.frames[i].y;
          if (isNaN(w)) w = DEFAULT_FRAME_COORDS.frames[i].w;
          if (isNaN(h)) h = DEFAULT_FRAME_COORDS.frames[i].h;
          if (h <= 0) h = 600;
          var scale = previewHeight / h;
          var previewEl = tbody.querySelector('.frame-coords-preview[data-frame="' + i + '"]');
          if (previewEl) {
            previewEl.style.width = Math.round(w * scale) + 'px';
            previewEl.style.height = Math.round(previewHeight) + 'px';
            previewEl.style.backgroundSize = (imgW * scale) + 'px ' + (imgH * scale) + 'px';
            previewEl.style.backgroundPosition = (-x * scale) + 'px ' + (-y * scale) + 'px';
          }
        }
      }
      fillInputs(fromStorage());
      updatePreview();
      tbody.querySelectorAll('input[data-frame][data-field]').forEach(function(inp) {
        inp.addEventListener('input', updatePreview);
        inp.addEventListener('change', updatePreview);
      });
      saveBtn.addEventListener('click', function() {
        var data = { imageWidth: DEFAULT_FRAME_COORDS.imageWidth, imageHeight: DEFAULT_FRAME_COORDS.imageHeight, frames: [] };
        for (var i = 0; i < 4; i++) {
          var x = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="x"]').value, 10);
          var y = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="y"]').value, 10);
          var w = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="w"]').value, 10);
          var h = parseInt(tbody.querySelector('input[data-frame="' + i + '"][data-field="h"]').value, 10);
          if (isNaN(x)) x = DEFAULT_FRAME_COORDS.frames[i].x;
          if (isNaN(y)) y = DEFAULT_FRAME_COORDS.frames[i].y;
          if (isNaN(w)) w = DEFAULT_FRAME_COORDS.frames[i].w;
          if (isNaN(h)) h = DEFAULT_FRAME_COORDS.frames[i].h;
          data.frames.push({ x: x, y: y, w: w, h: h });
        }
        saveFrameCoords(data);
        if (savedMsg) { savedMsg.textContent = 'Saved.'; setTimeout(function() { savedMsg.textContent = ''; }, 2000); }
      });
      if (loadDefaultsBtn) loadDefaultsBtn.addEventListener('click', function() {
        fillInputs(DEFAULT_FRAME_COORDS);
        updatePreview();
        if (savedMsg) { savedMsg.textContent = 'Loaded defaults (click Save to apply).'; setTimeout(function() { savedMsg.textContent = ''; }, 3000); }
      });
      if (resetBtn) resetBtn.addEventListener('click', function() {
        saveFrameCoords(DEFAULT_FRAME_COORDS);
        fillInputs(DEFAULT_FRAME_COORDS);
        updatePreview();
        if (savedMsg) { savedMsg.textContent = 'Reset to default.'; setTimeout(function() { savedMsg.textContent = ''; }, 2000); }
      });
    }
    var loadingGameState = { chefY: 0, chefVy: 0, lastFrameTime: 0, state: 'playing', deathStartTime: 0, respawnAt: 0, invincibleUntil: 0, score: 0, jumpedFoods: {} };
    var LOADING_GAME_HIGH_KEY = 'prWatcher_loadingGameHigh';
    var loadingGameHighScore = 0;
    try {
      var storedGameHigh = localStorage.getItem(LOADING_GAME_HIGH_KEY);
      if (storedGameHigh) loadingGameHighScore = parseInt(storedGameHigh, 10) || 0;
    } catch (e) {}
    
    function updateLoadingGameHighScore() {
      if (loadingGameState.score > loadingGameHighScore) {
        loadingGameHighScore = loadingGameState.score;
        try { localStorage.setItem(LOADING_GAME_HIGH_KEY, String(loadingGameHighScore)); } catch (e) {}
        // Update the stat display
        var el = document.getElementById('stat-game-high');
        if (el) {
          el.textContent = formatArcadeNumber(loadingGameHighScore, 2);
          el.classList.remove('bump');
          void el.offsetWidth;
          el.classList.add('bump');
        }
      }
    }
    
    function renderLoadingGameHighScore() {
      var el = document.getElementById('stat-game-high');
      if (el) el.textContent = formatArcadeNumber(loadingGameHighScore, 2);
    }
    
    // Build food items HTML for loading game from all initiatives
    function buildLoadingFoodItems() {
      var initiatives = cachedInitiatives || [];
      // Default fallback if no cached initiatives
      if (initiatives.length === 0) {
        initiatives = [
          { name: 'burger' }, { name: 'fries' }, { name: 'cola' },
          { name: 'milkshake' }, { name: 'nuggies' }, { name: 'sauce' }
        ];
      }
      var html = '';
      var delay = 0;
      var delayStep = 0.7; // seconds between each food item
      for (var i = 0; i < initiatives.length; i++) {
        var name = initiatives[i].name || initiatives[i];
        html += '<img src="/images/initiatives/' + escapeAttr(name) + '.png" alt="" class="loading-stage__food" style="animation-delay: ' + delay.toFixed(2) + 's;" />';
        delay += delayStep;
      }
      return html;
    }
    
    function buildLoadingStageHtml() {
      return '<div class="card loading-card"><div class="loading-stage" aria-hidden="true"><p class="loading-stage__title">Checking the kitchen…</p><div class="loading-stage__score" id="loading-game-score">SCORE: 0</div><div class="loading-stage__food-track">' + buildLoadingFoodItems() + '</div><div class="loading-stage__chef" role="img" aria-hidden="true"></div><div class="loading-stage__ground"></div><span class="loading-stage__hint"><kbd>W</kbd> to jump</span></div></div>';
    }
    function updateLoadingScore() {
      var el = document.getElementById('loading-game-score');
      if (el) el.textContent = 'SCORE: ' + loadingGameState.score;
      updateLoadingGameHighScore();
    }
    function initLoadingGame() {
      var chef = document.querySelector('.loading-stage__chef');
      if (!chef) return;
      var foods = document.querySelectorAll('.loading-stage__food');
      loadingGameState.chefY = 0;
      loadingGameState.chefVy = 0;
      loadingGameState.lastFrameTime = performance.now();
      loadingGameState.state = 'playing';
      loadingGameState.score = 0;
      loadingGameState.jumpedFoods = {};
      updateLoadingScore();
      var displayHeight = 64;
      var blinkInterval = 100;
      var blinkCount = 4;
      var respawnDelay = 1000;
      function loop(now) {
        if (!document.querySelector('.loading-stage__chef')) return;
        var c = document.querySelector('.loading-stage__chef');

        if (loadingGameState.state === 'dying') {
          var elapsed = now - loadingGameState.deathStartTime;
          var step = Math.floor(elapsed / blinkInterval);
          if (step < blinkCount) {
            c.style.opacity = step % 2 === 0 ? '0.35' : '1';
            c.classList.add('loading-stage__chef--dead');
          } else {
            c.style.opacity = '0';
            c.style.visibility = 'hidden';
            loadingGameState.state = 'respawning';
            loadingGameState.respawnAt = now + respawnDelay;
          }
          requestAnimationFrame(loop);
          return;
        }

        if (loadingGameState.state === 'respawning') {
          if (now >= loadingGameState.respawnAt) {
            loadingGameState.state = 'playing';
            loadingGameState.chefY = 0;
            loadingGameState.chefVy = 0;
            loadingGameState.lastFrameTime = now;
            loadingGameState.invincibleUntil = now + 1800;
            c.style.opacity = '1';
            c.style.visibility = 'visible';
            c.classList.remove('loading-stage__chef--dead');
          }
          requestAnimationFrame(loop);
          return;
        }

        var dt = Math.min((now - loadingGameState.lastFrameTime) / 16, 4);
        loadingGameState.chefVy -= 0.55 * dt;
        loadingGameState.chefY += loadingGameState.chefVy * dt;
        if (loadingGameState.chefY < 0) {
          loadingGameState.chefY = 0;
          loadingGameState.chefVy = 0;
        }
        // Select sprite sheet and frame based on state
        var isJumping = loadingGameState.chefY > 0;
        c.style.transform = isJumping
          ? 'scale(1.6, 1.6) translateY(' + (-loadingGameState.chefY) + 'px)'
          : 'scale(-1.4, 1.4) translateY(' + (-loadingGameState.chefY) + 'px)';
        var sprite = isJumping ? SPRITE_JUMPING : SPRITE_RUNNING;
        
        // Animate through all 42 frames at ~15fps
        if (!loadingGameState.animFrame) loadingGameState.animFrame = 0;
        if (!loadingGameState.lastAnimTime) loadingGameState.lastAnimTime = 0;
        var animInterval = 67; // ~15fps
        if (now - loadingGameState.lastAnimTime > animInterval) {
          loadingGameState.animFrame = (loadingGameState.animFrame + 1) % sprite.totalFrames;
          loadingGameState.lastAnimTime = now;
        }
        
        // Reset frame counter when switching between run/jump
        if (loadingGameState.wasJumping !== isJumping) {
          loadingGameState.animFrame = 0;
          loadingGameState.wasJumping = isJumping;
        }
        
        var f = getSpriteFrame(sprite, loadingGameState.animFrame);
        var scale = displayHeight / f.h;
        c.style.width = Math.round(f.w * scale) + 'px';
        c.style.height = Math.round(f.h * scale) + 'px';
        c.style.backgroundImage = 'url(' + sprite.url + ')';
        c.style.backgroundSize = Math.round(sprite.sheetW * scale) + 'px ' + Math.round(sprite.sheetH * scale) + 'px';
        c.style.backgroundPosition = Math.round(-f.x * scale) + 'px ' + Math.round(-f.y * scale) + 'px';
        c.style.filter = 'none';
        // Check for jumping over food (score points) or collision (death)
        for (var i = 0; i < foods.length; i++) {
          var fr = foods[i].getBoundingClientRect();
          var cr = c.getBoundingClientRect();
          var foodKey = 'food_' + i + '_' + Math.floor(fr.left / 100); // Unique key per food pass
          
          // Check if food is passing under chef while jumping
          if (loadingGameState.chefY > 20 && fr.right >= cr.left && fr.left <= cr.right) {
            if (!loadingGameState.jumpedFoods[foodKey]) {
              loadingGameState.jumpedFoods[foodKey] = true;
              loadingGameState.score++;
              updateLoadingScore();
            }
          }
          
          // Collision detection (only when on ground and not invincible)
          if (loadingGameState.chefY === 0 && now > loadingGameState.invincibleUntil) {
            if (fr.right >= cr.left && fr.left <= cr.right && fr.bottom >= cr.top && fr.top <= cr.bottom) {
              loadingGameState.score++; // +1 point for dying
              updateLoadingScore();
              loadingGameState.state = 'dying';
              loadingGameState.deathStartTime = now;
              break;
            }
          }
        }
        loadingGameState.lastFrameTime = now;
        requestAnimationFrame(loop);
      }
      if (!window._loadingGameKeydown) {
        window._loadingGameKeydown = true;
        document.addEventListener('keydown', function(e) {
          if (e.code !== 'KeyW') return;
          if (!document.querySelector('.loading-stage__chef')) return;
          if (loadingGameState.state !== 'playing') return;
          e.preventDefault();
          if (loadingGameState.chefY === 0) loadingGameState.chefVy = 11;
        });
      }
      requestAnimationFrame(loop);
    }
    // Load agent jobs from server
    async function loadAgentJobs() {
      try {
        console.log('[Agent Jobs] Loading from server...');
        var r = await fetch('/api/agent-jobs');
        var jobs = await r.json();
        agentJobs = {};
        for (var i = 0; i < jobs.length; i++) {
          var job = jobs[i];
          agentJobs[job.id] = job;
        }
        console.log('[Agent Jobs] Loaded ' + jobs.length + ' jobs:', Object.keys(agentJobs));
      } catch (e) {
        console.error('[Agent Jobs] Failed to load:', e);
      }
    }
    
    // Update agent status UI for a PR row (badge on button + inline banner)
    function updateAgentBadge(repo, number) {
      var row = document.querySelector('tr[data-repo="' + repo + '"][data-number="' + number + '"]');
      if (!row) return;
      var key = repo + '#' + number;
      var job = agentJobs[key];

      // Update dot badge on terminal button
      var btn = row.querySelector('.custom-cmd-btn');
      if (btn) {
        var old = btn.querySelector('.agent-badge');
        if (old) old.remove();
        if (!job) {
          btn.style.borderColor = '';
          btn.style.boxShadow = '';
        } else {
          var dot = document.createElement('span');
          dot.className = 'agent-badge agent-badge--' + job.status;
          btn.appendChild(dot);
          if (job.status === 'running') { btn.style.borderColor = '#3b82f6'; btn.style.boxShadow = '0 0 6px rgba(59,130,246,0.5)'; }
          else if (job.status === 'complete') { btn.style.borderColor = '#10b981'; btn.style.boxShadow = '0 0 6px rgba(16,185,129,0.5)'; }
          else if (job.status === 'failed') { btn.style.borderColor = '#ef4444'; btn.style.boxShadow = '0 0 6px rgba(239,68,68,0.5)'; }
          else { btn.style.borderColor = '#6b7280'; btn.style.boxShadow = '0 0 4px rgba(107,114,128,0.4)'; }
        }
      }

      // Update agent status cell banner
      var statusCell = row.querySelector('.agent-status-cell');
      if (!statusCell) return;

      if (!job || job.status === 'cleared') {
        statusCell.innerHTML = '';
        return;
      }
      var bannerIcon = 'clock';
      var bannerText = 'Pending...';
      if (job.status === 'running') { bannerIcon = 'loader-2'; bannerText = 'Agent running'; }
      else if (job.status === 'complete') { bannerIcon = 'check-circle'; bannerText = 'Agent done'; }
      else if (job.status === 'failed') { bannerIcon = 'alert-circle'; bannerText = 'Agent failed'; }
      var bannerClass = 'agent-banner agent-banner--' + job.status;
      var grillSprite = (job.status === 'pending' || job.status === 'running') ? '<span class="chef-grilling"></span> ' : '';

      var rowPath = row.getAttribute('data-path') || '';
      var sseHref = toolLink(rowPath);
      if (sseHref) {
        statusCell.innerHTML = '<a href="' + sseHref + '" class="' + bannerClass + '">' + grillSprite + bannerText + '</a>';
      } else {
        statusCell.innerHTML = '<div class="' + bannerClass + '">' + grillSprite + bannerText + '</div>';
      }
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Auto-remove "complete" banner after 10 seconds
      if (job.status === 'complete') {
        setTimeout(function() {
          var b = row.querySelector('.agent-banner--complete');
          if (b) {
            b.style.transition = 'opacity 0.3s';
            b.style.opacity = '0';
            setTimeout(function() { if (b.parentNode) b.parentNode.innerHTML = ''; }, 350);
          }
          if (btn) {
            var d = btn.querySelector('.agent-badge');
            if (d) d.remove();
            btn.style.borderColor = '';
            btn.style.boxShadow = '';
          }
        }, 10000);
      }
    }

    // Create a pending agent job (called when copying a command)
    function createPendingJob(repo, number, type) {
      var id = repo + '#' + number;
      console.log('[Agent Job] Creating pending job:', id, 'type:', type || 'all');
      
      // Update local state immediately
      agentJobs[id] = {
        id: id,
        repo: repo,
        number: number,
        type: type || 'all',
        status: 'pending',
        startedAt: Date.now()
      };
      
      // Send to server
      console.log('[Agent Job] Sending to server...');
      fetch('/api/agent-job', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ repo: repo, number: number, status: 'pending', type: type || 'all' })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        console.log('[Agent Job] Server response:', JSON.stringify(data));
      })
      .catch(function(e) {
        console.error('[Agent Job] Failed to create pending job:', e);
      });
      
      // Update the custom-cmd button badge to reflect agent status
      updateAgentBadge(repo, number);
    }
    
    async function load(newlyCreatedName) {
      // Keep initiative cards visible during loading by rendering from cache
      if (cachedInitiatives && cachedInitiatives.length > 0) {
        renderInitiativeCards(cachedInitiatives, null, true);
      }
      root.innerHTML = buildLoadingStageHtml();
      initLoadingGame();
      refreshBtn.disabled = true;
      refreshBtn.textContent = 'Refreshing…';
      try {
        // Load agent jobs and status in parallel
        await loadAgentJobs();
        const r = await fetch('/api/status');
        const data = await r.json();
        render(data, newlyCreatedName);
      } catch (e) {
        render({ error: e.message });
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Refresh';
      }
    }

    const eventsList = document.getElementById('events-list');
    const EVENTS_POLL_MS = 30000; // Poll every 30 seconds
    const PR_REFRESH_POLL_MS = 30000; // Auto-refresh PR data every 30 seconds

    function renderEvents(data) {
      if (!eventsList) return;
      const parent = eventsList.parentElement;
      if (data.error) {
        eventsList.innerHTML = '<li class="error">' + escapeHtml(data.error) + '</li>';
        return;
      }
      const events = data.events || [];
      if (events.length === 0) {
        eventsList.innerHTML = '<li class="empty-state">No recent activity for tracked PRs.</li>';
        return;
      }
      eventsList.innerHTML = events.map(function(e) {
        const time = e.created_at ? new Date(e.created_at).toLocaleString() : '';
        const summary = escapeHtml(e.summary);
        const actor = e.actor ? ' by <span class="event-actor">' + escapeHtml(e.actor) + '</span>' : '';
        const line = escapeHtml(e.repo) + ' <strong>#' + e.number + '</strong> · ' + summary + actor;
        const url = (e.url || '').trim();
        const body = url
          ? '<a href="' + escapeUri(url) + '" target="_blank" rel="noopener" class="event-body">' + line + '</a>'
          : '<span class="event-body">' + line + '</span>';
        return '<li><span class="event-time">' + escapeHtml(time) + '</span>' + body + '</li>';
      }).join('');
    }

    // Track last seen event timestamps per PR to detect new events
    var lastSeenEventTimestamps = {};
    
    async function loadEvents() {
      if (!eventsList) return;
      try {
        const r = await fetch('/api/events');
        const ct = r.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          renderEvents({ error: 'Server returned non-JSON. Restart the dashboard server (npm start in app/).' });
          return;
        }
        const data = await r.json();
        renderEvents(data);
        
        // Check for new events and refresh affected PRs
        if (data.events && data.events.length > 0) {
          var prsToRefresh = new Set();
          
          for (var i = 0; i < data.events.length; i++) {
            var evt = data.events[i];
            var prKey = evt.repo + '#' + evt.number;
            var eventTime = new Date(evt.created_at).getTime();
            
            // If we haven't seen this PR before, or this event is newer
            if (!lastSeenEventTimestamps[prKey] || eventTime > lastSeenEventTimestamps[prKey]) {
              // Only refresh if we had a previous timestamp (skip first load)
              if (lastSeenEventTimestamps[prKey]) {
                prsToRefresh.add(prKey);
              }
              lastSeenEventTimestamps[prKey] = eventTime;
            }
          }
          
          // Refresh PRs that have new events
          prsToRefresh.forEach(function(prKey) {
            var parts = prKey.split('#');
            var repo = parts[0];
            var num = parts[1];
            refreshPrRowWithAnimation(repo, num);
          });
        }
      } catch (e) {
        renderEvents({ error: e.message });
      }
    }
    
    // Refresh a single PR row and apply coin animation
    async function refreshPrRowWithAnimation(repo, num) {
      var row = document.querySelector('tr[data-repo="' + repo + '"][data-number="' + num + '"]');
      if (!row) return;
      
      try {
        var r = await fetch('/api/pr?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num));
        var data = await r.json();
        if (data.pr) {
          row.innerHTML = buildPrRowCells(data.pr);
          if (typeof lucide !== 'undefined') lucide.createIcons();
          
          // Apply Mario coin bounce animation to check icons
          var checkIcons = row.querySelectorAll('.check-icon');
          checkIcons.forEach(function(icon) {
            icon.classList.add('coin-bounce');
            setTimeout(function() {
              icon.classList.remove('coin-bounce');
            }, 600);
          });
          
          // Apply bounce to unresolved comments with special style
          var commentsEl = row.querySelector('.comments-unresolved');
          if (commentsEl) {
            commentsEl.classList.add('coin-bounce-comments');
            setTimeout(function() {
              commentsEl.classList.remove('coin-bounce-comments');
            }, 600);
          }
          
          // Flash the row background briefly
          row.style.transition = 'background-color 0.3s';
          row.style.backgroundColor = 'rgba(255, 215, 0, 0.15)';
          setTimeout(function() {
            row.style.backgroundColor = '';
          }, 1500);
          
          // Update conflicts attribute
          if (hasConflicts(data.pr)) {
            row.setAttribute('data-has-conflicts', 'true');
          } else {
            row.removeAttribute('data-has-conflicts');
          }
          
          showToast('PR #' + num + ' updated');
        }
      } catch (e) {
        console.error('Failed to refresh PR:', repo, num, e);
      }
    }

    // Unassigned PRs dropdown handlers
    var unassignedDropdown = document.getElementById('unassigned-dropdown');
    var unassignedBtn = document.getElementById('unassigned-dropdown-btn');
    if (unassignedDropdown && unassignedBtn) {
      unassignedBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        unassignedDropdown.classList.toggle('open');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!unassignedDropdown.contains(e.target)) {
          unassignedDropdown.classList.remove('open');
        }
      });
      
      // Handle item clicks
      unassignedDropdown.addEventListener('click', function(e) {
        var item = e.target.closest('.unassigned-dropdown__item');
        if (!item) return;
        
        var repo = item.getAttribute('data-repo');
        var branch = item.getAttribute('data-branch');
        var number = item.getAttribute('data-number');
        if (!repo || !branch) return;
        
        // Build the checkout command
        var repoShort = repo.split('/').pop() || repo;
        var checkoutCmd = 'cd ' + repoShort + ' && git fetch origin ' + branch + ' && git checkout ' + branch;
        
        // Copy to clipboard
        copyToClipboard(checkoutCmd, 'Checkout command copied!');
        
        // Close dropdown
        unassignedDropdown.classList.remove('open');
      });
    }

    // Initiative focus input handler (delegated to body for dynamic content)
    document.body.addEventListener('input', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('initiative-focus-input')) {
        var initName = e.target.getAttribute('data-initiative');
        if (initName) {
          setInitiativeFocus(initName, e.target.value);
        }
      }
    });

    // Initiative card drag and drop reordering
    var draggedCard = null;
    
    document.body.addEventListener('dragstart', function(e) {
      var card = e.target.closest('.initiative-card');
      if (!card) return;
      draggedCard = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.getAttribute('data-initiative-name'));
    });
    
    document.body.addEventListener('dragend', function(e) {
      var card = e.target.closest('.initiative-card');
      if (card) card.classList.remove('dragging');
      // Remove drag-over from all cards
      document.querySelectorAll('.initiative-card.drag-over').forEach(function(c) {
        c.classList.remove('drag-over');
      });
      draggedCard = null;
    });
    
    document.body.addEventListener('dragover', function(e) {
      var card = e.target.closest('.initiative-card');
      if (!card || card === draggedCard) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      // Remove drag-over from other cards
      document.querySelectorAll('.initiative-card.drag-over').forEach(function(c) {
        if (c !== card) c.classList.remove('drag-over');
      });
      card.classList.add('drag-over');
    });
    
    document.body.addEventListener('dragleave', function(e) {
      var card = e.target.closest('.initiative-card');
      if (card && !card.contains(e.relatedTarget)) {
        card.classList.remove('drag-over');
      }
    });
    
    document.body.addEventListener('drop', function(e) {
      var targetCard = e.target.closest('.initiative-card');
      if (!targetCard || !draggedCard || targetCard === draggedCard) return;
      e.preventDefault();
      targetCard.classList.remove('drag-over');
      
      var cardsRoot = document.getElementById('initiative-cards-root');
      if (!cardsRoot) return;
      
      // Determine insert position
      var cards = Array.from(cardsRoot.querySelectorAll('.initiative-card'));
      var targetIndex = cards.indexOf(targetCard);
      var draggedIndex = cards.indexOf(draggedCard);
      
      // Insert before or after based on position
      if (draggedIndex < targetIndex) {
        targetCard.parentNode.insertBefore(draggedCard, targetCard.nextSibling);
      } else {
        targetCard.parentNode.insertBefore(draggedCard, targetCard);
      }
      
      // Save new order
      saveInitiativeOrder();
      
      // Also reorder the table rows to match the new card order
      reorderTableToMatchCards();
    });
    
    // Reorder table initiative groups to match card order
    function reorderTableToMatchCards() {
      var cardsRoot = document.getElementById('initiative-cards-root');
      var tbody = document.querySelector('.pr-table tbody');
      if (!cardsRoot || !tbody) return;
      
      // Get the new order from the cards
      var cardNames = Array.from(cardsRoot.querySelectorAll('.initiative-card')).map(function(card) {
        return card.getAttribute('data-initiative-name');
      });
      
      // Find all initiative group headers in the table
      var initiativeGroups = {}; // name -> [header row, ...PR rows]
      var currentInit = null;
      var currentRows = [];
      
      Array.from(tbody.querySelectorAll('tr')).forEach(function(row) {
        if (row.classList.contains('initiative-group-header')) {
          // Save previous group
          if (currentInit) {
            initiativeGroups[currentInit] = currentRows;
          }
          // Start new group
          currentInit = row.getAttribute('data-initiative');
          currentRows = [row];
        } else if (currentInit) {
          currentRows.push(row);
        }
      });
      // Save last group
      if (currentInit) {
        initiativeGroups[currentInit] = currentRows;
      }
      
      // Collect all rows in the new order into a fragment
      var fragment = document.createDocumentFragment();
      cardNames.forEach(function(name) {
        if (initiativeGroups[name]) {
          initiativeGroups[name].forEach(function(row) {
            fragment.appendChild(row);
          });
        }
      });
      // Add any remaining groups not in cards (like "No initiative")
      Object.keys(initiativeGroups).forEach(function(name) {
        if (cardNames.indexOf(name) === -1) {
          initiativeGroups[name].forEach(function(row) {
            fragment.appendChild(row);
          });
        }
      });
      
      // Replace tbody contents with the reordered rows
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      tbody.appendChild(fragment);
    }

    // Initiative picker dropdown handlers (delegated to body for dynamic content)
    document.body.addEventListener('click', function(e) {
      // Toggle init-picker dropdown
      var pickerBtn = e.target.closest('.init-picker__btn');
      if (pickerBtn) {
        e.stopPropagation();
        var picker = pickerBtn.closest('.init-picker');
        // Close all other init-pickers
        document.querySelectorAll('.init-picker.open').forEach(function(p) {
          if (p !== picker) p.classList.remove('open');
        });
        picker.classList.toggle('open');
        return;
      }
      
      // Handle init-picker item click
      var pickerItem = e.target.closest('.init-picker__item');
      if (pickerItem) {
        e.stopPropagation();
        var picker = pickerItem.closest('.init-picker');
        var initName = pickerItem.getAttribute('data-init-name');
        var repo = picker.getAttribute('data-repo');
        var branch = picker.getAttribute('data-branch');
        
        if (!initName || !repo || !branch) {
          picker.classList.remove('open');
          return;
        }
        
        // Build checkout command that goes to the initiative folder and checks out the branch
        var repoShort = repo.split('/').pop() || repo;
        var checkoutCmd = 'cd ~/Projects/' + initName + '/' + repoShort + ' && git fetch origin ' + branch + ' && git checkout ' + branch;
        
        // Copy to clipboard
        copyToClipboard(checkoutCmd, 'Checkout command copied for ' + initName + '!');
        
        // Close dropdown
        picker.classList.remove('open');
        return;
      }
      
      // Close all init-pickers when clicking outside
      if (!e.target.closest('.init-picker')) {
        document.querySelectorAll('.init-picker.open').forEach(function(p) {
          p.classList.remove('open');
        });
      }
    });

    refreshBtn.addEventListener('click', function() {
      load();
      loadEvents();
    });

    var newFoodProjectBtn = document.getElementById('new-food-project');
    if (newFoodProjectBtn) {
      newFoodProjectBtn.addEventListener('click', async function() {
        newFoodProjectBtn.disabled = true;
        newFoodProjectBtn.textContent = 'Starting...';
        
        var placeholderName = null;
        var pollInterval = null;
        
        try {
          // Start the async creation - returns immediately with name
          var createRes = await fetch('/api/create-food-project', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }
          });
          var createData = await createRes.json();
          
          if (!createRes.ok || !createData.name) {
            throw new Error(createData.error || 'Could not start creation');
          }
          
          placeholderName = createData.name;
          
          // Immediately add placeholder card with the name
          addPlaceholderInitiativeCard(placeholderName);
          newFoodProjectBtn.textContent = 'Generating icon...';
          
          // Poll for status updates
          async function pollStatus() {
            try {
              var statusRes = await fetch('/api/creation-status/' + encodeURIComponent(placeholderName));
              if (!statusRes.ok) {
                return; // Job not found, keep polling
              }
              var status = await statusRes.json();
              
              // Update button text with current step
              newFoodProjectBtn.textContent = status.step || 'Working...';
              
              // Update placeholder with progress
              var placeholder = document.getElementById('creating-initiative-' + placeholderName);
              if (placeholder) {
                var progressEl = placeholder.querySelector('.initiative-icon-placeholder');
                if (progressEl && status.progress) {
                  progressEl.textContent = status.progress + '%';
                }
                // If we have an image, show it
                if (status.image) {
                  updatePlaceholderWithIcon(placeholderName, status.image);
                }
              }
              
              // Check if complete or failed
              if (status.status === 'complete') {
                clearInterval(pollInterval);
                pollInterval = null;
                
                window.__lastCreatedInitiativeName = placeholderName;
                window.__lastCreatedInitiativeTime = Date.now();
                setTimeout(function() {
                  window.__lastCreatedInitiativeName = null;
                  window.__lastCreatedInitiativeTime = null;
                }, 15000);
                
                removePlaceholderCard(placeholderName);
                await load(placeholderName);
                loadEvents();
                showToast('Created ' + placeholderName + '!');
                
                newFoodProjectBtn.disabled = false;
                newFoodProjectBtn.textContent = 'New food project';
              } else if (status.status === 'failed') {
                clearInterval(pollInterval);
                pollInterval = null;
                
                removePlaceholderCard(placeholderName);
                alert('Creation failed: ' + (status.error || 'Unknown error'));
                
                newFoodProjectBtn.disabled = false;
                newFoodProjectBtn.textContent = 'New food project';
              }
            } catch (pollErr) {
              console.error('Poll error:', pollErr);
            }
          }
          
          // Start polling every 500ms for real-time updates
          pollInterval = setInterval(pollStatus, 500);
          pollStatus(); // Run immediately
          
        } catch(err) {
          if (pollInterval) clearInterval(pollInterval);
          if (placeholderName) removePlaceholderCard(placeholderName);
          alert('Failed to create project: ' + (err && err.message ? err.message : 'network error'));
          newFoodProjectBtn.disabled = false;
          newFoodProjectBtn.textContent = 'New food project';
        }
      });
    }

    var fixAllBtn = document.getElementById('fix-all-issues');
    if (fixAllBtn) {
      fixAllBtn.addEventListener('click', function() {
        fixAllBtn.disabled = true;
        fixAllBtn.textContent = 'Scanning...';
        fetch('/api/fix-all-issues', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
          .then(function(r) {
            var ct = (r.headers.get('content-type') || '').toLowerCase();
            if (!ct.includes('application/json')) {
              return r.text().then(function() {
                return { ok: false, data: { error: 'Server returned a non-JSON response.' } };
              });
            }
            return r.json().then(function(data) { return { ok: r.ok, data: data }; });
          })
          .then(function(result) {
            if (result.ok && result.data) {
              var msg = result.data.message || 'Done';
              var spawnedCount = (result.data.spawned || []).length;
              var conflictsCount = (result.data.conflicts || []).length;
              if (spawnedCount === 0 && conflictsCount === 0) {
                showToast('All PRs are clean!');
              } else {
                showToast(msg);
                // If there are conflicts, show alert with details
                if (conflictsCount > 0) {
                  var conflictPRs = result.data.conflicts.map(function(c) {
                    return c.repo + ' #' + c.number;
                  }).join('\n');
                  alert('PRs with conflicts (need manual resolution):\n\n' + conflictPRs);
                }
              }
            } else {
              alert(result.data && result.data.error ? result.data.error : 'Failed to fix issues');
            }
          })
          .catch(function(err) {
            alert('Failed: ' + (err && err.message ? err.message : 'network error'));
          })
          .finally(function() {
            fixAllBtn.disabled = false;
            fixAllBtn.textContent = 'Fix All Issues';
          });
      });
    }

    document.body.addEventListener('click', function(e) {
      // Handle sprite animation replay buttons
      var replayBtn = e.target && e.target.closest ? e.target.closest('.sprite-replay-btn') : null;
      if (replayBtn) {
        var targetId = replayBtn.getAttribute('data-target');
        var animClass = replayBtn.getAttribute('data-class');
        var targetEl = document.getElementById(targetId);
        if (targetEl && animClass) {
          targetEl.classList.remove(animClass);
          void targetEl.offsetWidth; // Force reflow
          targetEl.classList.add(animClass);
        }
        return;
      }

      // Handle initiative chat button - opens chat modal for initiative
      var initChatBtn = e.target && e.target.closest ? e.target.closest('[data-init-chat]') : null;
      if (initChatBtn) {
        e.preventDefault();
        e.stopPropagation();
        var chatInitName = initChatBtn.getAttribute('data-init-chat') || '';
        if (chatInitName) openChatModal(chatInitName, null, null);
        return;
      }

      // Handle initiative terminal button - opens cmd modal for non-PR tasks
      var initTermBtn = e.target && e.target.closest ? e.target.closest('.initiative-icon-terminal') : null;
      if (initTermBtn) {
        e.preventDefault();
        e.stopPropagation();
        var initName = initTermBtn.getAttribute('data-init-cmd') || '';
        var initPath = initTermBtn.getAttribute('data-init-path') || '';
        if (initName) openInitiativeCmdModal(initName, initPath);
        return;
      }

      // Handle order-up prep work button - creates prep work for order-up app
      var orderupPrepBtn = e.target && e.target.closest ? e.target.closest('.initiative-orderup-prep') : null;
      if (orderupPrepBtn) {
        e.preventDefault();
        e.stopPropagation();
        var prepInitiative = orderupPrepBtn.getAttribute('data-orderup-prep') || '';
        if (prepInitiative) openInitiativeCmdModal('order-up', '/Users/brandonevery/Projects/order-up');
        return;
      }

      // Handle prep work agent banner click - copy status update command
      var prepBanner = e.target && e.target.closest ? e.target.closest('.prep-work-task-row .agent-banner') : null;
      if (prepBanner) {
        var taskRow = prepBanner.closest('.prep-work-task-row');
        if (taskRow) {
          e.preventDefault();
          e.stopPropagation();
          var taskId = taskRow.getAttribute('data-task-id');
          var task = taskId ? initiativeTasks[taskId] : null;
          if (task) {
            var cmd = (task.command || 'Complete the task') + '\n\n';
            cmd += '**IMPORTANT**: Report your status to Order Up dashboard so the user can track progress.\n\n';
            cmd += 'On Start (run immediately):\n';
            cmd += '```bash\n';
            cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + task.id + '","status":"running"}\'\n';
            cmd += '```\n\n';
            cmd += 'On Complete (run after finishing):\n';
            cmd += '```bash\n';
            cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + task.id + '","status":"complete","summary":"Done"}\'\n';
            cmd += '```\n\n';
            cmd += 'On Failure (if you cannot complete):\n';
            cmd += '```bash\n';
            cmd += 'curl -X POST http://localhost:3333/api/initiative-task -H "Content-Type: application/json" -d \'{"id":"' + task.id + '","status":"failed","error":"Brief description"}\'\n';
            cmd += '```\n';
            
            dispatchAgent(task.path, cmd, { taskId: task.id, toastMessage: 'Task command sent!' });
          }
        }
        return;
      }

      // Handle prep work clear button
      var clearTaskBtn = e.target && e.target.closest ? e.target.closest('.prep-work-clear-btn') : null;
      if (clearTaskBtn) {
        e.preventDefault();
        e.stopPropagation();
        var taskId = clearTaskBtn.getAttribute('data-clear-task');
        if (taskId) {
          delete initiativeTasks[taskId];
          fetch('/api/initiative-task/' + encodeURIComponent(taskId), { method: 'DELETE' }).catch(function() {});
          renderPrepWorkTable();
        }
        return;
      }

      // Handle initiative icon edit button
      var editBtn = e.target && e.target.closest ? e.target.closest('.initiative-icon-edit') : null;
      if (editBtn) {
        e.preventDefault();
        e.stopPropagation();
        var initName = editBtn.getAttribute('data-edit-initiative');
        if (!initName) return;
        var initiativeCard = editBtn.closest('.initiative-card');
        if (!initiativeCard) return;
        if (!confirm('Regenerate icon for "' + initName + '"?')) return;
        
        editBtn.disabled = true;
        initiativeCard.style.pointerEvents = 'none';
        initiativeCard.setAttribute('aria-busy', 'true');
        var iconEl = initiativeCard.querySelector('.initiative-icon');
        if (iconEl) iconEl.style.opacity = '0.4';
        
        fetch('/api/regenerate-initiative-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: initName })
        })
          .then(function(r) {
            var ct = (r.headers.get('content-type') || '').toLowerCase();
            if (!ct.includes('application/json')) {
              return r.text().then(function() {
                return { ok: false, data: { error: 'Server returned a non-JSON response.' } };
              });
            }
            return r.json().then(function(data) { return { ok: r.ok, data: data }; });
          })
          .then(function(result) {
            if (result.ok && result.data && result.data.image) {
              if (iconEl) iconEl.src = result.data.image + '?_t=' + Date.now();
              showToast('Icon regenerated!');
            } else {
              alert(result.data && result.data.error ? result.data.error : 'Could not regenerate icon');
            }
          })
          .catch(function(err) {
            alert('Failed: ' + (err && err.message ? err.message : 'network error'));
          })
          .finally(function() {
            editBtn.disabled = false;
            initiativeCard.style.pointerEvents = '';
            initiativeCard.removeAttribute('aria-busy');
            if (iconEl) iconEl.style.opacity = '';
          });
        return;
      }

      // Handle branch name copy
      var branchEl = e.target && e.target.closest ? e.target.closest('.branch-name') : null;
      if (branchEl) {
        var branch = branchEl.getAttribute('data-branch');
        if (branch) {
          e.preventDefault();
          e.stopPropagation();
          copyToClipboard(branch, 'Branch copied!');
        }
        return;
      }

      var initiativeCard = e.target && e.target.closest ? e.target.closest('a.initiative-card') : null;
      if (initiativeCard) {
        var initName = initiativeCard.getAttribute('data-initiative-name');
        if (initName) {
          e.preventDefault();
          e.stopPropagation();
          // Triple-click detection: regenerate image (legacy - edit button is preferred)
          if (e.detail === 3) {
            if (!confirm('Regenerate image for "' + initName + '"?')) return;
            initiativeCard.style.pointerEvents = 'none';
            initiativeCard.setAttribute('aria-busy', 'true');
            var iconEl = initiativeCard.querySelector('.initiative-icon');
            if (iconEl) iconEl.style.opacity = '0.4';
            fetch('/api/regenerate-initiative-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: initName })
            })
              .then(function(r) {
                var ct = (r.headers.get('content-type') || '').toLowerCase();
                if (!ct.includes('application/json')) {
                  return r.text().then(function() {
                    return { ok: false, data: { error: 'Server returned a non-JSON response.' } };
                  });
                }
                return r.json().then(function(data) { return { ok: r.ok, data: data }; });
              })
              .then(function(result) {
                initiativeCard.style.pointerEvents = '';
                initiativeCard.removeAttribute('aria-busy');
                if (iconEl) iconEl.style.opacity = '';
                if (result.ok && result.data && result.data.image) {
                  // Update the image with cache-busting
                  if (iconEl) iconEl.src = result.data.image + '?_t=' + Date.now();
                  showToast('Image regenerated!');
                } else {
                  alert(result.data && result.data.error ? result.data.error : 'Could not regenerate image');
                }
              })
              .catch(function(err) {
                initiativeCard.style.pointerEvents = '';
                initiativeCard.removeAttribute('aria-busy');
                if (iconEl) iconEl.style.opacity = '';
                alert('Failed: ' + (err && err.message ? err.message : 'network error'));
              });
            return;
          }
          // Single click: open initiative folder
          initiativeCard.style.pointerEvents = 'none';
          initiativeCard.setAttribute('aria-busy', 'true');
          fetch('/api/ensure-initiative-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: initName })
          })
            .then(function(r) {
              var ct = (r.headers.get('content-type') || '').toLowerCase();
              if (!ct.includes('application/json')) {
                return r.text().then(function() {
                  return { ok: false, data: { error: 'Server returned a non-JSON response. Restart the dashboard server (npm start in app/).' } };
                });
              }
              return r.json().then(function(data) { return { ok: r.ok, data: data }; });
            })
            .then(function(result) {
              if (result.ok && result.data && result.data.path) {
                var ensureHref = toolLink(result.data.path);
                if (ensureHref) window.location.href = ensureHref;
              } else {
                initiativeCard.style.pointerEvents = '';
                initiativeCard.removeAttribute('aria-busy');
                alert(result.data && result.data.error ? result.data.error : 'Could not open initiative folder');
              }
            })
            .catch(function(err) {
              initiativeCard.style.pointerEvents = '';
              initiativeCard.removeAttribute('aria-busy');
              alert('Failed: ' + (err && err.message ? err.message : 'network error'));
            });
          return;
        }
      }
      var mergeBtn = e.target && e.target.closest ? e.target.closest('button.row-merge-btn') : null;
      if (mergeBtn && !mergeBtn.disabled) {
        var row = mergeBtn.closest('tr[data-repo][data-number]');
        if (!row) return;
        var repo = row.getAttribute('data-repo');
        var num = row.getAttribute('data-number');
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        mergeBtn.disabled = true;
        mergeBtn.textContent = '…';
        fetch('/api/merge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo: repo, number: parseInt(num, 10) })
        })
          .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
          .then(function(result) {
            if (result.ok && result.data.merged) {
              load();
              loadEvents();
            } else {
              mergeBtn.disabled = false;
              mergeBtn.textContent = 'Merge';
              alert(result.data && result.data.error ? result.data.error : 'Merge failed');
            }
          })
          .catch(function(err) {
            mergeBtn.disabled = false;
            mergeBtn.textContent = 'Merge';
            alert('Merge failed: ' + (err && err.message ? err.message : 'network error'));
          });
        return;
      }
      // FINISH HIM button handler - copies command with all issues
      var finishBtn = e.target && e.target.closest ? e.target.closest('button.finish-him-btn') : null;
      if (finishBtn && !finishBtn.disabled) {
        var row = finishBtn.closest('tr[data-repo][data-number]');
        if (!row) return;
        var repo = row.getAttribute('data-repo');
        var num = row.getAttribute('data-number');
        var path = row.getAttribute('data-path') || '';
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        
        // Get issue context from button data attributes
        var failingChecks = (finishBtn.getAttribute('data-failing-checks') || '').split(',').filter(Boolean);
        var unresolvedCount = parseInt(finishBtn.getAttribute('data-unresolved') || '0', 10);
        var hasConflictsFlag = finishBtn.getAttribute('data-has-conflicts') === '1';
        
        // Create pending job for agent tracking
        createPendingJob(repo, parseInt(num, 10), 'all');
        
        // Show loading state
        finishBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        finishBtn.disabled = true;
        
        // Fetch all details in parallel
        var checksPromise = failingChecks.length > 0 
          ? fetch('/api/check-failures?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
              .then(function(r) { return r.json(); })
              .catch(function() { return { failures: [] }; })
          : Promise.resolve({ failures: [] });
        
        var commentsPromise = unresolvedCount > 0
          ? fetch('/api/pr-comments?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
              .then(function(r) { return r.json(); })
              .catch(function() { return { comments: [] }; })
          : Promise.resolve({ comments: [] });
        
        Promise.all([checksPromise, commentsPromise]).then(function(results) {
          var checksData = results[0];
          var commentsData = results[1];
          var failures = checksData.failures || [];
          var comments = commentsData.comments || [];
          
          // Build comprehensive command with all details
          var link = prLink(repo, num);
          var issues = [];
          if (failingChecks.length > 0) {
            issues.push('failing checks: ' + failingChecks.join(', '));
          }
          if (unresolvedCount > 0) {
            issues.push(unresolvedCount + ' unresolved comment' + (unresolvedCount > 1 ? 's' : ''));
          }
          if (hasConflictsFlag) {
            issues.push('merge conflicts');
          }
          var issuesSummary = issues.length > 0 ? ' (' + issues.join('; ') + ')' : '';
          var cmd = 'Fix all issues on PR #' + num + issuesSummary + ': ' + link;
          
          // Add check failures with details
          if (failures.length > 0) {
            cmd += '\n\n## Failing Checks\n';
            cmd += 'Use /handle-pr-checks to fix these:\n';
            for (var i = 0; i < failures.length; i++) {
              var f = failures[i];
              cmd += '\n### ' + f.name + ' (' + f.conclusion + ')';
              if (f.errors && f.errors.length > 0) {
                cmd += '\nErrors:';
                for (var j = 0; j < f.errors.length; j++) {
                  cmd += '\n- ' + f.errors[j];
                }
              } else if (f.annotations && f.annotations.length > 0) {
                cmd += '\nErrors:';
                for (var j = 0; j < f.annotations.length; j++) {
                  var ann = f.annotations[j];
                  cmd += '\n- ' + ann.path + (ann.line ? ':' + ann.line : '') + ': ' + ann.message;
                }
              }
            }
          } else if (failingChecks.length > 0) {
            cmd += '\n\nUse /handle-pr-checks to fix the failing ' + failingChecks.join(', ') + ' check' + (failingChecks.length > 1 ? 's' : '') + '.';
          }
          
          // Add unresolved comments with details
          if (comments.length > 0) {
            cmd += '\n\n## Unresolved Comments\n';
            cmd += 'Use /handle-pr-comments to address these:\n';
            for (var i = 0; i < comments.length; i++) {
              var c = comments[i];
              cmd += '\n### ' + (i + 1) + '. ' + (c.path ? c.path + (c.line ? ':' + c.line : '') : 'General') + ' - @' + c.author;
              cmd += '\n' + (c.body || '').split('\n').slice(0, 10).join('\n');
              if ((c.body || '').split('\n').length > 10) {
                cmd += '\n... (truncated)';
              }
            }
          } else if (unresolvedCount > 0) {
            cmd += '\n\nUse /handle-pr-comments to address the ' + unresolvedCount + ' unresolved comment' + (unresolvedCount > 1 ? 's' : '') + '.';
          }
          
          if (hasConflictsFlag) {
            cmd += '\n\n## Merge Conflicts\n';
            cmd += 'This branch has conflicts with main that must be resolved.\n\n';
            cmd += '### Steps to resolve:\n';
            cmd += '1. Fetch latest and start rebase:\n';
            cmd += '```bash\n';
            cmd += 'git fetch origin && git rebase origin/main\n';
            cmd += '```\n\n';
            cmd += '2. For each conflicted file:\n';
            cmd += '   - Look for conflict markers: `<<<<<<<`, `=======`, `>>>>>>>`\n';
            cmd += '   - **IMPORTANT**: Keep BOTH the existing logic AND the new changes where applicable\n';
            cmd += '   - Don\'t just pick one side - merge the intent of both changes\n';
            cmd += '   - Remove all conflict markers when done\n\n';
            cmd += '3. After resolving each file: `git add <file> && git rebase --continue`\n\n';
            cmd += '4. When all conflicts resolved, force push (required after rebase):\n';
            cmd += '```bash\n';
            cmd += 'git push --force-with-lease\n';
            cmd += '```\n\n';
            cmd += '**TIP**: If you make a mistake, `git rebase --abort` will start over.';
          }
          
          // Dispatch and show feedback
          incrementStat('bugs');
          dispatchAgent(path, cmd, { repo: repo, number: parseInt(num, 10), type: 'all', toastMessage: 'All issues command sent!' });
          finishBtn.innerHTML = '<i data-lucide="check"></i>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          finishBtn.disabled = false;
          setTimeout(function() {
            finishBtn.innerHTML = '<i data-lucide="bug"></i>';
            if (typeof lucide !== 'undefined') lucide.createIcons();
          }, 1500);
        });
        return;
      }
      // REVIEW NOW button handler - copies review request message
      var reviewBtn = e.target && e.target.closest ? e.target.closest('button.review-now-btn') : null;
      if (reviewBtn) {
        var prTitle = reviewBtn.getAttribute('data-title') || '';
        var repo = reviewBtn.getAttribute('data-repo') || '';
        var num = reviewBtn.getAttribute('data-number') || '';
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        
        var link = prLink(repo, num);
        var repoShort = repo.split('/').pop() || repo;
        
        // Decode any URL-encoded characters in the title
        var decodedTitle = prTitle;
        try { decodedTitle = decodeURIComponent(prTitle.replace(/\+/g, ' ')); } catch(e) {}
        
        // Build review request message - single line
        var msg = 'PR Ready for Review: ' + decodedTitle + ' ' + link;
        
        incrementStat('reviews');
        copyCommand(msg, 'Review request copied!');
        reviewBtn.innerHTML = '<i data-lucide="check"></i>';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        setTimeout(function() {
          reviewBtn.innerHTML = '<i data-lucide="chef-hat"></i>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }, 1500);
        return;
      }
      // MERGE button handler - merges the PR
      var mergeBtn = e.target && e.target.closest ? e.target.closest('button.merge-btn') : null;
      if (mergeBtn) {
        var repo = mergeBtn.getAttribute('data-repo') || '';
        var num = mergeBtn.getAttribute('data-number') || '';
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        
        // Find the initiative name from the closest initiative group header
        var mergeRow = mergeBtn.closest('tr[data-repo]');
        var initiativeName = '';
        if (mergeRow) {
          var prev = mergeRow.previousElementSibling;
          while (prev) {
            if (prev.classList && prev.classList.contains('initiative-group-header')) {
              initiativeName = prev.getAttribute('data-initiative') || '';
              break;
            }
            prev = prev.previousElementSibling;
          }
        }
        
        mergeBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        mergeBtn.disabled = true;
        
        // Call merge API with initiative name
        fetch('/api/merge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo: repo, number: parseInt(num, 10), initiative: initiativeName })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.merged) {
            incrementStat('served');
            mergeBtn.innerHTML = '<i data-lucide="check"></i>';
            mergeBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            showToast('PR #' + num + ' merged! ORDER UP!');
            
            var row = mergeBtn.closest('tr');
            if (!row) return;
            
            // Check if this was the last PR in the initiative
            if (data.initiativeRemoved && data.removedInitiative) {
              // Collect all rows for this initiative (header + PR rows)
              var initRows = [];
              var headerRow = null;
              var prev = row.previousElementSibling;
              while (prev) {
                if (prev.classList && prev.classList.contains('initiative-group-header')) {
                  headerRow = prev;
                  break;
                }
                prev = prev.previousElementSibling;
              }
              if (headerRow) {
                initRows.push(headerRow);
                var next = headerRow.nextElementSibling;
                while (next && !next.classList.contains('initiative-group-header')) {
                  initRows.push(next);
                  next = next.nextElementSibling;
                }
              }
              
              // Flash the row green first
              row.style.transition = 'background-color 0.3s';
              row.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
              
              // Show ORDER UP! overlay
              setTimeout(function() {
                var overlay = document.createElement('div');
                overlay.className = 'order-up-overlay';
                overlay.innerHTML = '<div class="order-up-text">ORDER UP!</div>';
                document.body.appendChild(overlay);
                setTimeout(function() { overlay.remove(); }, 2600);
                
                // Animate all initiative rows away
                for (var i = 0; i < initRows.length; i++) {
                  initRows[i].classList.add('initiative-removing');
                }
                
                // Remove rows and initiative card after animation
                setTimeout(function() {
                  for (var i = 0; i < initRows.length; i++) {
                    if (initRows[i].parentNode) initRows[i].parentNode.removeChild(initRows[i]);
                  }
                  // Remove initiative card from the top bar
                  var card = document.querySelector('.initiative-card[data-initiative-name="' + data.removedInitiative + '"]');
                  if (card) {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.5)';
                    setTimeout(function() { if (card.parentNode) card.parentNode.removeChild(card); }, 350);
                  }
                }, 900);
              }, 800);
              
            } else {
              // Just remove the single PR row with animation
              row.style.transition = 'background-color 0.3s';
              row.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
              setTimeout(function() {
                row.classList.add('pr-row-merging');
                setTimeout(function() {
                  if (row.parentNode) row.parentNode.removeChild(row);
                }, 650);
              }, 600);
            }
          } else {
            mergeBtn.innerHTML = '<i data-lucide="x"></i>';
            mergeBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            showToast('Merge failed: ' + (data.error || 'Unknown error'));
            setTimeout(function() {
              mergeBtn.innerHTML = '<i data-lucide="utensils"></i>';
              mergeBtn.style.background = '';
              mergeBtn.disabled = false;
              if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 2000);
          }
        })
        .catch(function(err) {
          mergeBtn.innerHTML = '<i data-lucide="x"></i>';
          mergeBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          showToast('Merge error: ' + (err.message || 'Network error'));
          setTimeout(function() {
            mergeBtn.innerHTML = '<i data-lucide="utensils"></i>';
            mergeBtn.style.background = '';
            mergeBtn.disabled = false;
            if (typeof lucide !== 'undefined') lucide.createIcons();
          }, 2000);
        });
        return;
      }
      // Group Back Burner button handler - toggles all PRs in an initiative
      var bbGroupBtn = e.target && e.target.closest ? e.target.closest('button.back-burner-group-btn') : null;
      if (bbGroupBtn) {
        e.preventDefault();
        e.stopPropagation();
        var prList = (bbGroupBtn.getAttribute('data-bb-prs') || '').split(',').filter(Boolean);
        if (prList.length === 0) return;
        // Determine direction: if any are NOT back-burnered, move all to back burner
        var moveToBB = prList.some(function(key) {
          var parts = key.split('#');
          return !isBackBurner(parts[0], parseInt(parts[1], 10));
        });
        bbGroupBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        // Toggle all PRs
        var promises = [];
        for (var i = 0; i < prList.length; i++) {
          var parts = prList[i].split('#');
          var repo = parts[0], num = parseInt(parts[1], 10);
          var currentlyBB = isBackBurner(repo, num);
          if (moveToBB !== currentlyBB) {
            toggleBackBurner(repo, num);
            promises.push(
              fetch('/api/toggle-draft', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ repo: repo, number: num, makeDraft: moveToBB })
              }).then(function(r) { return r.json(); }).catch(function() { return {}; })
            );
          }
        }
        Promise.all(promises).then(function() {
          bbGroupBtn.innerHTML = '<i data-lucide="flame"></i>';
          bbGroupBtn.classList.toggle('active', moveToBB);
          bbGroupBtn.title = moveToBB ? 'Move back to active' : 'Move to back burner';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          // Reload to re-sort into correct sections
          load();
        });
        return;
      }
      // Back Burner button handler - toggle back burner state and convert to/from draft
      var backBurnerBtn = e.target && e.target.closest ? e.target.closest('button.back-burner-btn') : null;
      if (backBurnerBtn) {
        var repo = backBurnerBtn.getAttribute('data-repo');
        var num = backBurnerBtn.getAttribute('data-number');
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        
        var wasOnBackBurner = isBackBurner(repo, parseInt(num, 10));
        var willBeOnBackBurner = !wasOnBackBurner;
        
        // Update UI immediately
        toggleBackBurner(repo, parseInt(num, 10));
        var row = backBurnerBtn.closest('tr');
        if (row) {
          row.classList.toggle('back-burnered', willBeOnBackBurner);
          backBurnerBtn.classList.toggle('active', willBeOnBackBurner);
          backBurnerBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          backBurnerBtn.title = willBeOnBackBurner ? 'Move back to active' : 'Move to back burner';
          
          // Update initiative group header if all PRs are now back-burnered
          updateInitiativeHeaderState(row);
        }
        
        function updateInitiativeHeaderState(prRow) {
          var initiative = null;
          var prevRow = prRow.previousElementSibling;
          while (prevRow) {
            if (prevRow.classList.contains('initiative-group-header')) {
              initiative = prevRow.getAttribute('data-initiative');
              break;
            }
            prevRow = prevRow.previousElementSibling;
          }
          if (!initiative) return;
          
          // Find all PR rows for this initiative
          var allPrRows = document.querySelectorAll('tr[data-repo][data-number]');
          var initiativePrs = [];
          var inGroup = false;
          var headerRow = null;
          
          var allRows = document.querySelectorAll('tbody tr');
          for (var i = 0; i < allRows.length; i++) {
            var r = allRows[i];
            if (r.classList.contains('initiative-group-header')) {
              if (r.getAttribute('data-initiative') === initiative) {
                inGroup = true;
                headerRow = r;
              } else if (inGroup) {
                break;
              }
            } else if (inGroup && r.getAttribute('data-repo')) {
              initiativePrs.push(r);
            }
          }
          
          if (headerRow && initiativePrs.length > 0) {
            var allBackBurnered = initiativePrs.every(function(r) {
              return r.classList.contains('back-burnered');
            });
            headerRow.classList.toggle('back-burnered-group', allBackBurnered);
          }
        }
        
        // Convert PR to/from draft on GitHub
        fetch('/api/toggle-draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo: repo, number: parseInt(num, 10), makeDraft: willBeOnBackBurner })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          backBurnerBtn.innerHTML = '<i data-lucide="flame"></i>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          if (!data.success) {
            // Revert on failure
            toggleBackBurner(repo, parseInt(num, 10));
            if (row) row.classList.toggle('back-burnered', wasOnBackBurner);
            backBurnerBtn.classList.toggle('active', wasOnBackBurner);
            updateInitiativeHeaderState(row);
          }
        })
        .catch(function() {
          // Revert on error
          backBurnerBtn.innerHTML = '<i data-lucide="flame"></i>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
          toggleBackBurner(repo, parseInt(num, 10));
          if (row) row.classList.toggle('back-burnered', wasOnBackBurner);
          backBurnerBtn.classList.toggle('active', wasOnBackBurner);
          updateInitiativeHeaderState(row);
        });
        return;
      }
      // Fork button handler - open folder in Fork app
      var forkBtn = e.target && e.target.closest ? e.target.closest('button.fork-btn') : null;
      if (forkBtn) {
        var path = forkBtn.getAttribute('data-path');
        if (!path) return;
        e.preventDefault();
        e.stopPropagation();
        fetch('/api/open-fork', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: path })
        });
        return;
      }
      var refreshBtn = e.target && e.target.closest ? e.target.closest('button.row-refresh') : null;
      if (refreshBtn) {
        var row = refreshBtn.closest('tr[data-repo][data-number]');
        if (!row) return;
        var repo = row.getAttribute('data-repo');
        var num = row.getAttribute('data-number');
        if (!repo || !num) return;
        e.preventDefault();
        e.stopPropagation();
        
        // Add loading overlay
        row.style.position = 'relative';
        var loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'row-loading-overlay';
        row.appendChild(loadingOverlay);
        
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        fetch('/api/pr?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.pr) {
              row.innerHTML = buildPrRowCells(data.pr);
              if (typeof lucide !== 'undefined') lucide.createIcons();
              if (hasConflicts(data.pr)) {
                row.setAttribute('data-has-conflicts', 'true');
              } else {
                row.removeAttribute('data-has-conflicts');
              }
            }
          })
          .catch(function() {
            // Remove overlay on error
            if (loadingOverlay.parentNode) loadingOverlay.parentNode.removeChild(loadingOverlay);
          })
          .finally(function() {
            // Overlay is removed when row.innerHTML is replaced, no cleanup needed on success
          });
        return;
      }
      var a = e.target && e.target.closest ? e.target.closest('a.fix-check') : null;
      if (a) {
        var path = a.getAttribute('data-path');
        var repo = a.getAttribute('data-repo');
        var num = a.getAttribute('data-number');
        var check = a.getAttribute('data-check');
        if (repo && num) {
          e.preventDefault();
          
          // Create pending job for agent tracking
          createPendingJob(repo, parseInt(num, 10), 'checks');
          
          // Fetch actual failure details and include in clipboard
          fetch('/api/check-failures?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num) + (check ? '&check=' + encodeURIComponent(check) : ''))
            .then(function(r) { return r.json(); })
            .then(function(data) {
              var failures = data.failures || [];
              var failureText = '';
              if (failures.length > 0) {
                failureText = '\n\nFailing checks:\n';
                for (var i = 0; i < failures.length; i++) {
                  var f = failures[i];
                  failureText += '\n' + (i + 1) + '. ' + f.name + ' (' + f.conclusion + ')';
                  // Show parsed error messages from logs first
                  if (f.errors && f.errors.length > 0) {
                    failureText += '\n   Errors from logs:';
                    for (var j = 0; j < f.errors.length; j++) {
                      failureText += '\n   - ' + f.errors[j];
                    }
                  }
                  // Fall back to annotations if no log errors found
                  else if (f.annotations && f.annotations.length > 0) {
                    failureText += '\n   Errors:';
                    for (var j = 0; j < f.annotations.length; j++) {
                      var ann = f.annotations[j];
                      failureText += '\n   - ' + ann.path + (ann.line ? ':' + ann.line : '') + ': ' + ann.message;
                    }
                  }
                  else if (f.summary) {
                    failureText += '\n   Summary: ' + f.summary.split('\n')[0];
                  }
                }
              }
              var cmd = buildCopyText(repo, num, 'checks', { check: check }) + failureText;
              dispatchAgent(path, cmd, { repo: repo, number: parseInt(num, 10), type: 'checks', toastMessage: 'Checks command sent!' });
            })
            .catch(function() {
              var cmd = buildCopyText(repo, num, 'checks', { check: check });
              dispatchAgent(path, cmd, { repo: repo, number: parseInt(num, 10), type: 'checks', toastMessage: 'Checks command sent!' });
            });
        }
        return;
      }
      var commentsLink = e.target && e.target.closest ? e.target.closest('a.comments-link') : null;
      if (commentsLink) {
        var row = commentsLink.closest('tr[data-repo][data-number]');
        if (row) {
          var repo = row.getAttribute('data-repo');
          var num = row.getAttribute('data-number');
          var path = row.getAttribute('data-path') || '';
          var unresolved = parseInt(commentsLink.getAttribute('data-unresolved') || '0', 10);
          e.preventDefault();
          e.stopPropagation();
          
          // Create pending job for agent tracking
          createPendingJob(repo, parseInt(num, 10), 'comments');
          incrementStat('comments');
          
          // Fetch actual comments and include in clipboard
          fetch('/api/pr-comments?repo=' + encodeURIComponent(repo) + '&number=' + encodeURIComponent(num))
            .then(function(r) { return r.json(); })
            .then(function(data) {
              var comments = data.comments || [];
              var commentText = '';
              if (comments.length > 0) {
                commentText = '\n\nUnresolved comments:\n';
                for (var i = 0; i < comments.length; i++) {
                  var c = comments[i];
                  commentText += '\n' + (i + 1) + '. ' + (c.path ? c.path + (c.line ? ':' + c.line : '') + ' - ' : '') + '@' + c.author + ':\n   ' + (c.body || '').split('\n').join('\n   ') + '\n';
                }
              }
              var cmd = buildCopyText(repo, num, 'comments', { unresolved: unresolved }) + commentText;
              dispatchAgent(path, cmd, { repo: repo, number: parseInt(num, 10), type: 'comments', toastMessage: 'Comments command sent!' });
            })
            .catch(function() {
              var cmd = buildCopyText(repo, num, 'comments', { unresolved: unresolved });
              dispatchAgent(path, cmd, { repo: repo, number: parseInt(num, 10), type: 'comments', toastMessage: 'Comments command sent!' });
            });
        }
        return;
      }
      // Chat button handler - opens chat modal for this PR
      var chatBtnEl = e.target && e.target.closest ? e.target.closest('button.chat-btn') : null;
      if (chatBtnEl) {
        e.preventDefault();
        e.stopPropagation();
        var repo = chatBtnEl.getAttribute('data-repo') || '';
        var num = chatBtnEl.getAttribute('data-number') || '';
        var path = chatBtnEl.getAttribute('data-path') || '';
        var branch = chatBtnEl.getAttribute('data-branch') || '';
        openChatPanel({ repo: repo, number: num, path: path, branch: branch });
        return;
      }
      // Agent banner handler - opens chat modal focused on active session
      var agentBannerEl = e.target && e.target.closest ? e.target.closest('[data-agent-banner]') : null;
      if (agentBannerEl) {
        e.preventDefault();
        e.stopPropagation();
        var repo = agentBannerEl.getAttribute('data-repo') || '';
        var num = agentBannerEl.getAttribute('data-number') || '';
        var path = agentBannerEl.getAttribute('data-path') || '';
        // Find the active session for this PR
        var prContext = { repo: repo, number: num, path: path };
        var activeSid = findSessionForPr(prContext);
        var initName = lookupInitiativeForPr(prContext);
        openChatModal(initName, prContext, activeSid);
        return;
      }
      // Custom command button handler - opens modal
      var customCmdBtn = e.target && e.target.closest ? e.target.closest('button.custom-cmd-btn') : null;
      if (customCmdBtn) {
        e.preventDefault();
        e.stopPropagation();
        var repo = customCmdBtn.getAttribute('data-repo') || '';
        var num = customCmdBtn.getAttribute('data-number') || '';
        var path = customCmdBtn.getAttribute('data-path') || '';
        var branch = customCmdBtn.getAttribute('data-branch') || '';
        if (repo && num) openCustomCmdModal(repo, num, path, branch);
        return;
      }
      var resolveBtn = e.target && e.target.closest ? e.target.closest('button[data-resolve-conflicts]') : null;
      if (resolveBtn) {
        var path = resolveBtn.getAttribute('data-path') || '';
        var repo = resolveBtn.getAttribute('data-repo') || '';
        var num = resolveBtn.getAttribute('data-number') || '';
        var branch = resolveBtn.getAttribute('data-branch') || '';
        e.preventDefault();
        e.stopPropagation();
        
        // Create pending job for conflict resolution
        if (repo && num) {
          createPendingJob(repo, parseInt(num, 10), 'conflicts');
        }
        incrementStat('conflicts');
        
        dispatchAgent(path, buildRebaseCommand(repo, num, branch), { repo: repo, number: parseInt(num, 10), type: 'conflicts', toastMessage: 'Rebase command sent!' });
        return;
      }
    });

    const CHEF_TWEAK_STORAGE = 'pr-dashboard-chef-tweak';
    const CHEF_TWEAK_MODE_KEY = 'pr-dashboard-chef-tweak-mode';

    function chefTweakGetStored() {
      try {
        var raw = localStorage.getItem(CHEF_TWEAK_STORAGE);
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        return {};
      }
    }
    function chefTweakSaveStored(obj) {
      try {
        localStorage.setItem(CHEF_TWEAK_STORAGE, JSON.stringify(obj));
      } catch (e) {}
    }
    function chefTweakApplyToWrap(wrap, id, frames, data) {
      var d = data || {};
      var frameIndex = Math.max(0, Math.min(parseInt(d.frameIndex, 10) || 0, Math.max(0, frames - 1)));
      var fo = d.frameOffsets && d.frameOffsets[String(frameIndex)];
      var x = fo && fo.xOffset != null ? parseInt(fo.xOffset, 10) : parseInt(d.xOffset, 10);
      var y = fo && fo.yOffset != null ? parseInt(fo.yOffset, 10) : parseInt(d.yOffset, 10);
      if (isNaN(x)) x = 0;
      if (isNaN(y)) y = (id === 'flamethrower') ? -88 : -12;
      var defaultW = id === 'flamethrower' ? 127 : frames === 4 ? 50 : frames === 2 ? 100 : 67;
      var w = d.frameWidth != null && d.frameWidth !== '' ? parseInt(d.frameWidth, 10) : null;
      if (w == null || isNaN(w)) w = defaultW;
      wrap.style.setProperty('--frame-index', String(frameIndex));
      wrap.style.setProperty('--x-offset', x + 'px');
      wrap.style.setProperty('--y-offset', y + 'px');
      wrap.style.setProperty('--frame-width', w + 'px');
      for (var f = 0; f < frames; f++) {
        var pf = d.frameOffsets && d.frameOffsets[String(f)];
        var xf = pf && pf.xOffset != null ? parseInt(pf.xOffset, 10) : (d.xOffset != null ? parseInt(d.xOffset, 10) : 0);
        var yf = pf && pf.yOffset != null ? parseInt(pf.yOffset, 10) : (d.yOffset != null ? parseInt(d.yOffset, 10) : (id === 'flamethrower' ? -88 : -12));
        if (isNaN(xf)) xf = 0;
        if (isNaN(yf)) yf = (id === 'flamethrower') ? -88 : -12;
        wrap.style.setProperty('--x-' + f, xf + 'px');
        wrap.style.setProperty('--y-' + f, yf + 'px');
      }
      return { frameIndex: frameIndex, xOffset: x, yOffset: y, frameWidth: w };
    }
    function chefTweakInit() {
      var section = document.getElementById('chef-animations-section');
      var toggleBtn = document.getElementById('chef-tweak-toggle');
      if (!section) return;
      var stored = chefTweakGetStored();
      var walkDefaults = { '0': { xOffset: -27, yOffset: -12 }, '1': { xOffset: -26, yOffset: -12 }, '2': { xOffset: -24, yOffset: -12 }, '3': { xOffset: -26, yOffset: -12 } };
      var defaultFrameOffsets4 = { '0': { xOffset: 10, yOffset: -12 }, '1': { xOffset: 10, yOffset: -12 }, '2': { xOffset: 10, yOffset: -12 }, '3': { xOffset: 10, yOffset: -12 } };
      stored.walk = stored.walk || {};
      stored.walk.frameOffsets = stored.walk.frameOffsets || walkDefaults;
      ['run', 'idle-attack', 'idle-bob', 'poses', 'spatula', 'overhead', 'hurt'].forEach(function(id) {
        stored[id] = stored[id] || {};
        stored[id].frameOffsets = stored[id].frameOffsets || defaultFrameOffsets4;
      });
      stored.flamethrower = stored.flamethrower || {};
      stored.flamethrower.frameOffsets = stored.flamethrower.frameOffsets || { '0': { xOffset: 40, yOffset: -88 }, '1': { xOffset: 40, yOffset: -88 }, '2': { xOffset: 40, yOffset: -88 } };
      chefTweakSaveStored(stored);
      var tweakMode = false;
      if (toggleBtn) {
        try {
          tweakMode = localStorage.getItem(CHEF_TWEAK_MODE_KEY) === '1';
        } catch (e) {}
        if (tweakMode) section.classList.add('chef-animations--tweak');
        toggleBtn.textContent = tweakMode ? 'Done tweaking' : 'Tweak position';
        toggleBtn.addEventListener('click', function() {
          tweakMode = !tweakMode;
          section.classList.toggle('chef-animations--tweak', tweakMode);
          toggleBtn.textContent = tweakMode ? 'Done tweaking' : 'Tweak position';
          try { localStorage.setItem(CHEF_TWEAK_MODE_KEY, tweakMode ? '1' : '0'); } catch (e) {}
        });
      }
      var resetBtn = document.getElementById('chef-reset-defaults');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          stored.walk = stored.walk || {};
          stored.walk.frameOffsets = walkDefaults;
          ['run', 'idle-attack', 'idle-bob', 'poses', 'spatula', 'overhead', 'hurt'].forEach(function(id) {
            stored[id] = stored[id] || {};
            stored[id].frameOffsets = defaultFrameOffsets4;
          });
          stored.flamethrower = stored.flamethrower || {};
          stored.flamethrower.frameOffsets = { '0': { xOffset: 40, yOffset: -88 }, '1': { xOffset: 40, yOffset: -88 }, '2': { xOffset: 40, yOffset: -88 } };
          chefTweakSaveStored(stored);
          items.forEach(function(item) {
            var id = item.getAttribute('data-chef-id');
            var frames = Math.max(1, parseInt(item.getAttribute('data-frames'), 10) || 1);
            var wrap = item.querySelector('.chef-anim-wrap');
            var tweakDiv = item.querySelector('.chef-anim-tweak');
            if (!wrap || !id) return;
            var data = stored[id] || {};
            chefTweakApplyToWrap(wrap, id, frames, data);
            var frameIndex = parseInt(wrap.style.getPropertyValue('--frame-index'), 10) || 0;
            var fo = data.frameOffsets && data.frameOffsets[String(frameIndex)];
            if (fo) {
              var xIn = tweakDiv && tweakDiv.querySelector('.chef-offset-x');
              var yIn = tweakDiv && tweakDiv.querySelector('.chef-offset-y');
              if (xIn) xIn.value = fo.xOffset != null ? fo.xOffset : 0;
              if (yIn) yIn.value = fo.yOffset != null ? fo.yOffset : (id === 'flamethrower' ? -88 : -12);
            }
          });
        });
      }
      section.addEventListener('click', function(e) {
        if (e.target.closest('.chef-anim-tweak')) return;
        var wrap = e.target.closest('.chef-anim-wrap');
        if (wrap) {
          var item = wrap.closest('.chef-animations__item');
          if (item) {
            var wasFocused = item.classList.contains('chef-animations__item--focused');
            section.querySelectorAll('.chef-animations__item').forEach(function(i) { i.classList.remove('chef-animations__item--focused'); });
            if (!wasFocused) item.classList.add('chef-animations__item--focused');
          }
          return;
        }
        var inSection = e.target.closest('.chef-animations__item');
        if (!inSection) section.querySelectorAll('.chef-animations__item').forEach(function(i) { i.classList.remove('chef-animations__item--focused'); });
      });
      var items = section.querySelectorAll('.chef-animations__item');
      items.forEach(function(item) {
        var id = item.getAttribute('data-chef-id');
        var frames = Math.max(1, parseInt(item.getAttribute('data-frames'), 10) || 1);
        var wrap = item.querySelector('.chef-anim-wrap');
        var tweakDiv = item.querySelector('.chef-anim-tweak');
        if (!wrap || !tweakDiv || !id) return;
        var data = stored[id] || {};
        chefTweakApplyToWrap(wrap, id, frames, data);
        var frameBtns = tweakDiv.querySelector('.frame-btns');
        if (frameBtns && frames > 1) {
          for (var f = 0; f < frames; f++) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn';
            btn.textContent = f;
            btn.dataset.frame = String(f);
            if (parseInt(data.frameIndex, 10) === f) btn.classList.add('btn-primary');
            frameBtns.appendChild(btn);
          }
        }
        var xInput = tweakDiv.querySelector('.chef-offset-x');
        var yInput = tweakDiv.querySelector('.chef-offset-y');
        var wInput = tweakDiv.querySelector('.chef-frame-width');
        function getFrameOffsets(frameIdx) {
          var fo = (stored[id] || {}).frameOffsets;
          if (fo && fo[String(frameIdx)] != null) return fo[String(frameIdx)];
          var d = stored[id] || {};
          return { xOffset: d.xOffset != null ? d.xOffset : 0, yOffset: d.yOffset != null ? d.yOffset : (id === 'flamethrower' ? -88 : -12) };
        }
        var curFrame = parseInt(data.frameIndex, 10) || 0;
        var curOff = getFrameOffsets(curFrame);
        if (xInput) xInput.value = (curOff.xOffset != null ? curOff.xOffset : 0);
        if (yInput) yInput.value = (curOff.yOffset != null ? curOff.yOffset : 0);
        if (wInput && data.frameWidth != null && data.frameWidth !== '') wInput.value = data.frameWidth;
        function save() {
          var next = { frameIndex: 0, xOffset: 0, yOffset: 0 };
          next.frameIndex = parseInt(wrap.style.getPropertyValue('--frame-index'), 10);
          if (isNaN(next.frameIndex)) next.frameIndex = 0;
          next.xOffset = xInput ? parseInt(xInput.value, 10) : 0;
          next.yOffset = yInput ? parseInt(yInput.value, 10) : 0;
          if (isNaN(next.xOffset)) next.xOffset = 0;
          if (isNaN(next.yOffset)) next.yOffset = 0;
          next.frameOffsets = (stored[id] && stored[id].frameOffsets) ? Object.assign({}, stored[id].frameOffsets) : {};
          next.frameOffsets[String(next.frameIndex)] = { xOffset: next.xOffset, yOffset: next.yOffset };
          if (wInput && wInput.value.trim() !== '') {
            next.frameWidth = parseInt(wInput.value, 10);
            if (isNaN(next.frameWidth)) delete next.frameWidth;
          }
          stored[id] = next;
          chefTweakSaveStored(stored);
        }
        function applyFromInputs() {
          var d = {
            frameIndex: parseInt(wrap.style.getPropertyValue('--frame-index'), 10) || 0,
            xOffset: xInput ? parseInt(xInput.value, 10) : 0,
            yOffset: yInput ? parseInt(yInput.value, 10) : 0,
            frameWidth: wInput && wInput.value.trim() !== '' ? parseInt(wInput.value, 10) : null
          };
          if (isNaN(d.xOffset)) d.xOffset = 0;
          if (isNaN(d.yOffset)) d.yOffset = 0;
          chefTweakApplyToWrap(wrap, id, frames, d);
          if (frameBtns) {
            frameBtns.querySelectorAll('button').forEach(function(b) {
              b.classList.toggle('btn-primary', parseInt(b.dataset.frame, 10) === d.frameIndex);
            });
          }
          save();
        }
        if (frameBtns) {
          frameBtns.querySelectorAll('button').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var f = parseInt(btn.dataset.frame, 10);
              wrap.style.setProperty('--frame-index', String(f));
              frameBtns.querySelectorAll('button').forEach(function(b) { b.classList.remove('btn-primary'); });
              btn.classList.add('btn-primary');
              var fo = getFrameOffsets(f);
              wrap.style.setProperty('--x-offset', (fo.xOffset != null ? fo.xOffset : 0) + 'px');
              wrap.style.setProperty('--y-offset', (fo.yOffset != null ? fo.yOffset : 0) + 'px');
              if (xInput) xInput.value = fo.xOffset != null ? fo.xOffset : 0;
              if (yInput) yInput.value = fo.yOffset != null ? fo.yOffset : 0;
              save();
            });
          });
        }
        if (frames > 1) {
          var alignBtn = document.createElement('button');
          alignBtn.type = 'button';
          alignBtn.className = 'btn chef-align-all-btn';
          alignBtn.textContent = 'Align all frames';
          alignBtn.title = 'Copy current frame\u2019s X and Y to every frame so they align the same';
          alignBtn.addEventListener('click', function() {
            var x = xInput ? parseInt(xInput.value, 10) : 0;
            var y = yInput ? parseInt(yInput.value, 10) : 0;
            if (isNaN(x)) x = 0;
            if (isNaN(y)) y = 0;
            stored[id] = stored[id] || {};
            stored[id].frameOffsets = {};
            for (var f = 0; f < frames; f++) stored[id].frameOffsets[String(f)] = { xOffset: x, yOffset: y };
            stored[id].frameIndex = parseInt(wrap.style.getPropertyValue('--frame-index'), 10) || 0;
            stored[id].xOffset = x;
            stored[id].yOffset = y;
            if (wInput && wInput.value.trim() !== '') stored[id].frameWidth = parseInt(wInput.value, 10);
            chefTweakApplyToWrap(wrap, id, frames, stored[id]);
            chefTweakSaveStored(stored);
          });
          tweakDiv.appendChild(alignBtn);
        }
        if (xInput) xInput.addEventListener('input', applyFromInputs);
        if (yInput) yInput.addEventListener('input', applyFromInputs);
        if (wInput) wInput.addEventListener('input', applyFromInputs);
      });
    }

    // Render cached initiatives immediately on page load (before API fetch)
    if (cachedInitiatives && cachedInitiatives.length > 0) {
      renderInitiativeCards(cachedInitiatives, null, true);
    }
    // Populate initial loading food track with all initiatives
    var initialFoodTrack = document.getElementById('loading-food-track');
    if (initialFoodTrack) {
      initialFoodTrack.innerHTML = buildLoadingFoodItems();
    }
    initLoadingGame();
    load();
    // Disabled: GitHub API rate limiting
    // loadEvents();
    // setInterval(loadEvents, EVENTS_POLL_MS);
    
    // Auto-refresh PR data with polling - DISABLED due to GitHub rate limiting
    var cachedPrData = {}; // repo#number -> { unresolved, checks }
    
    async function pollAndRefreshPRs() {
      try {
        var r = await fetch('/api/status');
        var data = await r.json();
        if (!data.initiatives) return;
        
        // Build list of all PRs and their current state
        for (var i = 0; i < data.initiatives.length; i++) {
          var init = data.initiatives[i];
          var prs = init.prs || [];
          for (var j = 0; j < prs.length; j++) {
            var pr = prs[j];
            var prKey = pr.repo + '#' + pr.number;
            var newState = {
              unresolved: pr.unresolved || 0,
              checks: JSON.stringify(pr.checks || {}),
              failingChecks: pr.failingChecks || 0
            };
            
            // Check if state changed
            var oldState = cachedPrData[prKey];
            if (oldState) {
              var changed = oldState.unresolved !== newState.unresolved ||
                            oldState.checks !== newState.checks ||
                            oldState.failingChecks !== newState.failingChecks;
              
              if (changed) {
                console.log('PR changed:', prKey, 'unresolved:', oldState.unresolved, '->', newState.unresolved);
                // Update the row with animation
                var row = document.querySelector('tr[data-repo="' + pr.repo + '"][data-number="' + pr.number + '"]');
                if (row) {
                  row.innerHTML = buildPrRowCells(pr);
                  if (typeof lucide !== 'undefined') lucide.createIcons();
                  
                  // Apply Mario coin bounce animation
                  var checkIcons = row.querySelectorAll('.check-icon');
                  checkIcons.forEach(function(icon) {
                    icon.classList.add('coin-bounce');
                    setTimeout(function() { icon.classList.remove('coin-bounce'); }, 600);
                  });
                  
                  var commentsEl = row.querySelector('.comments-unresolved');
                  if (commentsEl) {
                    commentsEl.classList.add('coin-bounce-comments');
                    setTimeout(function() { commentsEl.classList.remove('coin-bounce-comments'); }, 600);
                  }
                  
                  // Flash row background
                  row.style.transition = 'background-color 0.3s';
                  row.style.backgroundColor = 'rgba(255, 215, 0, 0.15)';
                  setTimeout(function() { row.style.backgroundColor = ''; }, 1500);
                  
                  if (hasConflicts(pr)) {
                    row.setAttribute('data-has-conflicts', 'true');
                  } else {
                    row.removeAttribute('data-has-conflicts');
                  }
                  
                  showToast('PR #' + pr.number + ' updated');
                }
              }
            }
            
            // Update cache
            cachedPrData[prKey] = newState;
          }
        }
      } catch (e) {
        console.error('Poll refresh error:', e);
      }
    }
    
    // Polling disabled due to GitHub rate limiting
    // Use manual refresh button or set up webhooks for real-time updates
    // setTimeout(function() {
    //   setInterval(pollAndRefreshPRs, PR_REFRESH_POLL_MS);
    // }, 5000);
    
    chefTweakInit();
    frameCoordsInit();
    // Initialize toast icon
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    // SSE: Real-time updates from GitHub webhooks
    var sseConnection = null;
    var sseReconnectTimeout = null;
    
    function connectSSE() {
      if (sseConnection) {
        sseConnection.close();
      }
      
      console.log('SSE: Connecting...');
      sseConnection = new EventSource('/api/sse');
      
      sseConnection.addEventListener('connected', function(e) {
        var data = JSON.parse(e.data);
        console.log('SSE: Connected with client ID', data.clientId);
        showToast('Live updates connected');
      });
      
      sseConnection.addEventListener('pr-update', function(e) {
        var data = JSON.parse(e.data);
        var pr = data.pr;
        console.log('SSE: PR update received', pr.repo, '#' + pr.number, 'unresolved:', pr.unresolved);
        
        // Find and update the row in the table
        var row = document.querySelector('tr[data-repo="' + pr.repo + '"][data-number="' + pr.number + '"]');
        if (row) {
          row.innerHTML = buildPrRowCells(pr);
          if (typeof lucide !== 'undefined') lucide.createIcons();
          
          // Apply Mario coin bounce animation to check icons
          var checkIcons = row.querySelectorAll('.check-icon');
          checkIcons.forEach(function(icon) {
            icon.classList.add('coin-bounce');
            setTimeout(function() {
              icon.classList.remove('coin-bounce');
            }, 600);
          });
          
          // Apply bounce to unresolved comments with special style
          var commentsEl = row.querySelector('.comments-unresolved');
          if (commentsEl) {
            commentsEl.classList.add('coin-bounce-comments');
            setTimeout(function() {
              commentsEl.classList.remove('coin-bounce-comments');
            }, 600);
          }
          
          // Flash the row background briefly
          row.style.transition = 'background-color 0.3s';
          row.style.backgroundColor = 'rgba(255, 215, 0, 0.15)';
          setTimeout(function() {
            row.style.backgroundColor = '';
          }, 1500);
          
          // Update conflicts attribute
          if (hasConflicts(pr)) {
            row.setAttribute('data-has-conflicts', 'true');
          } else {
            row.removeAttribute('data-has-conflicts');
          }
          
          showToast('PR #' + pr.number + ' updated');
        }
      });
      
      // Agent status updates
      sseConnection.addEventListener('agent-status', function(e) {
        var job = JSON.parse(e.data);
        console.log('[SSE Agent Status] Received update:', JSON.stringify(job));
        console.log('[SSE Agent Status] Job details - repo:', job.repo, 'number:', job.number, 'status:', job.status, 'type:', job.type);
        
        // Update the global agent jobs state
        if (job.status === 'cleared') {
          console.log('[SSE Agent Status] Clearing job from state:', job.id);
          delete agentJobs[job.id];
        } else {
          console.log('[SSE Agent Status] Updating job in state:', job.id);
          agentJobs[job.id] = job;
          if (typeof logStatusChange === 'function') logStatusChange(job);
          if (job.status === 'complete' || job.status === 'failed') {
          }
        }
        
        // Find and update the row in the table
        var row = document.querySelector('tr[data-repo="' + job.repo + '"][data-number="' + job.number + '"]');
        console.log('[SSE Agent Status] Found matching row:', !!row);
        // Update badge on the custom-cmd button
        updateAgentBadge(job.repo, job.number);
        
        if (row) {
          // Flash the row and show toast
          row.style.transition = 'background-color 0.3s';
          if (job.status === 'complete') {
            row.style.backgroundColor = 'rgba(16, 185, 129, 0.15)';
            showToast('Agent complete for PR #' + job.number + (job.summary ? ': ' + job.summary : ''));
          } else if (job.status === 'failed') {
            row.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
            showToast('Agent failed for PR #' + job.number);
          } else if (job.status === 'running') {
            row.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
            showToast('Agent started for PR #' + job.number);
          }
          setTimeout(function() {
            row.style.backgroundColor = '';
          }, 2000);
        }
      });
      
      // Initiative task updates
      sseConnection.addEventListener('initiative-task', function(e) {
        var task = JSON.parse(e.data);
        console.log('[SSE Initiative Task] Received:', task.id, task.status);
        if (task.status === 'cleared') {
          delete initiativeTasks[task.id];
        } else {
          initiativeTasks[task.id] = task;
          if (task.status === 'complete' || task.status === 'failed') {
          }
        }
        renderPrepWorkTable();
        
        // Show toast for status changes
        if (task.status === 'complete') {
          showToast('Task done: ' + (task.initiative || task.id));
        } else if (task.status === 'failed') {
          showToast('Task failed: ' + (task.initiative || task.id));
        } else if (task.status === 'running') {
          showToast('Agent started: ' + (task.initiative || task.id));
        }
      });

      // Agent log streaming
      sseConnection.addEventListener('agent-log', function(e) {
        var data = JSON.parse(e.data);
        appendAgentLog(data);
      });

      // Chat panel: agent session stream
      sseConnection.addEventListener('agent-stream', function(e) {
        var data = JSON.parse(e.data);
        var sessionId = data.sessionId;
        var msg = data.message;
        if (!sessionId || !msg) return;

        // Buffer the message
        if (!chatSessionMessages[sessionId]) chatSessionMessages[sessionId] = [];
        chatSessionMessages[sessionId].push(msg);

        // Capture cursorChatId from init message
        if (msg.type === 'system' && msg.subtype === 'init' && msg.raw && msg.raw.session_id) {
          if (chatSessionMeta[sessionId]) {
            chatSessionMeta[sessionId].cursorChatId = msg.raw.session_id;
          }
        }

        // If this session is currently displayed, render it
        if (chatActiveSessionId === sessionId) {
          appendChatMessage(msg);
        }
      });

      // Chat panel: agent session created
      sseConnection.addEventListener('agent-session-created', function(e) {
        var data = JSON.parse(e.data);
        if (!data.id) return;
        if (!chatSessionMeta[data.id]) {
          chatSessionMeta[data.id] = {
            repo: data.repo,
            number: data.number,
            status: data.status || 'running',
            label: data.label || data.id,
            startedAt: data.startedAt,
            cursorChatId: data.cursorChatId
          };
        } else {
          chatSessionMeta[data.id].status = data.status || 'running';
          if (data.cursorChatId) chatSessionMeta[data.id].cursorChatId = data.cursorChatId;
        }
        if (!chatSessionMessages[data.id]) chatSessionMessages[data.id] = [];
        renderSidebar();
        // Update chat badge on PR row
        if (data.repo && data.number) {
          updateChatBadge(data.repo, data.number, 'running');
        }
      });

      // Chat panel: agent session complete
      sseConnection.addEventListener('agent-complete', function(e) {
        var data = JSON.parse(e.data);
        var sessionId = data.sessionId;
        if (!sessionId) return;

        var meta = chatSessionMeta[sessionId];
        if (meta) {
          meta.status = data.status || 'complete';
          meta.completedAt = Date.now();
        }

        // Update UI if this session is displayed
        if (chatActiveSessionId === sessionId) {
          updateChatPanelStatusBadge(data.status || 'complete');
          chatPanelCancel.style.display = 'none';
          chatPanelInputArea.classList.add('visible');
          // Remove typing cursor from any active assistant element
          if (chatAssistantEl) {
            chatAssistantEl.classList.remove('typing-cursor');
            chatAssistantEl = null;
          }
        }

        renderSidebar();

        // Update chat badge on PR row
        if (meta && meta.repo && meta.number) {
          updateChatBadge(meta.repo, meta.number, data.status || 'complete');
        }
      });

      sseConnection.addEventListener('ping', function(e) {
        // Keep-alive ping, no action needed
      });
      
      sseConnection.onerror = function(e) {
        console.log('SSE: Connection error, reconnecting in 5s...');
        sseConnection.close();
        if (sseReconnectTimeout) clearTimeout(sseReconnectTimeout);
        sseReconnectTimeout = setTimeout(connectSSE, 5000);
      };
    }
    
    // Agent Log Panel
    var logPanel = document.getElementById('agent-log-panel');
    var logBody = document.getElementById('agent-log-body');
    var logToggle = document.getElementById('agent-log-toggle');
    var logPanelOpen = false;

    document.getElementById('agent-log-toggle').addEventListener('click', function() {
      logPanelOpen = !logPanelOpen;
      logPanel.classList.toggle('open', logPanelOpen);
      logToggle.classList.remove('has-activity');
    });
    document.getElementById('agent-log-close').addEventListener('click', function() {
      logPanelOpen = false;
      logPanel.classList.remove('open');
    });
    document.getElementById('agent-log-clear').addEventListener('click', function() {
      logBody.innerHTML = '';
    });

    function appendLog(html) {
      logBody.insertAdjacentHTML('beforeend', html);
      logBody.scrollTop = logBody.scrollHeight;
      if (!logPanelOpen) {
        logToggle.classList.add('has-activity');
      }
    }

    function appendAgentLog(data) {
      var cls = 'agent-log-entry agent-log-entry--' + (data.stream || 'stdout');
      var text = (data.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      if (data.done) {
        var exitCls = data.text && data.text.includes('code 0') ? '' : ' failed';
        appendLog('<div class="agent-log-entry agent-log-entry--status' + exitCls + '">' + text + '</div><hr class="agent-log-divider">');
      } else {
        appendLog('<div class="' + cls + '">' + text + '</div>');
      }
    }

    // Also log dispatch and status changes
    function logStatusChange(job) {
      var label = job.repo ? job.repo + '#' + job.number : job.id || 'task';
      var text = label + ' → ' + job.status;
      if (job.summary) text += ': ' + job.summary;
      if (job.error) text += ' (' + job.error + ')';
      var cls = (job.status === 'failed') ? ' failed' : '';
      appendLog('<div class="agent-log-entry agent-log-entry--status' + cls + '">' + text.replace(/</g, '&lt;') + '</div>');
    }

    // Start SSE connection
    connectSSE();
  </script>
</body>
</html>
